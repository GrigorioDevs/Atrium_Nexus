<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<!-- Viewport corrigido: reduz leve zoom inicial e corrige atributo maximum-scale -->
<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>RCR Engenharia — RH (Ponto, Documentos & Assinaturas)</title>

<!-- Ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<!-- Leaflet (mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- jsPDF (PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- PDF.js (leitura de PDFs para texto) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script>
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js';
  }
</script>

<!-- Signature Pad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<style>
:root{
  --nav-width: 240px;
  --c1: #00E0FF;
  --c2: #FF2FB9;
  --pink: #F774D1;
  --pink-2:#ECB8DD;
  --bg:#0B1622;
  --panel:#0F1E2C;
  --white:#fff;
  --text:#E7EEF6;
  --muted:#9fb1c3;
  --ok:#10b981;
  --warn:#f59e0b;
  --err:#ef4444;
  --ui:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;

  --scroll-thumb: rgba(0,224,255,.45);
  --scroll-thumb-hover: rgba(255,47,185,.60);
  --scroll-track: rgba(255,255,255,.08);
}

*{box-sizing:border-box;margin:0;padding:0}

/* Scrollbar */
*{ scrollbar-color: var(--scroll-thumb) var(--scroll-track); scrollbar-width: thin; }
*::-webkit-scrollbar{ width:10px; height:10px }
*::-webkit-scrollbar-track{ background: var(--scroll-track); border-radius: 10px; }
*::-webkit-scrollbar-thumb{
  background: linear-gradient(135deg, var(--c1), var(--c2));
  background-clip: padding-box; border:2px solid transparent; border-radius: 10px; opacity:.9;
}
*::-webkit-scrollbar-thumb:hover{ background: linear-gradient(135deg, var(--scroll-thumb), var(--scroll-thumb-hover)); border-color: transparent; }

html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--ui)}
a{color:inherit;text-decoration:none}
.container{display:flex;min-height:100vh}

/* Sidebar */
aside{
  position:fixed;top:0;left:0;height:100%;width:var(--nav-width);
  background: linear-gradient(160deg, rgba(0,224,255,.14), rgba(255,47,185,.12)), #0A111A;
  border-right: 1px solid rgba(255,255,255,.06);
  color:#fff;z-index:1000;padding:18px 14px 18px;
  display:flex;flex-direction:column;gap:14px;transition:left .25s ease;
}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.brand-logo{
  width:38px;height:38px;border-radius:9px;object-fit:cover;flex:0 0 auto;
  background: radial-gradient(80% 80% at 20% 20%, var(--c1), transparent),
              radial-gradient(80% 80% at 80% 80%, var(--c2), transparent);
  border:1px solid rgba(255,255,255,.18);
}
.brand strong{font-weight:800;letter-spacing:.4px}
.user-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
.user-card .name{font-weight:700}
.user-card .role{font-size:12px;opacity:.85}
.menu{list-style:none}
.menu li{
  display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:10px;cursor:pointer;
  font-weight:600;color:#e8f0f7;transition: background .15s ease, transform .12s ease;
}
.menu li:hover{background:rgba(255,255,255,.08)}
.menu li.active{background:linear-gradient(90deg, rgba(0,224,255,.25), rgba(255,47,185,.25));color:#fff}
.menu li i{width:20px;text-align:center}

/* Submenu */
.menu li.has-submenu{flex-direction:column; align-items:stretch; position:relative;}
.menu li.has-submenu .row-head{display:flex; align-items:center; gap:10px;}
.menu li.has-submenu .caret{margin-left:auto; transition:transform .2s ease;}
.menu li.has-submenu.open .caret{transform:rotate(180deg)}
.menu li .submenu{ display:none; list-style:none; margin-top:6px; padding-left:28px; border-left:1px dashed rgba(255,255,255,.18); }
.menu li.open > .submenu{display:block}
.menu li .submenu li{padding:8px 10px;border-radius:8px;margin:4px 0}
.menu li .submenu li.active,
.menu li .submenu li:hover{background:rgba(255,255,255,.08)}

/* Footer (mobile) */
.sidebar-mobile-footer{display:none}
@media (max-width:960px){
  .sidebar-mobile-footer{ margin-top:auto; position:sticky; bottom:0; background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.25)) , rgba(255,255,255,.04); border-top:1px solid rgba(255,255,255,.08); padding:12px 6px 6px; display:block; }
  .sidebar-mobile-footer .btn{width:100%}
}

/* Hamburger */
.menu-toggle{
  display:none;position:fixed;top:12px;left:12px;
  background:linear-gradient(135deg, var(--c1), var(--c2));
  color:#00121E;padding:8px 10px;border-radius:10px;z-index:1100;cursor:pointer;
  box-shadow:0 10px 26px rgba(0,0,0,.24);
  border:1px solid rgba(255,255,255,.25);
  font-weight:800; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}
.menu-toggle:active{transform:scale(.98)}
.menu-toggle:hover{box-shadow:0 8px 22px rgba(0,0,0,.26)}
@media (max-width:960px){ .sidebar-open .menu-toggle{display:none} }

/* Main */
main{flex:1;margin-left:var(--nav-width);padding:18px 18px 30px;transition:margin-left .25s ease}

/* Topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.hello{font-weight:800;letter-spacing:.2px}
.right{display:flex;align-items:center;gap:10px}
.badge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:6px 10px;font-size:13px}

/* Tabs & Cards */
.tab{display:none}
.tab.active{display:block}
.card{background:var(--panel);border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.08)}
.card-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:800}
.card-body{padding:14px 16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:380px; min-height:0px}
.section-flat .card-header{display:flex;align-items:center;justify-content:space-between}
.inline-row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
.mt-8{margin-top:8px}
.kv-strong{font-weight:800}

/* Inputs */
label{font-weight:700;font-size:13px;margin:6px 0 6px;display:block}
input[type="text"],input[type="date"],input[type="time"],input[type="number"],select,textarea{
  width:100%;padding:10px 12px;border:1px solid rgba(0,224,255,.20);
  border-radius:10px;background:#0a1520;color:var(--text);font-size:14px;
  outline:none; appearance:none; -webkit-appearance:none; caret-color: var(--c1);
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
input[type="checkbox"], input[type="radio"]{ accent-color: var(--c1); }
input:focus, select:focus, textarea:focus{
  border-color: rgba(0,224,255,.45);
  box-shadow: 0 0 0 3px rgba(0,224,255,.15), inset 0 0 0 1px rgba(255,255,255,.06);
  background:#0b1a27;
}
::placeholder{ color:#93a7ba; opacity:.9 }
textarea{min-height:110px;resize:vertical}
.scroll-styled{ overflow:auto; -webkit-overflow-scrolling: touch; overscroll-behavior:auto; }

/* Buttons */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:800;
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}
.btn:active{transform:scale(.98)}
.btn-primary{background:linear-gradient(135deg, var(--c1), var(--c2)); color:#00121E;border:1px solid rgba(255,255,255,.25)}
.btn-primary:hover{filter:brightness(1.08)}
.btn-light{background:#0a1520;color:#d6e6f3;border:1px solid rgba(255,255,255,.18)}
.btn-ok{background:#0bbf7a;color:#00121E}
.btn-warn{background:#f59e0b;color:#1a0b00}
.btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,.35);color:#cfe0ef}

/* File inputs */
#docUpload, #fotoUpload, #cadDocumento, #sigImport, #tplImport, #cadFoto, #genDocFile{
  width:100%; padding:10px 12px; border:1px solid rgba(0,224,255,.20);
  border-radius:10px; background:#0a1520; color:var(--text); font-size:14px; outline:none; transition:0.3s;
}
#docUpload:focus, #fotoUpload:focus, #cadDocumento:focus, #sigImport:focus, #tplImport:focus, #cadFoto:focus, #genDocFile:focus{ border-color: rgba(0,224,255,.45); }
#docUpload::file-selector-button, #fotoUpload::file-selector-button, #cadDocumento::file-selector-button, #sigImport::file-selector-button, #tplImport::file-selector-button, #cadFoto::file-selector-button, #genDocFile::file-selector-button{
  margin-right:10px; padding:8px 12px; border:1px solid rgba(255,255,255,.25);
  border-radius:8px; background:linear-gradient(135deg, var(--c1), var(--c2));
  color:#00121E; font-weight:800; cursor:pointer; transition:filter .15s ease, transform .15s ease;
}

/* Tabela */
.table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:center}
.table th{background:linear-gradient(90deg, rgba(0,224,255,.22), rgba(255,47,185,.22));color:#eaf6ff}
.table .btn{padding:6px 10px;border-radius:8px}

/* KPIs/Filtros/ajudas */
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.filters .chip{padding:8px 12px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:#0a1520;font-weight:700}
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.kpi{flex:1;min-width:160px;background:#0a1520;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:14px}
.kpi .title{font-size:12px;color:var(--muted)}
.kpi .value{font-size:20px;font-weight:800}
.muted-hint{font-size:12px;color:var(--muted);margin-top:6px}

/* Status */
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:1200;padding:12px}
.modal .modal-content{background:var(--panel);border-radius:14px;border:1px solid rgba(255,255,255,.08);box-shadow:0 12px 40px rgba(0,0,0,.5);width:95%;max-width:860px;overflow:hidden}
.modal .modal-header{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:800}
.modal .modal-body{padding:14px 16px}
.modal .modal-footer{padding:12px 14px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:8px;justify-content:flex-end}

/* Assinatura */
.sig-wrap{border:1px dashed rgba(255,255,255,.22);border-radius:12px;overflow:hidden;background:#0a1520}
.sig-wrap canvas{width:100%;height:240px;display:block}
.sig-toolbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}

/* Mapa */
#map{width:100%;height:380px;border-radius:12px;border:1px solid rgba(255,255,255,.12);position:relative}
.map-skeleton{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:800; color:#eaf6ff; background: linear-gradient(135deg,#0E1B2A,#091521); animation: mapPulse 1.1s ease-in-out infinite alternate; z-index:1;}
@keyframes mapPulse{from{opacity:.85} to{opacity:.55}}
.leaflet-control-container{z-index:900}
@media (max-width:960px){
  .leaflet-top.leaflet-left{left:auto; right:8px; top:70px}
}

/* Funcionários */
.emp-tools{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.emp-tools input{max-width:360px}
.emp-tools.centered{justify-content:center}
.emp-tools.centered input{min-width:240px;max-width:480px}
.emp-tools .search-group{display:flex;gap:8px;align-items:center}

.emp-grid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px}
@media (max-width:1100px){ .emp-grid{grid-template-columns:repeat(2,minmax(220px,1fr))} }
@media (max-width:640px){ .emp-grid{grid-template-columns:1fr} }
.emp-card{position:relative;background:#0a1520;border:1px solid rgba(255,255,255,.08);border-radius:14px;display:flex;gap:12px;padding:12px;align-items:center;cursor:pointer}
.emp-card:hover{outline:1px dashed rgba(255,255,255,.18)}
.emp-card.inactive{opacity:.55; filter:grayscale(.8);}
.emp-avatar{
  width:64px;height:64px;border-radius:14px;object-fit:cover;
  background:radial-gradient(80% 80% at 20% 20%, var(--c1), transparent),
             radial-gradient(80% 80% at 80% 80%, var(--c2), transparent);
  border:1px solid rgba(255,255,255,.2)
}
.emp-name{font-weight:800}
.emp-role{color:var(--muted);font-size:13px}

/* Selo INATIVO */
.emp-badge-off{position:absolute; top:8px; left:8px; background:linear-gradient(135deg, rgba(239,68,68,.18), transparent); border:1px solid rgba(239,68,68,.5); color:#fee2e2; font-weight:800; padding:4px 8px; border-radius:8px; font-size:11px;}

/* NOVO: botão 3 pontinhos + menu dentro do card */
.emp-menu{
  position:absolute; top:6px; right:6px; width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  border-radius:10px; border:1px solid rgba(255,255,255,.25);
  background:#0a1520; color:#d6e6f3; cursor:pointer;
}
.emp-menu:hover{ filter:brightness(1.1) }
.emp-menu .fa-ellipsis-vertical{font-size:16px}
.emp-menu-dropdown{
  position:absolute; top:42px; right:6px; background:#0a1520; border:1px solid rgba(255,255,255,.18);
  border-radius:10px; box-shadow:0 10px 26px rgba(0,0,0,.35); display:none; min-width:160px; z-index:5;
  overflow:hidden;
}
.emp-menu-dropdown.open{ display:block; }
.emp-menu-dropdown button{
  width:100%; text-align:left; padding:10px 12px; background:transparent; border:none; color:#e7eef6; cursor:pointer;
}
.emp-menu-dropdown button:hover{ background:rgba(255,255,255,.08) }
.emp-menu-dropdown .danger{ color:#ffd3d3; }

/* Splash */
#splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#0B1622; z-index:2000; transition:opacity .4s ease;}
#splash.hide{opacity:0; pointer-events:none}
.splash-card{display:flex;flex-direction:column;align-items:center;gap:10px}
.splash-logo{width:120px;height:120px;border-radius:24px;object-fit:cover;border:1px solid rgba(255,255,255,.25);background: radial-gradient(80% 80% at 20% 20%, var(--c1), transparent), radial-gradient(80% 80% at 80% 80%, var(--c2), transparent);}
.splash-title{font-weight:900;letter-spacing:.4px;color:#E7EEF6}

/* Responsivo */
@media (max-width:960px){
  .menu-toggle{display:block}
  aside{left:calc(-1 * var(--nav-width))}
  aside.active{left:0}
  main{margin-left:0;padding-top:56px}
  .col{ min-width: min(100%, 520px); }
  .scroll-styled{ max-height:55vh; }
}
@media (max-width:640px){ .col{ min-width:100%; } }

/* Tabela Ponto em iPhone 14 */
.table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
@media (max-width:430px){
  #tPonto{ font-size:12px; }
  .table th,.table td{ padding:6px 4px; }
  .table.fit-mobile{ transform-origin: top left; }
}

/* Telas públicas de assinatura */
.public-sign{ position:fixed; inset:0; background:var(--bg); color:var(--text); z-index:2200; overflow:auto; display:none; }
.public-sign .wrap{ max-width:920px; margin:16px auto; padding:12px; }
.public-sign .card{ margin:0 auto; }
.public-sign .doc-box{
  padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
  background:#0a1520; white-space:pre-wrap; line-height:1.35;
}

/* Modal Funcionário — layout */
#modalFuncionario .emp-modal-header{ display:flex; align-items:center; gap:14px; margin-bottom:12px; }
#modalFuncionario .emp-avatar{ width:72px; height:72px; border-radius:16px; }
#modalFuncionario .emp-name{ font-size:22px; font-weight:900; line-height:1.1; }
#modalFuncionario .emp-role{ font-size:15px; font-weight:700; color:#d6e6f3; opacity:0.95; }
#modalFuncionario .emp-tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px; }
#modalFuncionario .emp-tab-btn.active{ outline:2px solid rgba(0,224,255,.35); }

/* Panes */
.emp-pane{ display:none; }
.emp-pane.active{ display:block; }

/* Cadastro modal refinado */
#modalCadastroUsuario .modal-content{max-width:860px}
#modalCadastroUsuario .modal-body{
  max-height: calc(100vh - 160px);
  overflow:auto; overscroll-behavior:contain; -webkit-overflow-scrolling:touch;
}
#modalCadastroUsuario .gestao-cadastro .card{background:transparent;border:none;box-shadow:none}
#modalCadastroUsuario .gestao-cadastro .card-header{display:none}
#modalCadastroUsuario .gestao-cadastro .card-body{padding:0}
@media (max-width:960px){
  #modalCadastroUsuario .modal-content{width:100%;height:100%;max-width:none;border-radius:0}
  #modalCadastroUsuario .modal-body{max-height: calc(100vh - 110px)}
  #modalCadastroUsuario .gestao-cadastro .col{min-width:100%!important}
}

/* Esconder cargo no form (mantido no HTML) */
#wrapCargoField{display:none !important}

/* Switches VR/VT */
.benefit-toggles{display:flex;gap:16px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
.benefit-toggles label{display:inline-flex;align-items:center;gap:10px;font-weight:800}
#cadOptVR,#cadOptVT{
  appearance:none; width:46px; height:26px; border-radius:999px;
  background:#132433; border:1px solid rgba(0,224,255,.22);
  position:relative; cursor:pointer; transition:.18s ease;
}
#cadOptVR::after,#cadOptVT::after{
  content:''; position:absolute; top:3px; left:3px; width:20px; height:20px;
  border-radius:50%; background:linear-gradient(135deg, var(--c1), var(--c2));
  transform:translateX(0); transition:transform .18s ease;
}
#cadOptVR:checked,#cadOptVT:checked{background:rgba(0,224,255,.25);border-color:rgba(0,224,255,.45)}
#cadOptVR:checked::after,#cadOptVT:checked::after{transform:translateX(20px)}

/* Benefícios: pequenos helpers */
.vt-help,.vr-help{font-size:12px;color:var(--muted)}
.vt-on{filter:none;opacity:1}
.vt-off{filter:grayscale(.85);opacity:.55}
.vt-cell-left{text-align:left}
.t-right{text-align:right}
.t-center{text-align:center}
.vr-cell-left{text-align:left}
.vr-meta{font-size:12px;color:var(--muted)}
.vr-money{font-weight:800}
.export-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }

/* Doc layout grid */
.doc-tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.doc-layout{display:grid;grid-template-columns:repeat(3,minmax(200px,1fr));gap:10px}
@media (max-width:960px){ .doc-layout{grid-template-columns:1fr} }
.doc-layout .field{display:flex;flex-direction:column}
.doc-layout .field small{font-size:12px;color:var(--muted)}

/* Alertas (sino topo) */
.right .icon-btn{
  position:relative; padding:8px 10px; border:1px solid rgba(255,255,255,.18);
  background:#0a1520; color:#d6e6f3; border-radius:10px;
}
.notif-dot{ position:absolute; top:4px; right:4px; width:8px; height:8px; border-radius:50%; background:var(--warn); }
.notif-dot[hidden]{ display:none }

/* Documentos importantes (form) */
.imp-docs-form{ display:grid; grid-template-columns: 1.2fr 1fr 1fr 1fr auto; gap:10px; align-items:end; margin-bottom:10px; }
@media (max-width:960px){ .imp-docs-form{ grid-template-columns:1fr } }

/* Esconder “Alterar foto” legado (se existir) */
#modalFuncionario #btnTabFoto, #modalFuncionario #paneFoto { display:none !important; }

/* Toasts */
.toast-container{position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:8px; z-index:3000;}
.toast{min-width:240px; max-width:380px; padding:12px 14px; border-radius:12px; background:var(--panel); border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 30px rgba(0,0,0,.4); display:flex; align-items:center; gap:10px; opacity:0; transform:translateY(10px); transition:.2s ease;}
.toast.show{opacity:1; transform:translateY(0)}
.toast .msg{line-height:1.35}
.toast .close{margin-left:auto; cursor:pointer; opacity:.7}
.toast.success{ border-color: rgba(16,185,129,.5); background:linear-gradient(135deg, rgba(16,185,129,.18), transparent), var(--panel) }
.toast.error{   border-color: rgba(239,68,68,.5);  background:linear-gradient(135deg, rgba(239,68,68,.18),  transparent), var(--panel) }
.toast.warn{    border-color: rgba(245,158,11,.5); background:linear-gradient(135deg, rgba(245,158,11,.18), transparent), var(--panel) }
.toast.info{    border-color: rgba(0,224,255,.5); background:linear-gradient(135deg, rgba(0,224,255,.18), transparent), var(--panel) }

/* Pequenos utilitários extras */
.hint-row{margin-top:8px}
.gestao-cadastro-wrap{display:none !important;} /* o cadastro abre em modal */
.gestao-actions-left{display:flex;justify-content:flex-start;align-items:center;margin:8px 0 12px}

</style>
</head>
<body>

<!-- Splash -->
  <div id="splash">
    <div class="splash-card">
      <img class="splash-logo" src="Assets/img/logo_new.png" alt="RCR" onerror="this.style.display='none'">
      <div class="splash-title">RCR Engenharia</div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <button class="menu-toggle" id="btnHamb"><i class="fa fa-bars"></i></button>

  <div class="container">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="brand">
        <img class="brand-logo" src="Assets/img/logo_new.png" alt="RCR" onerror="this.remove()">
        <strong>RCR Engenharia</strong>
      </div>

      <div class="user-card">
        <div class="name" id="uNome">Colaborador(a)</div>
        <div class="role" id="uFuncao">Função</div>
      </div>

      <ul class="menu" id="menu">
        <li data-tab="tabPonto" class="active"><i class="fa-regular fa-calendar-days"></i> Cartão de Ponto</li>
        <li data-tab="tabIncluir"><i class="fa-solid fa-location-dot"></i> Incluir Ponto</li>
        <li data-tab="tabDocs"><i class="fa-regular fa-file-lines"></i> Documentos & Assinaturas</li>

        <!-- Funcionários com SUBMENU -->
        <li data-tab="tabFuncionarios" class="has-submenu menu-func-root">
          <div class="row-head">
            <i class="fa-solid fa-users"></i> Funcionários
            <i class="fa-solid fa-caret-down caret"></i>
          </div>
          <ul class="submenu" id="submenuFuncionarios">
            <li data-tab="tabFuncGestao"><i class="fa-solid fa-clipboard-user"></i> Gestão de Funcionários</li>
            <li data-tab="tabFuncionarios"><i class="fa-solid fa-user-gear"></i> Gerenciar Funcionários</li>
          </ul>
        </li>

        <!-- Benefícios (submenu) -->
        <li class="has-submenu menu-benef-root">
          <div class="row-head">
            <i class="fa-solid fa-hand-holding-heart"></i> Benefícios
            <i class="fa-solid fa-caret-down caret"></i>
          </div>
          <ul class="submenu" id="submenuBeneficios">
            <li data-tab="tabVT"><i class="fa-solid fa-bus"></i> Vale Transporte</li>
            <li data-tab="tabVR"><i class="fa-solid fa-utensils"></i> Vale Refeição</li>
          </ul>
        </li>

        <li data-tab="tabConfig"><i class="fa-solid fa-gear"></i> Configurações</li>
      </ul>

      <div class="sidebar-mobile-footer">
        <button class="btn btn-light" id="btnCloseSidebar"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
      </div>
    </aside>

    <!-- Main -->
    <main>
      <div class="topbar">
        <div class="hello">Olá, <span id="helloNome">Colaborador(a)</span></div>
        <div class="right">
          <span class="badge"><i class="fa-regular fa-clock"></i> <span id="nowClock">--:--:--</span></span>
          <button class="btn btn-light icon-btn" id="btnAlerts" title="Lembretes">
            <i class="fa-regular fa-bell"></i>
            <span class="notif-dot" id="notifDot" hidden></span>
          </button>
        </div>
      </div>

      <!-- Cartão de Ponto -->
      <section id="tabPonto" class="tab active">
        <div class="card">
          <div class="card-header">Filtrar</div>
          <div class="card-body">
            <div class="filters">
              <div class="chip"><label>Início</label><input type="date" id="pInicio"/></div>
              <div class="chip"><label>Fim</label><input type="date" id="pFim"/></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-primary" id="btnAplicarFiltro"><i class="fa fa-filter"></i> Aplicar</button></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-light" id="btnPeriodoAtual"><i class="fa-regular fa-calendar"></i> 15 dias</button></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-primary" id="btnExportPonto"><i class="fa-regular fa-file-pdf"></i> Exportar PDF</button></div>
            </div>

            <div class="kpis">
              <div class="kpi"><div class="title">Horas no período</div><div class="value" id="kHoras">00:00</div></div>
              <div class="kpi"><div class="title">Saldo</div><div class="value" id="kSaldo">00:00</div></div>
              <div class="kpi"><div class="title">Dias com pendência</div><div class="value" id="kPend">0</div></div>
            </div>

            <div class="table-wrap">
              <table class="table" id="tPonto">
                <thead>
                  <tr>
                    <th>Status</th><th>Data</th>
                    <th>Entrada 1</th><th>Saída 1</th>
                    <th>Entrada 2</th><th>Saída 2</th>
                    <th>Entrada 3</th><th>Saída 3</th>
                    <th>Saldo</th>
                  </tr>
                </thead>
                <tbody><!-- via JS --></tbody>
              </table>
              <div class="muted-hint">Dica: clique em uma linha para ver <b>todos</b> os batimentos daquele dia.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Incluir Ponto -->
      <section id="tabIncluir" class="tab">
        <div class="card">
          <div class="card-header">Incluir Ponto (geolocalização)</div>
          <div class="card-body">
            <div id="map"><div class="map-skeleton">Carregando mapa…</div></div>

            <div class="inline-row">
              <div class="chip"><label>Data/Hora atual</label><div id="lblAgora" class="kv-strong">--/--/---- --:--:--</div></div>
              <div class="chip"><label>Coordenadas</label><div id="lblCoord" class="kv-strong">--</div></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-ok" id="btnBaterPonto"><i class="fa-regular fa-circle-dot"></i> Incluir Ponto</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Documentos & Assinaturas -->
      <section id="tabDocs" class="tab">
        <div class="card">
          <div class="card-header">Gerar & Assinar Documentos</div>
          <div class="card-body">

            <div class="row" style="align-items:flex-end">
              <div class="col" style="max-width:320px">
                <label>Importar documento/modelo</label>
                <input type="file" id="tplImport" accept=".json,.txt,.md,.pdf" multiple>
              </div>

              <div class="col">
                <label>Tipo de documento</label>
                <select id="docTipo">
                  <option value="interesse">Declaração de Interesse</option>
                  <option value="anuencia">Carta de Anuência</option>
                  <option value="dividas">Declaração de Ausência de Dívidas</option>
                  <optgroup id="docCustomGroup" label="— Personalizados —"></optgroup>
                </select>
              </div>

              <div class="col" style="max-width:240px">
                <label style="visibility:hidden">.</label>
                <button class="btn btn-light" id="btnCriarTipoDoc">
                  <i class="fa-solid fa-plus"></i> Criar tipo de documento
                </button>
              </div>
            </div>

            <!-- Gerenciar tipos personalizados -->
            <div class="row" id="tplManageRow">
              <div class="col" style="max-width:520px">
                <label>Excluir tipo de documento (personalizado)</label>
                <div class="inline-row">
                  <select id="tplManageSelect" style="min-width:280px">
                    <option value="">— Selecione um tipo personalizado —</option>
                  </select>
                  <button class="btn btn-ghost" id="btnExcluirTipoDoc">
                    <i class="fa-solid fa-trash"></i> Excluir tipo
                  </button>
                </div>
                <div class="filehint">Apenas tipos criados/importados podem ser excluídos.</div>
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Nome do colaborador</label>
                <input type="text" id="docNome" placeholder="Nome completo">
              </div>
              <div class="col">
                <label>Documento (CPF/RG)</label>
                <input type="text" id="docDoc" placeholder="000.000.000-00">
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Conteúdo (pode editar antes de assinar)</label>
                <textarea id="docTexto" class="scroll-styled" spellcheck="false"></textarea>
              </div>
              <div class="col">
                <label>Assinatura do colaborador</label>

                <input type="file" id="sigImport" accept="image/*" />
                <div class="filehint">Importe uma imagem da assinatura (.png/.jpg). Ela será colocada no quadro abaixo.</div>

                <div class="sig-toolbar">
                  <button class="btn btn-light" id="btnLimparAss">Limpar</button>
                  <button class="btn btn-primary" id="btnGerarPDF"><i class="fa-regular fa-file-pdf"></i> Gerar PDF assinado</button>
                </div>
                <div class="sig-wrap"><canvas id="sigPad"></canvas></div>
                <div class="muted-hint">Assine usando o mouse (desktop) ou o dedo/caneta (mobile) — ou importe uma imagem.</div>
              </div>
            </div>

            <!-- Layout do documento -->
            <div class="card section-flat">
              <div class="card-header">Layout (cabeçalho e rodapé)</div>
              <div class="card-body">
                <div class="doc-layout">
                  <div class="field">
                    <label>Título do cabeçalho</label>
                    <input type="text" id="docHeaderTitle" placeholder="Ex.: Declaração • RCR Engenharia">
                    <small>Será exibido no topo de cada página.</small>
                  </div>
                  <div class="field">
                    <label>Alinhamento do cabeçalho</label>
                    <select id="docHeaderAlign">
                      <option value="left">Esquerda</option>
                      <option value="center">Centralizado</option>
                      <option value="right">Direita</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Rodapé</label>
                    <input type="text" id="docFooterText" placeholder="Ex.: Confidencial • Uso interno">
                    <small>Mostrado no rodapé de cada página.</small>
                  </div>
                  <div class="field">
                    <label>Numeração</label>
                    <select id="docPageNums">
                      <option value="none">Sem numeração</option>
                      <option value="p_de_n">pág. X de Y</option>
                      <option value="p_simples">pág. X</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Logo no cabeçalho</label>
                    <select id="docHeaderLogo">
                      <option value="auto">Automático</option>
                      <option value="off">Sem logo</option>
                    </select>
                    <small>Usa a logo atual quando disponível.</small>
                  </div>
                </div>
                <div class="hint-row">
                  <button class="btn btn-ghost" id="btnSalvarLayoutDoc">
                    <i class="fa-regular fa-floppy-disk"></i> Salvar layout como padrão
                  </button>
                </div>
              </div>
            </div>

            <!-- Ferramentas de formatação -->
            <div class="doc-tools">
              <button class="btn btn-primary" id="btnFormatarIA">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Formatar com IA (beta)
              </button>
              <button class="btn btn-light" id="btnFormatarBasico">
                <i class="fa-regular fa-magic"></i> Formatar básico
              </button>
            </div>

            <!-- Assinatura via link público -->
            <div class="row" style="margin-top:14px">
              <div class="col">
                <label>Assinatura via link público</label>
                <div class="inline-row">
                  <button class="btn btn-primary" id="btnGerarLinkAss">
                    <i class="fa-solid fa-link"></i> Gerar link de assinatura
                  </button>
                  <input type="text" id="assLink" class="scroll-styled" readonly
                        placeholder="Clique em “Gerar link” para criar a URL…"
                        style="flex:1;min-width:280px">
                  <button class="btn btn-light" id="btnCopiarLinkAss">
                    <i class="fa-regular fa-copy"></i> Copiar link
                  </button>
                </div>
                <div class="filehint">Envie este link para o colaborador assinar em uma tela simplificada, sem acessar o sistema.</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- GESTÃO DE FUNCIONÁRIOS -->
      <section id="tabFuncGestao" class="tab">
        <div class="card">
          <div class="card-header">Gestão de Funcionários</div>
          <div class="card-body">

            <!-- (Bloco de cadastro é aberto em modal) -->
            <div class="gestao-cadastro-wrap">
              <div class="gestao-cadastro">
                <div class="card flat">
                  <div class="card-header">Cadastro de Funcionários</div>
                  <div class="card-body">
                    <!-- FOTO -->
                    <div class="row">
                      <div class="col" style="max-width:320px">
                        <label>Foto do funcionário</label>
                        <input type="file" id="cadFoto" accept="image/*">
                      </div>
                      <div class="col" style="display:flex;align-items:flex-end;gap:12px">
                        <div>
                          <label style="visibility:hidden">.</label>
                          <img id="cadFotoPreview" class="emp-avatar" src="" alt="" style="width:90px;height:90px;border-radius:16px">
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <label>Nome</label>
                        <input type="text" id="cadNome" placeholder="Nome completo">
                      </div>
                      <div class="col">
                        <label>Função</label>
                        <input type="text" id="cadFuncao" placeholder="Cargo/Função">
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <label>RG</label>
                        <input type="text" id="cadRG" placeholder="00.000.000-0">
                      </div>
                      <div class="col">
                        <label>CPF</label>
                        <input type="text" id="cadCPF" placeholder="000.000.000-00">
                      </div>
                      <div class="col">
                        <label>Idade</label>
                        <input type="number" id="cadIdade" min="0" placeholder="0">
                      </div>
                    </div>

                    <div class="row" id="wrapAdmissaoSalario">
                      <div class="col">
                        <label>Data de admissão</label>
                        <input type="date" id="cadAdmissao">
                      </div>
                      <div class="col">
                        <label>Salário (R$)</label>
                        <input type="number" id="cadSalario" min="0" step="0.01" placeholder="0,00">
                      </div>
                    </div>

                    <div class="row benefit-prices">
                      <div class="col">
                        <label>Tarifa VT (R$)</label>
                        <input type="number" id="cadVtUnit" step="0.01" min="0" placeholder="ex.: 5,00">
                      </div>
                      <div class="col">
                        <label>Valor diário VR (R$)</label>
                        <input type="number" id="cadVrDaily" step="0.01" min="0" placeholder="ex.: 25,00">
                      </div>
                    </div>

                    <div class="row" id="wrapCargoField">
                      <div class="col">
                        <label>Cargo</label>
                        <input type="text" id="cadCargo" placeholder="Ex.: Analista, Engenheiro">
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <div class="benefit-toggles" id="benefitToggleRow">
                          <label><input type="checkbox" id="cadOptVR"> VR</label>
                          <label><input type="checkbox" id="cadOptVT"> VT</label>
                        </div>
                        <div class="vr-help">Marque as opções desejadas. Você pode editar regras em <b>Benefícios</b> depois.</div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <label>Documento (arquivo)</label>
                        <input type="file" id="cadDocumento">
                      </div>
                      <div class="col">
                        <label style="visibility:hidden">.</label>
                        <div class="inline-row">
                          <button class="btn btn-primary" id="btnSalvarCadastro">
                            <i class="fa-regular fa-floppy-disk"></i> Salvar cadastro
                          </button>
                          <button class="btn btn-light" id="btnLimparCadastro">
                            <i class="fa-solid fa-eraser"></i> Limpar
                          </button>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>

            <!-- BUSCA (Gestão) -->
            <div class="emp-tools centered" id="empToolsGestao">
              <div class="search-group">
                <input type="text" id="funcSearchGestao" placeholder="Pesquisar funcionário… (digite para filtrar)">
                <button class="btn btn-light" id="funcSearchGestaoBtn" title="Pesquisar">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <button class="btn btn-light" id="funcClearGestao">
                  <i class="fa-solid fa-xmark"></i> Limpar
                </button>
              </div>
            </div>

            <!-- Botão Cadastro de Usuário -->
            <div class="gestao-actions-left">
              <button class="btn btn-primary" id="btnAbrirCadastro">
                <i class="fa-solid fa-user-plus"></i> Cadastro de Usuário
              </button>
            </div>

            <!-- Host para a grade -->
            <div id="empGridHostGestao"></div>
          </div>
        </div>
      </section>
      <!-- FIM GESTÃO -->

      <!-- GERENCIAR FUNCIONÁRIOS -->
      <section id="tabFuncionarios" class="tab">
        <div class="card">
          <div class="card-header">Funcionários</div>
          <div class="card-body">

            <!-- Busca simples -->
            <div class="emp-tools centered">
              <div class="search-group">
                <input type="text" id="funcSearch" placeholder="Pesquisar funcionário… (digite para filtrar)">
                <button class="btn btn-light" id="funcSearchBtn" title="Pesquisar">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <button class="btn btn-light" id="funcClear"><i class="fa-solid fa-xmark"></i> Limpar</button>
              </div>
            </div>

            <!-- Ações injetadas via JS -->

            <div class="emp-grid" id="empGrid"><!-- via JS --></div>

          </div>
        </div>
      </section>

      <!-- Benefícios — VT -->
      <section id="tabVT" class="tab">
        <div class="card">
          <div class="card-header">Benefícios — Vale Transporte</div>
          <div class="card-body">
            <div class="kpis">
              <div class="kpi">
                <div class="title">Colaboradores com VT</div>
                <div class="value" id="vtKColab">0</div>
              </div>
              <div class="kpi">
                <div class="title">Total de VTs / mês</div>
                <div class="value" id="vtKQtd">0</div>
              </div>
              <div class="kpi">
                <div class="title">Valor total (R$)</div>
                <div class="value" id="vtKValor">R$ 0,00</div>
              </div>
            </div>

            <div class="row" style="align-items:flex-end">
              <div class="col" style="max-width:220px">
                <label>Tarifa padrão (R$)</label>
                <input type="number" step="0.01" min="0" id="vtUnit" placeholder="ex.: 5.00" disabled>
              </div>
              <div class="col" style="max-width:220px">
                <label>Dia do crédito (geral)</label>
                <input type="number" min="1" max="31" id="vtCreditDay" placeholder="1 a 31" disabled>
              </div>
              <div class="col">
                <div class="vt-help">Dados preenchidos automaticamente a partir do cadastro (somente visualização).</div>
              </div>
            </div>

            <div class="filters">
              <button class="btn btn-light" id="btnExportVTCSV"><i class="fa-regular fa-file-excel"></i> Exportar Excel (CSV)</button>
              <button class="btn btn-primary" id="btnExportVTPDF"><i class="fa-regular fa-file-pdf"></i> Exportar PDF</button>
            </div>

            <div class="table-wrap">
              <table class="table" id="vtTable">
                <thead>
                  <tr>
                    <th>Ativo</th>
                    <th class="vt-cell-left">Funcionário</th>
                    <th>Qtd VT/mês</th>
                    <th>Tarifa (R$)</th>
                    <th>Dia crédito</th>
                    <th>Próximo crédito</th>
                    <th>Valor (R$)</th>
                  </tr>
                </thead>
                <tbody id="vtBody"><tr><td colspan="7">—</td></tr></tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="t-right">Totais</th>
                    <th id="vtSumQtd">0</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th id="vtSumValor">R$ 0,00</th>
                  </tr>
                </tfoot>
              </table>
            </div>

          </div>
        </div>
      </section>

      <!-- Benefícios — VR -->
      <section id="tabVR" class="tab">
        <div class="card">
          <div class="card-header">Benefícios — Vale Refeição</div>
          <div class="card-body">
            <div class="kpis">
              <div class="kpi">
                <div class="title">Adesões (VR)</div>
                <div class="value" id="vrKAdesoes">0</div>
              </div>
              <div class="kpi">
                <div class="title">Custo total do benefício</div>
                <div class="value" id="vrKBeneficio">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="title">Desconto total (func.)</div>
                <div class="value" id="vrKDesconto">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="title">Custo líquido p/ empresa</div>
                <div class="value" id="vrKLiquido">R$ 0,00</div>
              </div>

              <div class="export-actions">
                <button class="btn btn-light" id="btnExportVRCSV"><i class="fa-regular fa-file-excel"></i> Exportar Excel (CSV)</button>
                <button class="btn btn-primary" id="btnExportVRPDF"><i class="fa-regular fa-file-pdf"></i> Exportar PDF</button>
              </div>
            </div>

            <div class="row" style="align-items:flex-end">
              <div class="col" style="max-width:220px">
                <label>Valor diário (R$)</label>
                <input type="number" step="0.01" min="0" id="vrDaily" placeholder="ex.: 25.00">
              </div>
              <div class="col" style="max-width:220px">
                <label>Dias úteis / mês</label>
                <input type="number" min="0" max="31" id="vrDays" placeholder="ex.: 22">
              </div>
              <div class="col" style="max-width:220px">
                <label>% desconto sobre salário</label>
                <input type="number" min="0" max="100" step="0.01" id="vrPct" placeholder="6">
              </div>
              <div class="col" style="max-width:220px">
                <label>Dia do crédito (geral)</label>
                <input type="number" min="1" max="31" id="vrCreditDay" placeholder="1 a 31">
              </div>
            </div>

            <div class="row" style="align-items:center">
              <div class="col" style="max-width:320px">
                <label>
                  <input type="checkbox" id="vrCapDiscount" style="margin-right:6px">
                  Limitar desconto ao valor do benefício
                </label>
                <div class="vr-help">Quando marcado, o desconto (6% do salário por padrão) jamais supera o total do VR do mês para aquele colaborador.</div>
              </div>
            </div>

            <div class="table-wrap">
              <table class="table" id="vrTable">
                <thead>
                  <tr>
                    <th>Optou</th>
                    <th class="vr-cell-left">Funcionário</th>
                    <th>Salário (R$)</th>
                    <th>Valor diário (R$)</th>
                    <th>Dias úteis</th>
                    <th>Dia crédito</th>
                    <th>Próximo crédito</th>
                    <th>Benefício</th>
                    <th>Desconto</th>
                    <th>Líquido</th>
                  </tr>
                </thead>
                <tbody id="vrBody"><tr><td colspan="10">—</td></tr></tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="t-right">Totais</th>
                    <th></th><th></th><th></th><th></th><th></th>
                    <th id="vrSumBeneficio">R$ 0,00</th>
                    <th id="vrSumDesconto">R$ 0,00</th>
                    <th id="vrSumLiquido">R$ 0,00</th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="vr-help" style="margin-top:8px">
              Observação: os campos por funcionário aceitam sobrescrever os padrões (valor diário, dias, % desconto e dia do crédito).
            </div>

          </div>
        </div>
      </section>

      <!-- Configurações -->
      <section id="tabConfig" class="tab">
        <div class="card">
          <div class="card-header">Configurações</div>
          <div class="card-body">
          <div class="muted-hint">Nenhuma opção disponível no momento.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Batimentos do Dia -->
  <div class="modal" id="modalBatimentosDia">
    <div class="modal-content">
      <div class="modal-header"><span id="batimentosDiaTitulo">Batimentos do dia</span></div>
      <div class="modal-body">
        <div class="bat-dia-nav">
          <button class="btn btn-light" id="btnPrevDia">◀ Dia anterior</button>
          <div class="bat-dia-picker"><input type="date" id="batimentosDatePicker"></div>
          <button class="btn btn-light" id="btnNextDia">Próximo dia ▶</button>
        </div>
        <table class="table">
          <thead><tr><th>#</th><th>Tipo</th><th>Horário</th><th>Origem</th><th>Observação</th></tr></thead>
          <tbody id="batimentosDiaBody"><tr><td colspan="5">-</td></tr></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="fecharBatimentosDia">Fechar</button>
        <button class="btn btn-ghost" id="justificarAusenciaDia">Justificar Ausência</button>
        <button class="btn btn-primary" id="incluirPontoDia">Incluir Ponto</button>
      </div>
    </div>
  </div>

  <!-- Modal Funcionário -->
  <div class="modal" id="modalFuncionario">
    <div class="modal-content">
      <div class="modal-header"><span id="funcModalTitle">Funcionário</span></div>
      <div class="modal-body">
        <div class="emp-modal-header">
          <img id="funcModalAvatar" class="emp-avatar" src="" alt="">
          <div>
            <div class="emp-name" id="funcModalNome">—</div>
            <div class="emp-role" id="funcModalFuncao">—</div>
          </div>
        </div>

        <!-- Abas (duas: Documentos e Documentos Importantes) -->
        <div class="emp-tabs" role="tablist" aria-label="Documentos do funcionário">
          <button class="btn btn-light emp-tab-btn active" id="btnTabDocsSimples" data-target="#paneDocsSimples">
            <i class="fa-regular fa-folder-open"></i> Documentos
          </button>
          <button class="btn btn-warn emp-tab-btn" id="btnTabDocsImportantes" data-target="#paneDocsImportantes">
            <i class="fa-regular fa-bell"></i> Documentos importantes
          </button>
        </div>

        <!-- Pane: Documentos simples -->
        <div class="emp-pane active" id="paneDocsSimples">
          <div class="inline-row" style="margin-bottom:10px">
            <input type="file" id="genDocFile" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx,.txt" style="min-width:260px">
            <button class="btn btn-ok" id="btnAddGenDoc"><i class="fa-solid fa-upload"></i> Anexar</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Arquivo</th>
                <th>Tamanho</th>
                <th>Enviado em</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="genDocsTable"><tr><td colspan="4">—</td></tr></tbody>
          </table>
        </div>

        <!-- Pane: Documentos importantes -->
        <div class="emp-pane" id="paneDocsImportantes">
          <div class="imp-docs-form">
            <div>
              <label>Arquivo</label>
              <input type="file" id="impDocFile" accept=".pdf,.png,.jpg,.jpeg">
            </div>
            <div>
              <label>Nome do documento</label>
              <input type="text" id="impDocName" placeholder="Ex.: CNH, ASO, Certidão">
            </div>
            <div>
              <label>Tipo</label>
              <select id="impDocType">
                <option value="CNH">CNH</option>
                <option value="ASO">ASO</option>
                <option value="Certidão">Certidão</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div>
              <label>Data de emissão</label>
              <input type="date" id="impDocIssue">
            </div>
            <div>
              <label>Data de validade</label>
              <input type="date" id="impDocDue">
            </div>
            <div>
              <button class="btn btn-ok" id="btnAddImpDoc">
                <i class="fa-solid fa-plus"></i> Adicionar
              </button>
            </div>
          </div>

          <div class="filehint imp-bell" style="margin-bottom:6px">
            <i class="fa-regular fa-bell"></i> Ative o sino por documento para ser avisado no vencimento.
          </div>

          <table class="table" style="margin-top:8px">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Emissão</th>
                <th>Validade</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="impDocsTable"><tr><td colspan="5">—</td></tr></tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="fecharFuncionario">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Criar Tipo de Documento -->
  <div class="modal" id="modalNovoDoc">
    <div class="modal-content">
      <div class="modal-header">Criar tipo de documento</div>
      <div class="modal-body">
        <div class="row">
          <div class="col">
            <label>Nome do tipo</label>
            <input type="text" id="tplNome" placeholder="Ex.: Atestado, Termo de Responsabilidade">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Conteúdo do modelo</label>
            <textarea id="tplTexto" spellcheck="false" placeholder="Digite o conteúdo do documento. Você pode usar {{nome}}, {{documento}} e {{data}} para preencher automaticamente."></textarea>
          </div>
        </div>
        <div class="filehint">Dica: use <b>{{nome}}</b>, <b>{{documento}}</b> e <b>{{data}}</b> como variáveis que serão preenchidas.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="btnCancelarNovoDoc">Cancelar</button>
        <button class="btn btn-primary" id="btnSalvarNovoDoc"><i class="fa-regular fa-floppy-disk"></i> Salvar tipo</button>
      </div>
    </div>
  </div>

  <!-- Modal Cadastro de Usuário -->
  <div class="modal" id="modalCadastroUsuario">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="cadastroTitulo">
      <div class="modal-header" id="cadastroTitulo">Cadastro de Usuário</div>
      <div class="modal-body" id="modalCadastroBody"><!-- o bloco .gestao-cadastro será movido aqui via JS --></div>
      <div class="modal-footer">
        <button class="btn btn-light" id="btnFecharCadastro">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Lembretes -->
  <div class="modal" id="modalAlerts">
    <div class="modal-content">
      <div class="modal-header">Lembretes</div>
      <div class="modal-body">
        <table class="table">
          <thead><tr><th>Funcionário</th><th>Documento</th><th>Vencimento</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="alertsTable"><tr><td colspan="5">Sem lembretes.</td></tr></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="btnCloseAlerts">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Tela pública de assinatura -->
  <div id="publicSign" class="public-sign" aria-live="polite">
    <div class="wrap">
      <div class="card">
        <div class="card-header">Assinar Documento</div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <label>Documento</label>
              <div id="pubDocTitle" class="kv-strong">—</div>
            </div>
            <div class="col">
              <label>Colaborador</label>
              <div id="pubDocWho" class="kv-strong">—</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Conteúdo</label>
              <div id="pubDocText" class="doc-box scroll-styled" style="max-height:40vh"></div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>Assinatura</label>
              <div class="sig-toolbar" style="margin-bottom:6px">
                <button class="btn btn-light" id="btnLimparAssPublic">Limpar</button>
                <button class="btn btn-primary" id="btnBaixarPDFPublic"><i class="fa-regular fa-file-pdf"></i> Assinar e baixar PDF</button>
              </div>
              <div class="sig-wrap"><canvas id="sigPadPublic"></canvas></div>
            </div>
          </div>
          <div class="inline-row mt-8">
            <button class="btn btn-light" id="btnFecharPublic"><i class="fa-solid fa-xmark"></i> Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/* RCR Engenharia — RH (JS corrigido e consolidado) */
/* eslint-disable no-unused-vars */
(() => {
  'use strict';

  /* ===================== REFS ===================== */
  const $ = (id) => document.getElementById(id);

  const uNome = $('uNome');
  const uFuncao = $('uFuncao');
  const helloNome = $('helloNome');

  const btnPeriodoAtual = $('btnPeriodoAtual');
  const btnAplicarFiltro = $('btnAplicarFiltro');
  const btnExportPonto = $('btnExportPonto');
  const pInicio = $('pInicio');
  const pFim = $('pFim');
  const kHoras = $('kHoras');
  const kSaldo = $('kSaldo');
  const kPend = $('kPend');

  const lblAgora = $('lblAgora');
  const lblCoord = $('lblCoord');
  const btnBaterPonto = $('btnBaterPonto');

  const sigPadEl = $('sigPad');
  const btnLimparAss = $('btnLimparAss');
  const btnGerarPDF = $('btnGerarPDF');
  const sigImport = $('sigImport');

  const tplImport = $('tplImport');
  const docTipo = $('docTipo');
  const docNome = $('docNome');
  const docDoc = $('docDoc');
  const docTexto = $('docTexto');

  const docHeaderTitle = $('docHeaderTitle');
  const docHeaderAlign = $('docHeaderAlign');
  const docFooterText = $('docFooterText');
  const docPageNums = $('docPageNums');
  const docHeaderLogo = $('docHeaderLogo');
  const btnSalvarLayoutDoc = $('btnSalvarLayoutDoc');

  const btnCriarTipoDoc = $('btnCriarTipoDoc');
  const modalNovoDoc = $('modalNovoDoc');
  const btnSalvarNovoDoc = $('btnSalvarNovoDoc');
  const btnCancelarNovoDoc = $('btnCancelarNovoDoc');
  const tplNome = $('tplNome');
  const tplTexto = $('tplTexto');

  const impDocFile = $('impDocFile');
  const impDocName = $('impDocName');
  const impDocType = $('impDocType');
  const impDocIssue = $('impDocIssue');
  const impDocDue = $('impDocDue');
  const btnAddImpDoc = $('btnAddImpDoc');
  const impDocsTable = $('impDocsTable');

  const btnAlerts = $('btnAlerts');
  const notifDot = $('notifDot');
  const modalAlerts = $('modalAlerts');
  const alertsTable = $('alertsTable');
  const btnCloseAlerts = $('btnCloseAlerts');

  const btnHamb = $('btnHamb');
  const sidebar = $('sidebar');
  const btnCloseSidebar = $('btnCloseSidebar');

  const empGrid = $('empGrid');
  const funcSearch = $('funcSearch');
  const funcClear = $('funcClear');
  const funcSearchBtn = $('funcSearchBtn');
  const funcSearchGestao = $('funcSearchGestao');
  const funcClearGestao = $('funcClearGestao');
  const funcSearchGestaoBtn = $('funcSearchGestaoBtn');
  const empGridHostGestao = $('empGridHostGestao');

  const modalFuncionario = $('modalFuncionario');
  const funcModalNome = $('funcModalNome');
  const funcModalFuncao = $('funcModalFuncao');
  const funcModalAvatar = $('funcModalAvatar');
  const fecharFuncionario = $('fecharFuncionario');

  const btnAbrirCadastro = $('btnAbrirCadastro');
  const btnFecharCadastro = $('btnFecharCadastro');
  const modalCadastroUsuario = $('modalCadastroUsuario');
  const modalCadastroBody = $('modalCadastroBody');

  const cadFoto = $('cadFoto');
  const cadFotoPreview = $('cadFotoPreview');
  const cadNome = $('cadNome');
  const cadFuncao = $('cadFuncao');
  const cadRG = $('cadRG');
  const cadCPF = $('cadCPF');
  const cadIdade = $('cadIdade');
  const cadCargo = $('cadCargo');
  const cadSalario = $('cadSalario');
  const cadOptVR = $('cadOptVR');
  const cadOptVT = $('cadOptVT');
  const cadAdmissao = $('cadAdmissao');
  const cadVtUnit = $('cadVtUnit');
  const cadVrDaily = $('cadVrDaily');
  const cadDocumento = $('cadDocumento');
  const btnSalvarCadastro = $('btnSalvarCadastro');
  const btnLimparCadastro = $('btnLimparCadastro');

  /* VT */
  const vtUnit = $('vtUnit');
  const vtCreditDay = $('vtCreditDay');
  const vtBody = $('vtBody');
  const vtKColab = $('vtKColab');
  const vtKQtd = $('vtKQtd');
  const vtKValor = $('vtKValor');
  const vtSumQtd = $('vtSumQtd');
  const vtSumValor = $('vtSumValor');
  const btnExportVTCSV = $('btnExportVTCSV');
  const btnExportVTPDF = $('btnExportVTPDF');

  /* VR */
  const vrDaily = $('vrDaily');
  const vrDays = $('vrDays');
  const vrPct = $('vrPct');
  const vrCreditDay = $('vrCreditDay');
  const vrCapDiscount = $('vrCapDiscount');
  const vrBody = $('vrBody');
  const vrKAdesoes = $('vrKAdesoes');
  const vrKBeneficio = $('vrKBeneficio');
  const vrKDesconto = $('vrKDesconto');
  const vrKLiquido = $('vrKLiquido');
  const vrSumBeneficio = $('vrSumBeneficio');
  const vrSumDesconto = $('vrSumDesconto');
  const vrSumLiquido = $('vrSumLiquido');
  const btnExportVRCSV = $('btnExportVRCSV');
  const btnExportVRPDF = $('btnExportVRPDF');

  /* Ponto (detalhes) */
  const modalBat = $('modalBatimentosDia');
  const batimentosDiaTitulo = $('batimentosDiaTitulo');
  const batimentosDiaBody = $('batimentosDiaBody');
  const batimentosDatePicker = $('batimentosDatePicker');
  const fecharBatimentosDia = $('fecharBatimentosDia');
  const btnPrevDia = $('btnPrevDia');
  const btnNextDia = $('btnNextDia');
  const incluirPontoDia = $('incluirPontoDia');
  const justificarAusenciaDia = $('justificarAusenciaDia');

  /* Public sign */
  const btnGerarLinkAss = $('btnGerarLinkAss');
  const btnCopiarLinkAss = $('btnCopiarLinkAss');
  const assLink = $('assLink');
  const publicSign = $('publicSign');
  const pubDocTitle = $('pubDocTitle');
  const pubDocWho = $('pubDocWho');
  const pubDocText = $('pubDocText');
  const btnLimparAssPublic = $('btnLimparAssPublic');
  const btnFecharPublic = $('btnFecharPublic');
  const btnBaixarPDFPublic = $('btnBaixarPDFPublic');

  /* Extras */
  const toastRoot = $('toastContainer');

  /* ===================== UTILS ===================== */
  const two = (n) => String(n).padStart(2, '0');
  const toYMD = (d) => d.getFullYear() + '-' + two(d.getMonth() + 1) + '-' + two(d.getDate());
  const fromYMD = (s) => {
    const [y, m, d] = String(s || '').split('-').map(Number);
    return new Date(y, (m || 1) - 1, d || 1);
  };
  const nowTime = () => {
    const n = new Date();
    return `${two(n.getHours())}:${two(n.getMinutes())}:${two(n.getSeconds())}`;
  };
  const todayYMD = () => toYMD(new Date());
  const diffHHMM = (mins) => {
    const sign = mins < 0 ? '-' : '';
    const a = Math.abs(mins);
    const h = Math.floor(a / 60),
      m = a % 60;
    return sign + two(h) + ':' + two(m);
  };
  const brDate = (d) =>
    d.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });

  const escapeHTML = (str) =>
    String(str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

  const bytesHuman = (b) => {
    if (b < 1024) return b + ' B';
    const kb = b / 1024;
    if (kb < 1024) return kb.toFixed(1) + ' KB';
    const mb = kb / 1024;
    return mb.toFixed(1) + ' MB';
  };

  const slugify = (s) =>
    (s || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 40) || 'tipo-' + Date.now();

  /* ===================== TOAST ===================== */
  function notify(message, type = 'info', { duration = 3400 } = {}) {
    if (!toastRoot) return alert(message);
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.innerHTML = `
      <div class="msg">${escapeHTML(String(message))}</div>
      <span class="close">&times;</span>
    `;
    toastRoot.appendChild(el);
    setTimeout(() => el.classList.add('show'), 10);
    const t = setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 200);
    }, duration);
    el.querySelector('.close').onclick = () => {
      clearTimeout(t);
      el.classList.remove('show');
      setTimeout(() => el.remove(), 200);
    };
  }
  window.alert = (msg) => notify(msg, 'info');

  /* ===================== STORAGE KEYS ===================== */
  const LS_KEYS = {
    ME: 'rh_me',
    PUNCHES: 'batimentos',
    FUNCS: 'rh_funcionarios'
  };
  const KEY_DOC_TEMPLATES = 'rh_doc_templates';
  const KEY_DOC_LAYOUT = 'rh_doc_layout';
  const KEY_DOCS_IMPORT = 'rh_docs_important'; // por funcionário
  const KEY_ALERTS = 'rh_alerts';

  /* VT/VR */
  const KEY_VT_SETTINGS = 'rh_benef_vt_settings';
  const KEY_VT_MAP = 'rh_benef_vt';
  const KEY_VR_SETTINGS = 'rh_benef_vr_settings';
  const KEY_VR_MAP = 'rh_benef_vr';

  /* ===================== STORAGE HELPERS ===================== */
  const getMe = () =>
    JSON.parse(localStorage.getItem(LS_KEYS.ME) || '{"nome":"Gustavo (exemplo)","funcao":"Colaborador"}');
  const setMe = (o) => localStorage.setItem(LS_KEYS.ME, JSON.stringify(o || {}));

  const getAllPunches = () => JSON.parse(localStorage.getItem(LS_KEYS.PUNCHES) || '[]');
  const setAllPunches = (a) => localStorage.setItem(LS_KEYS.PUNCHES, JSON.stringify(a || []));

  const getTemplates = () => JSON.parse(localStorage.getItem(KEY_DOC_TEMPLATES) || '[]');
  const setTemplates = (a) => localStorage.setItem(KEY_DOC_TEMPLATES, JSON.stringify(a || []));

  const getImpDocsMap = () => JSON.parse(localStorage.getItem(KEY_DOCS_IMPORT) || '{}');
  const setImpDocsMap = (o) => localStorage.setItem(KEY_DOCS_IMPORT, JSON.stringify(o || {}));

  const getAlerts = () => JSON.parse(localStorage.getItem(KEY_ALERTS) || '[]');
  const setAlerts = (a) => localStorage.setItem(KEY_ALERTS, JSON.stringify(a || []));

  const uid = (p = 'id') => `${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 6)}`;

  /* ===================== MENU / TABS ===================== */
  btnHamb?.addEventListener('click', () => {
    sidebar?.classList.toggle('active');
    document.body.classList.toggle('sidebar-open');
  });
  btnCloseSidebar?.addEventListener('click', () => {
    sidebar?.classList.remove('active');
    document.body.classList.remove('sidebar-open');
  });

  document.getElementById('menu')?.addEventListener('click', (e) => {
    const clickedRowHead = e.target.closest('.row-head');
    const rootItem = e.target.closest('li.has-submenu');
    const clickedSubItem = e.target.closest('ul.submenu > li[data-tab]');
    if (clickedRowHead && rootItem) {
      rootItem.classList.toggle('open');
      rootItem.classList.add('active');
      return;
    }
    const li = e.target.closest('li[data-tab]');
    if (!li) return;

    if (li.classList.contains('has-submenu') && !clickedSubItem) {
      li.classList.toggle('open');
      li.classList.add('active');
      return;
    }

    document.querySelectorAll('.menu li, .menu li .submenu li').forEach((x) => x.classList.remove('active'));
    li.classList.add('active');
    const parentRoot = li.closest('li.has-submenu');
    if (parentRoot) {
      parentRoot.classList.add('active');
      parentRoot.classList.add('open');
    }

    const tab = li.getAttribute('data-tab');
    document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
    document.getElementById(tab)?.classList.add('active');

    if (window.innerWidth <= 960) {
      sidebar?.classList.remove('active');
      document.body.classList.remove('sidebar-open');
    }

    if (tab === 'tabIncluir' && !mapInited) initMap();
    if (tab === 'tabDocs') {
      setTimeout(resizeSigCanvas, 50);
      fitDocTextarea();
    }
    if (tab === 'tabVT') renderVT();
    if (tab === 'tabVR') renderVR();

    /* move a grade entre Gestão e Gerenciar */
    try {
      const grid = empGrid;
      if (tab === 'tabFuncGestao') {
        const host = empGridHostGestao;
        if (host && grid && host !== grid.parentElement) host.appendChild(grid);
      } else if (tab === 'tabFuncionarios') {
        const body = document.querySelector('#tabFuncionarios .card-body');
        if (body && grid && !body.contains(grid)) body.appendChild(grid);
      }
    } catch {}
    if (tab === 'tabPonto') setTimeout(fitPontoTableToViewport, 60);
  });

  /* ===================== RELÓGIO ===================== */
  function tick() {
    $('nowClock') && ($('nowClock').textContent = nowTime());
    lblAgora && (lblAgora.textContent = new Date().toLocaleString('pt-BR'));
  }
  setInterval(tick, 1000);
  tick();

  /* ===================== PERFIL ===================== */
  (function initMe() {
    const me = getMe();
    if (uNome) uNome.textContent = me.nome || 'Colaborador(a)';
    if (uFuncao) uFuncao.textContent = me.funcao || 'Função';
    if (helloNome) helloNome.textContent = me.nome || 'Colaborador(a)';
  })();

  /* ===================== SEED BATIMENTOS ===================== */
  if (getAllPunches().length === 0) {
    const seed = [];
    const base = new Date();
    base.setDate(base.getDate() - 7);
    for (let i = 0; i < 10; i++) {
      const d = new Date(base);
      d.setDate(base.getDate() + i);
      const ymd = toYMD(d);
      if (d.getDay() !== 0) {
        seed.push({ date: ymd, time: '09:00', type: 'Entrada', origin: 'Web', note: '' });
        seed.push({ date: ymd, time: '12:00', type: 'Saída', origin: 'Web', note: 'Almoço' });
        seed.push({ date: ymd, time: '13:00', type: 'Entrada', origin: 'Web', note: '' });
        seed.push({ date: ymd, time: '18:00', type: 'Saída', origin: 'Web', note: '' });
      }
    }
    setAllPunches(seed);
  }

  /* ===================== CARTÃO DE PONTO ===================== */
  const tPontoBody = document.querySelector('#tPonto tbody');

  function setDefaultPeriod() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 14);
    pInicio && (pInicio.value = toYMD(start));
    pFim && (pFim.value = toYMD(end));
  }
  btnPeriodoAtual?.addEventListener('click', () => {
    setDefaultPeriod();
    renderPonto();
  });
  btnAplicarFiltro?.addEventListener('click', renderPonto);
  setDefaultPeriod();

  function punchesByDate(ymd) {
    return getAllPunches()
      .filter((b) => b.date === ymd)
      .sort((a, b) => a.time.localeCompare(b.time));
  }
  function calcSaldoMinsForDay(list) {
    let mins = 0,
      lastIn = null;
    for (const b of list) {
      if (b.type === 'Entrada') lastIn = b.time;
      else if (b.type === 'Saída' && lastIn) {
        const [h1, m1] = lastIn.split(':').map(Number);
        const [h2, m2] = b.time.split(':').map(Number);
        mins += h2 * 60 + m2 - (h1 * 60 + m1);
        lastIn = null;
      }
    }
    return mins;
  }
  function statusForDay(list) {
    if (list.length === 0) return { cls: 'warn', tip: 'Sem marcações' };
    const first = list[0].type,
      last = list[list.length - 1].type;
    if (first === 'Saída' || last === 'Entrada') return { cls: 'err', tip: 'Pendências' };
    return { cls: 'ok', tip: 'OK' };
  }
  function dayRow(list, ymd) {
    const entries = list.filter((b) => b.type === 'Entrada').map((b) => b.time);
    const exits = list.filter((b) => b.type === 'Saída').map((b) => b.time);
    const saldo = diffHHMM(calcSaldoMinsForDay(list));
    const stat = statusForDay(list);
    const d = fromYMD(ymd);
    const br = d.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit' });
    return `<tr class="row-dia" data-date="${ymd}" title="Clique para detalhar">
      <td><span class="status-dot ${stat.cls}" title="${stat.tip}"></span></td>
      <td>${br}</td>
      <td>${entries[0] || ''}</td><td>${exits[0] || ''}</td>
      <td>${entries[1] || ''}</td><td>${exits[1] || ''}</td>
      <td>${entries[2] || ''}</td><td>${exits[2] || ''}</td>
      <td>${saldo}</td>
    </tr>`;
  }
  function renderPonto() {
    if (!tPontoBody) return;
    const ini = fromYMD(pInicio?.value || todayYMD());
    const fim = fromYMD(pFim?.value || todayYMD());
    if (fim < ini) {
      notify('Período inválido.', 'warn');
      return;
    }
    let html = '',
      totalMins = 0,
      pend = 0;
    for (let d = new Date(ini); d <= fim; d.setDate(d.getDate() + 1)) {
      const ymd = toYMD(d);
      const list = punchesByDate(ymd);
      html += dayRow(list, ymd);
      const st = statusForDay(list);
      if (st.cls !== 'ok') pend++;
      totalMins += calcSaldoMinsForDay(list);
    }
    tPontoBody.innerHTML =
      html || `<tr><td colspan="9" style="color:#9fb1c3">Sem registros no período.</td></tr>`;
    kHoras && (kHoras.textContent = diffHHMM(totalMins));
    kSaldo && (kSaldo.textContent = diffHHMM(totalMins));
    kPend && (kPend.textContent = String(pend));
  }
  renderPonto();

  /* abrir modal do dia */
  document.addEventListener('click', (ev) => {
    const row = ev.target.closest('.row-dia[data-date]');
    if (!row) return;
    openBatimentosDia(row.getAttribute('data-date'));
  });

  function getPunchesForDate(ymd) {
    return punchesByDate(ymd).map((b, i) => ({ idx: i + 1, ...b }));
  }
  function openBatimentosDia(ymd) {
    if (!modalBat) return;
    const d = fromYMD(ymd);
    batimentosDiaTitulo && (batimentosDiaTitulo.textContent = 'Batimentos de ' + brDate(d));
    batimentosDatePicker && (batimentosDatePicker.value = ymd);
    const rows = getPunchesForDate(ymd);
    if (batimentosDiaBody) {
      batimentosDiaBody.innerHTML = rows.length
        ? rows
            .map(
              (r) =>
                `<tr><td>${r.idx}</td><td>${r.type}</td><td>${r.time}</td><td>${r.origin || '-'}</td><td>${
                  r.note || '-'
                }</td></tr>`
            )
            .join('')
        : `<tr><td colspan="5" style="color:#9fb1c3">Nenhum batimento para este dia.</td></tr>`;
    }
    modalBat.style.display = 'flex';
  }
  function closeBatimentosDia() {
    modalBat && (modalBat.style.display = 'none');
  }
  fecharBatimentosDia?.addEventListener('click', closeBatimentosDia);
  btnPrevDia?.addEventListener('click', () => {
    const d = fromYMD(batimentosDatePicker?.value || todayYMD());
    d.setDate(d.getDate() - 1);
    openBatimentosDia(toYMD(d));
  });
  btnNextDia?.addEventListener('click', () => {
    const d = fromYMD(batimentosDatePicker?.value || todayYMD());
    d.setDate(d.getDate() + 1);
    openBatimentosDia(toYMD(d));
  });
  batimentosDatePicker?.addEventListener('change', (e) => e.target.value && openBatimentosDia(e.target.value));
  incluirPontoDia?.addEventListener('click', () => {
    closeBatimentosDia();
    document.querySelector('.menu li[data-tab="tabIncluir"]')?.click();
  });
  justificarAusenciaDia?.addEventListener('click', () =>
    notify('Abrir fluxo de justificativa (integração futura).', 'info')
  );

  /* Exportar Cartão em PDF */
  async function imgElToDataURL_FIX(src) {
    return new Promise((resolve) => {
      const img = new Image();
      try {
        const u = new URL(src, location.href);
        if (u.origin !== location.origin) img.crossOrigin = 'anonymous';
      } catch {}
      img.onload = () => {
        try {
          const c = document.createElement('canvas');
          c.width = img.naturalWidth;
          c.height = img.naturalHeight;
          c.getContext('2d').drawImage(img, 0, 0);
          resolve(c.toDataURL('image/png'));
        } catch {
          resolve(null);
        }
      };
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }
  async function getCompanyLogoDataURL() {
    const el = document.querySelector('.brand-logo');
    if (el && el.complete && el.naturalWidth) {
      try {
        const c = document.createElement('canvas');
        c.width = el.naturalWidth;
        c.height = el.naturalHeight;
        c.getContext('2d').drawImage(el, 0, 0);
        return c.toDataURL('image/png');
      } catch {}
    }
    if (el && el.src) {
      const d = await imgElToDataURL_FIX(el.src);
      if (d) return d;
    }
    const splash = document.querySelector('.splash-logo');
    if (splash && splash.src) {
      const d = await imgElToDataURL_FIX(splash.src);
      if (d) return d;
    }
    return await imgElToDataURL_FIX('Assets/img/logo_new.png');
  }

  btnExportPonto?.addEventListener('click', async () => {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF não carregado.', 'error');
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const mx = 28;
    let y = 22;

    doc.setFillColor(245, 246, 250);
    doc.rect(0, 0, pageW, 70, 'F');

    const logo = await getCompanyLogoDataURL();
    if (logo) {
      const fmtMatch = /^data:image\/(png|jpeg|jpg|webp)/i.exec(logo);
      doc.addImage(logo, (fmtMatch ? fmtMatch[1] : 'png').toUpperCase(), mx, 16, 120, 40);
    } else {
      doc.setDrawColor(160);
      doc.rect(mx, 16, 120, 40);
    }

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('CARTÃO PONTO', pageW - mx, 32, { align: 'right' });
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Período: ${pInicio?.value} até ${pFim?.value}`, pageW - mx, 50, { align: 'right' });

    const me = getMe();
    const empresaNome = document.querySelector('.brand strong')?.textContent?.trim() || 'RCR ENGENHARIA';

    function kvRow(x, lab, val, x2, lab2, val2) {
      const lh = 14;
      doc.setFont('helvetica', 'bold');
      doc.text(lab, x, y);
      doc.setFont('helvetica', 'normal');
      doc.text(val, x + 82, y);
      if (lab2) {
        doc.setFont('helvetica', 'bold');
        doc.text(lab2, x2, y);
        doc.setFont('helvetica', 'normal');
        doc.text(val2, x2 + 82, y);
      }
      y += lh;
    }

    y = 88;
    kvRow(mx, 'EMPRESA:', empresaNome);
    kvRow(mx, 'NOME:', me.nome || 'Colaborador(a)');
    kvRow(mx, 'FUNÇÃO:', me.funcao || '—');
    kvRow(mx, 'OBSERVAÇÃO:', '');
    y += 6;

    const tableX = mx;
    const tableW = pageW - 2 * mx;
    const rowH = 18;
    const cols = [
      { w: 74, title: 'DATA' },
      { w: 52, title: 'E1' },
      { w: 52, title: 'S1' },
      { w: 52, title: 'E2' },
      { w: 52, title: 'S2' },
      { w: 52, title: 'E3' },
      { w: 52, title: 'S3' },
      { w: 51, title: 'SALDO' },
      { w: 51, title: 'FALTAS' },
      { w: 51, title: 'NOT.TOT.' }
    ];

    doc.setFillColor(230, 232, 236);
    doc.rect(tableX, y, tableW, rowH, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    let cx = tableX + 6;
    cols.forEach((c) => {
      doc.text(c.title, cx, y + 12);
      cx += c.w;
    });
    doc.setDrawColor(180);
    doc.rect(tableX, y, tableW, rowH);
    y += rowH;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    let totalMins = 0;

    const ini = fromYMD(pInicio?.value || todayYMD());
    const fim = fromYMD(pFim?.value || todayYMD());

    for (let d = new Date(ini); d <= fim; d.setDate(d.getDate() + 1)) {
      const ymd = toYMD(d);
      const list = punchesByDate(ymd);
      const entries = list.filter((b) => b.type === 'Entrada').map((b) => b.time);
      const exits = list.filter((b) => b.type === 'Saída').map((b) => b.time);

      const vals = {
        e1: entries[0] || '',
        s1: exits[0] || '',
        e2: entries[1] || '',
        s2: exits[1] || '',
        e3: entries[2] || '',
        s3: exits[2] || '',
        saldo: ''
      };

      if (list.length) {
        const mins = calcSaldoMinsForDay(list);
        totalMins += mins;
        vals.saldo = mins === 0 ? '00:00' : diffHHMM(mins);
      } else {
        vals.e1 = vals.s1 = vals.e2 = vals.s2 = vals.e3 = vals.s3 = 'FOLGA';
        vals.saldo = '';
      }

      const dtLabel =
        d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) +
        ' - ' +
        d.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');

      if (y > pageH - 80) {
        doc.addPage();
        y = 40;
        doc.setFillColor(230, 232, 236);
        doc.rect(tableX, y, tableW, rowH, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        let cxh = tableX + 6;
        cols.forEach((c) => {
          doc.text(c.title, cxh, y + 12);
          cxh += c.w;
        });
        doc.setDrawColor(180);
        doc.rect(tableX, y, tableW, rowH);
        y += rowH;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
      }

      doc.setDrawColor(210);
      doc.rect(tableX, y, tableW, rowH);

      let tx = tableX + 6;
      doc.text(dtLabel, tx, y + 12);
      tx += cols[0].w;

      const values = [vals.e1, vals.s1, vals.e2, vals.s2, vals.e3, vals.s3, vals.saldo, '', ''];
      for (let i = 1; i < cols.length; i++) {
        const w = cols[i].w;
        doc.text(String(values[i - 1] || ''), tx + w / 2, y + 12, { align: 'center' });
        tx += w;
      }
      y += rowH;
    }

    if (y > pageH - 70) {
      doc.addPage();
      y = 40;
    }
    doc.setDrawColor(0);
    doc.setLineWidth(0.8);
    doc.line(mx, y + 6, pageW - mx, y + 6);
    y += 20;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text('TOTAIS', mx, y);
    doc.setFont('helvetica', 'normal');
    doc.text(`Horas no período: ${diffHHMM(totalMins)}`, mx + 70, y);

    const me2 = getMe();
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text(me2.nome || 'Colaborador(a)', mx, pageH - 24);
    doc.text(empresaNome, pageW - mx, pageH - 24, { align: 'right' });

    doc.save('folha_de_ponto.pdf');
  });

  /* ===================== MAPA & GEO ===================== */
  let mapInited = false,
    map,
    marker;
  function initMap() {
    if (mapInited) return;
    mapInited = true;
    const last = JSON.parse(localStorage.getItem('lastLatLng') || 'null');
    map = L.map('map', { zoomControl: true, preferCanvas: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    const fallback = last || [-23.5619, -46.6564];
    map.setView(fallback, last ? 16 : 13);
    if (last) marker = L.marker(last).addTo(map);
    const GEO_OPTS = { enableHighAccuracy: false, maximumAge: 180000, timeout: 7000 };
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const latlng = [pos.coords.latitude, pos.coords.longitude];
          if (!marker) marker = L.marker(latlng).addTo(map);
          else marker.setLatLng(latlng);
          map.setView(latlng, 17);
          localStorage.setItem('lastLatLng', JSON.stringify(latlng));
          lblCoord && (lblCoord.textContent = latlng[0].toFixed(5) + ', ' + latlng[1].toFixed(5));
        },
        () => {},
        GEO_OPTS
      );
    }
  }
  function nextTypeFor(dateYMD) {
    const list = punchesByDate(dateYMD);
    if (list.length === 0) return 'Entrada';
    return list[list.length - 1].type === 'Entrada' ? 'Saída' : 'Entrada';
  }
  btnBaterPonto?.addEventListener('click', () => {
    const ymd = todayYMD();
    const next = nextTypeFor(ymd);
    const list = punchesByDate(ymd);
    const eCount = list.filter((b) => b.type === 'Entrada').length;
    const sCount = list.filter((b) => b.type === 'Saída').length;
    if (next === 'Entrada' && eCount >= 3) return notify('Limite atingido: 3 entradas.', 'error');
    if (next === 'Saída' && sCount >= 3) return notify('Limite atingido: 3 saídas.', 'error');

    let lat = '--',
      lon = '--';
    if (map && map.getCenter()) {
      const c = map.getCenter();
      lat = c.lat.toFixed(5);
      lon = c.lng.toFixed(5);
    }
    const all = getAllPunches();
    all.push({ date: ymd, time: nowTime().slice(0, 5), type: next, origin: 'Web', note: `GPS ${lat},${lon}` });
    setAllPunches(all);
    renderPonto();
    openBatimentosDia(ymd);
  });

  /* ===================== MODELOS & DOCS ===================== */
  function modeloTexto(tipo, nome, documento) {
    const hoje = new Date().toLocaleDateString('pt-BR');
    if (tipo === 'interesse')
      return `DECLARAÇÃO DE INTERESSE

Eu, ${nome} (doc. ${documento}), declaro para os devidos fins que tenho interesse em participar do processo/atividade em referência, estando ciente das condições e responsabilidades envolvidas.

Local e data: ____________________, ${hoje}
Assinatura: ____________________________`;
    if (tipo === 'anuencia')
      return `CARTA DE ANUÊNCIA

Eu, ${nome} (doc. ${documento}), declaro que estou ciente e anuente quanto à(s) condições apresentada(s), não havendo qualquer oposição quanto à continuidade dos trâmites.

Local e data: ____________________, ${hoje}
Assinatura: ____________________________`;
    if (tipo === 'dividas')
      return `DECLARAÇÃO DE AUSÊNCIA DE DÍVIDAS

Eu, ${nome} (doc. ${documento}), declaro, sob as penas da lei, não possuir quaisquer débitos/dívidas em aberto junto à empresa/entidade, até a presente data.

Local e data: ____________________, ${hoje}
Assinatura: ____________________________`;

    if (tipo?.startsWith('tpl:')) {
      const slug = tipo.slice(4);
      const tpl = getTemplates().find((t) => t.id === slug);
      if (tpl) {
        return (tpl.content || '')
          .replaceAll('{{nome}}', nome)
          .replaceAll('{{documento}}', documento || '________________')
          .replaceAll('{{data}}', hoje);
      }
    }
    return '';
    }
  function refreshTexto() {
    const nome = docNome?.value || getMe().nome || '________________';
    const documento = docDoc?.value || '________________';
    if (docTexto) docTexto.value = modeloTexto(docTipo?.value, nome, documento);
  }
  docTipo?.addEventListener('change', () => {
    refreshTexto();
    fitDocTextarea();
  });
  [docNome, docDoc].forEach((e) => e?.addEventListener('input', refreshTexto));

  /* Altura dinâmica */
  function fitDocTextarea() {
    const ta = docTexto;
    if (!ta) return;
    const isMobile = window.innerWidth <= 960;
    if (isMobile) {
      const h = Math.max(180, Math.floor(window.innerHeight * 0.45));
      ta.style.height = h + 'px';
      ta.style.maxHeight = '60vh';
    } else {
      const rect = ta.getBoundingClientRect();
      const newH = Math.max(220, Math.floor(window.innerHeight - rect.top - 24));
      ta.style.height = newH + 'px';
      ta.style.maxHeight = '';
    }
    ta.classList.add('scroll-styled');
    ta.style.resize = 'vertical';
  }
  window.addEventListener('resize', fitDocTextarea);

  /* SignaturePad */
  let sigPad = null;
  function initSig() {
    if (!sigPadEl) return;
    const canvas = sigPadEl;
    function fit() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      if (sigPad) sigPad.clear();
    }
    window.addEventListener('resize', fit);
    fit();
    sigPad = new SignaturePad(canvas, { minWidth: 1.2, maxWidth: 2.5, penColor: '#eaf6ff', backgroundColor: 'rgba(0,0,0,0)' });
  }
  function resizeSigCanvas() {
    if (!sigPad) return;
    const canvas = sigPadEl;
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
    sigPad.clear();
  }
  setTimeout(initSig, 300);
  btnLimparAss?.addEventListener('click', () => sigPad && sigPad.clear());

  async function fileToDataURL(file) {
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }
  sigImport?.addEventListener('change', async (e) => {
    if (!sigPad || !e.target.files || !e.target.files[0]) return;
    const dataURL = await fileToDataURL(e.target.files[0]);
    try {
      sigPad.fromDataURL(dataURL, { ratio: 1, width: sigPadEl.offsetWidth, height: sigPadEl.offsetHeight });
    } catch {}
  });

  /* Layout (cabeçalho/rodapé) */
  const defaultLayout = () => ({
    headerTitle: '',
    headerAlign: 'left', // left|center|right
    footerText: '',
    pageNums: 'none', // none|p_de_n|p_simples
    headerLogo: 'auto' // auto|off
  });
  const getDocLayout = () => {
    try {
      return Object.assign(defaultLayout(), JSON.parse(localStorage.getItem(KEY_DOC_LAYOUT) || '{}'));
    } catch {
      return defaultLayout();
    }
  };
  const setDocLayout = (o) => localStorage.setItem(KEY_DOC_LAYOUT, JSON.stringify(o || {}));
  function applyLayoutToUI() {
    const l = getDocLayout();
    if (docHeaderTitle) docHeaderTitle.value = l.headerTitle || '';
    if (docHeaderAlign) docHeaderAlign.value = l.headerAlign || 'left';
    if (docFooterText) docFooterText.value = l.footerText || '';
    if (docPageNums) docPageNums.value = l.pageNums || 'none';
    if (docHeaderLogo) docHeaderLogo.value = l.headerLogo || 'auto';
  }
  function readLayoutFromUI() {
    return {
      headerTitle: docHeaderTitle?.value || '',
      headerAlign: docHeaderAlign?.value || 'left',
      footerText: docFooterText?.value || '',
      pageNums: docPageNums?.value || 'none',
      headerLogo: docHeaderLogo?.value || 'auto'
    };
  }
  btnSalvarLayoutDoc?.addEventListener('click', () => {
    setDocLayout(readLayoutFromUI());
    notify('Layout salvo como padrão.', 'success');
  });

  /* Gerar PDF assinado (com layout) */
  btnGerarPDF?.addEventListener('click', async (ev) => {
    ev.preventDefault();
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF não carregado.', 'error');

    const layout = Object.assign(getDocLayout(), readLayoutFromUI());

    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const margin = 56;
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const contentW = pageW - margin * 2;
    const lineH = 16;

    const mapTitle = {
      interesse: 'DECLARAÇÃO DE INTERESSE',
      anuencia: 'CARTA DE ANUÊNCIA',
      dividas: 'DECLARAÇÃO DE AUSÊNCIA DE DÍVIDAS'
    };
    const tituloBase =
      (mapTitle[docTipo?.value] || docTipo?.options?.[docTipo.selectedIndex]?.text || 'DOCUMENTO').toUpperCase();
    const tituloHeader = layout.headerTitle || tituloBase;

    const logo = layout.headerLogo !== 'off' ? await getCompanyLogoDataURL() : null;
    function drawHeader() {
      const yTop = 30;
      if (logo) {
        try {
          const fmtMatch = /^data:image\/(png|jpeg|jpg|webp)/i.exec(logo);
          doc.addImage(logo, (fmtMatch ? fmtMatch[1] : 'png').toUpperCase(), margin, yTop - 6, 80, 26);
        } catch {}
      }
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      let x = margin;
      if (layout.headerAlign === 'center') x = pageW / 2;
      if (layout.headerAlign === 'right') x = pageW - margin;
      doc.text(String(tituloHeader), x, yTop + 14, { align: layout.headerAlign });
      doc.setDrawColor(220);
      doc.line(margin, yTop + 22, pageW - margin, yTop + 22);
    }
    function drawFooter(page, pages) {
      const yBottom = pageH - 30;
      doc.setDrawColor(220);
      doc.line(margin, yBottom - 12, pageW - margin, yBottom - 12);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      let footer = layout.footerText || '';
      if (layout.pageNums === 'p_de_n') footer += (footer ? ' • ' : '') + `pág. ${page} de ${pages}`;
      if (layout.pageNums === 'p_simples') footer += (footer ? ' • ' : '') + `pág. ${page}`;
      doc.text(footer || '', margin, yBottom);
    }

    let y = 76;
    drawHeader();

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text(tituloBase, margin, y);
    y += 18;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);

    const paragraphs = String(docTexto?.value || '').split('\n');
    function ensureSpace(h) {
      if (y + h > pageH - 60) {
        doc.addPage();
        drawHeader();
        y = 76;
      }
    }
    for (const p of paragraphs) {
      const wrapped = doc.splitTextToSize(p || ' ', contentW);
      const arr = Array.isArray(wrapped) ? wrapped : [wrapped];
      for (const part of arr) {
        ensureSpace(lineH);
        doc.text(String(part), margin, y);
        y += lineH;
      }
      y += 4;
    }

    const nomeAss = docNome?.value || getMe().nome || '________________';
    ensureSpace(30);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Assinatura do colaborador:', margin, y);
    y += 10;

    if (sigPad && !sigPad.isEmpty()) {
      ensureSpace(90);
      const img = sigPad.toDataURL('image/png');
      doc.addImage(img, 'PNG', margin, y, 240, 80);
      y += 90;
    } else {
      ensureSpace(50);
      y += 50;
      doc.text('____________________________', margin, y);
      y += 14;
    }

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    ensureSpace(18);
    doc.text(nomeAss, margin, y);

    const pages = doc.getNumberOfPages();
    for (let p = 1; p <= pages; p++) {
      doc.setPage(p);
      drawFooter(p, pages);
    }

    const safe = (tituloBase || 'documento').replace(/\s+/g, '_').toLowerCase();
    doc.save(`${safe}.pdf`);
  });

  /* Importar modelos (.txt/.md/.json) e PDFs (conteúdo para docTexto) */
  (function handleTplImport() {
    if (!tplImport) return;

    async function readText(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ''));
        r.onerror = reject;
        r.readAsText(file, 'utf-8');
      });
    }
    async function readPDF(file) {
      const buf = await file.arrayBuffer();
      if (!window.pdfjsLib) throw new Error('PDF.js não carregado');
      const loadingTask = window.pdfjsLib.getDocument({ data: buf });
      const pdf = await loadingTask.promise;
      const parts = [];
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent({ normalizeWhitespace: true });
        const text = (content.items || [])
          .map((it) => it.str || '')
          .join(' ')
          .replace(/\s+\n/g, '\n')
          .trim();
        parts.push(text);
      }
      return parts.join('\n\n---\n\n');
    }
    function addTemplates(items) {
      if (!Array.isArray(items)) return 0;
      const list = getTemplates();
      let added = 0;
      for (const it of items) {
        const name = (it?.name || '').trim();
        const content = String(it?.content || '').trim();
        if (!name || !content) continue;
        let id = slugify(name),
          base = id,
          n = 1;
        while (list.some((t) => t.id === id)) {
          n++;
          id = base + '-' + n;
        }
        list.push({ id, name, content });
        added++;
      }
      if (added > 0) setTemplates(list);
      return added;
    }
    function inferNameFromFilename(fn) {
      return (fn || 'documento').replace(/\.[^.]+$/, '').replace(/[_\-]+/g, ' ').trim();
    }
    function populateCustomDocTypes() {
      const group = $('docCustomGroup');
      if (!group) return;
      const list = getTemplates();
      group.innerHTML = list.map((t) => `<option value="tpl:${t.id}">${t.name}</option>`).join('');

      const sel = $('tplManageSelect');
      if (sel) {
        const opts = [`<option value="">— Selecione um tipo personalizado —</option>`].concat(
          list.map((t) => `<option value="${t.id}">${t.name}</option>`)
        );
        sel.innerHTML = opts.join('');
      }
    }
    function setTipoAndRefresh(id) {
      if (docTipo) docTipo.value = 'tpl:' + id;
      refreshTexto();
    }

    tplImport.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      let totalAdded = 0;
      let firstNewId = null;
      const pdfTexts = [];

      for (const file of files) {
        try {
          const isPDF =
            /\.(pdf)$/i.test(file.name.trim()) || (String(file.type || '').toLowerCase() === 'application/pdf');
          if (isPDF) {
            try {
              const txt = await readPDF(file);
              if (txt && txt.trim()) pdfTexts.push(`# ${file.name}\n\n${txt.trim()}`);
            } catch {}
            continue;
          }

          const text = await readText(file);
          let addedNow = 0;

          if (/\.(json)$/i.test(file.name.trim()) || (file.type || '').includes('json')) {
            try {
              const data = JSON.parse(text);
              let arr = [];
              if (Array.isArray(data)) arr = data;
              else if (data && Array.isArray(data.templates)) arr = data.templates;
              else if (data && typeof data === 'object' && data.name && data.content) arr = [data];
              addedNow = addTemplates(arr);
              if (addedNow > 0 && !firstNewId) {
                const list = getTemplates();
                const last = list.slice(-addedNow);
                firstNewId = last[0]?.id || null;
              }
            } catch {}
          } else {
            const name = inferNameFromFilename(file.name);
            addedNow = addTemplates([{ name, content: text }]);
            if (addedNow > 0 && !firstNewId) {
              const list = getTemplates();
              const last = list.slice(-1)[0];
              firstNewId = last?.id || null;
            }
          }
          totalAdded += addedNow;
        } catch {}
      }

      if (pdfTexts.length > 0 && docTexto) {
        docTexto.value = pdfTexts.join('\n\n===== FIM DO ARQUIVO =====\n\n');
        notify(`${pdfTexts.length} PDF(s) importado(s) para o conteúdo.`, 'success');
        fitDocTextarea();
      }

      if (totalAdded > 0) {
        populateCustomDocTypes();
        if (firstNewId) setTipoAndRefresh(firstNewId);
        notify(`${totalAdded} modelo(s) importado(s) com sucesso!`, 'success');
      } else if (pdfTexts.length === 0) {
        notify('Não foi possível importar. Verifique o(s) arquivo(s).', 'error');
      }

      e.target.value = '';
    });

    /* Criar tipo manualmente */
    btnCriarTipoDoc?.addEventListener('click', () => {
      if (tplNome) tplNome.value = '';
      if (tplTexto) tplTexto.value = '';
      modalNovoDoc && (modalNovoDoc.style.display = 'flex');
    });
    btnCancelarNovoDoc?.addEventListener('click', () => (modalNovoDoc.style.display = 'none'));
    modalNovoDoc?.addEventListener('click', (e) => {
      if (e.target === modalNovoDoc) modalNovoDoc.style.display = 'none';
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') modalNovoDoc && (modalNovoDoc.style.display = 'none');
    });
    btnSalvarNovoDoc?.addEventListener('click', () => {
      const name = (tplNome?.value || '').trim();
      const content = (tplTexto?.value || '').trim();
      if (!name || !content) return notify('Preencha nome e conteúdo.', 'warn');
      let id = slugify(name);
      const list = getTemplates();
      let suffix = 1;
      const base = id;
      while (list.some((t) => t.id === id)) {
        suffix++;
        id = base + '-' + suffix;
      }
      list.push({ id, name, content });
      setTemplates(list);
      const group = $('docCustomGroup');
      if (group) group.insertAdjacentHTML('beforeend', `<option value="tpl:${id}">${name}</option>`);
      if (docTipo) docTipo.value = 'tpl:' + id;
      refreshTexto();
      modalNovoDoc && (modalNovoDoc.style.display = 'none');
      notify('Tipo salvo!', 'success');
    });

    /* Gerenciar (excluir) tipos personalizados */
    (function manageDelete() {
      const manageSelect = $('tplManageSelect');
      const btnExcluir = $('btnExcluirTipoDoc');
      function removeTemplateById(id) {
        const list = getTemplates();
        const idx = list.findIndex((t) => t.id === id);
        if (idx < 0) return false;
        list.splice(idx, 1);
        setTemplates(list);
        return true;
      }
      btnExcluir?.addEventListener('click', () => {
        const id = manageSelect?.value || '';
        if (!id) return notify('Selecione um tipo personalizado.', 'warn');
        const list = getTemplates();
        const tpl = list.find((t) => t.id === id);
        if (!tpl) return notify('Tipo não encontrado.', 'error');
        if (!confirm(`Excluir o tipo “${tpl.name}”?`)) return;
        const ok = removeTemplateById(id);
        if (ok) {
          if (docTipo?.value === 'tpl:' + id) {
            docTipo.value = 'interesse';
            refreshTexto();
          }
          // repopula
          const group = $('docCustomGroup');
          if (group) group.innerHTML = getTemplates().map((t) => `<option value="tpl:${t.id}">${t.name}</option>`).join('');
          const sel = $('tplManageSelect');
          if (sel) {
            sel.innerHTML =
              `<option value="">— Selecione um tipo personalizado —</option>` +
              getTemplates()
                .map((t) => `<option value="${t.id}">${t.name}</option>`)
                .join('');
          }
          notify('Tipo excluído.', 'success');
        } else notify('Falha ao excluir.', 'error');
      });
    })();
  })();

  /* ===================== FUNCIONÁRIOS ===================== */
  const funcionariosSeed = [
    { id: 'f1', nome: 'Luana Ferreira', idade: 28, funcao: 'Assistente de RH', cargo: 'Assistente de RH', salario: 3200, optVR: true, optVT: true, foto: '', ativo: true },
    { id: 'f2', nome: 'Bruno Martins', idade: 35, funcao: 'Engenheiro Civil', cargo: 'Engenheiro', salario: 6800, optVR: false, optVT: true, foto: '', ativo: true }
  ];
  function getFuncionariosLS() {
    let arr = JSON.parse(localStorage.getItem(LS_KEYS.FUNCS) || 'null');
    if (!Array.isArray(arr) || arr.length === 0) {
      arr = funcionariosSeed;
      localStorage.setItem(LS_KEYS.FUNCS, JSON.stringify(arr));
    }
    arr.forEach((f, i) => {
      if (!f.id) f.id = 'fid_' + i;
      if (typeof f.ativo === 'undefined') f.ativo = true;
      if (typeof f.cargo === 'undefined') f.cargo = f.funcao || '';
      if (typeof f.salario !== 'number') f.salario = 0;
      if (typeof f.optVR === 'undefined') f.optVR = false;
      if (typeof f.optVT === 'undefined') f.optVT = false;
    });
    localStorage.setItem(LS_KEYS.FUNCS, JSON.stringify(arr));
    return arr;
  }
  function setFuncionariosLS(arr) {
    localStorage.setItem(LS_KEYS.FUNCS, JSON.stringify(arr || []));
  }
  function defaultAvatarDataURL() {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#00E0FF"/><stop offset="1" stop-color="#FF2FB9"/></linearGradient></defs>
        <rect width="128" height="128" rx="24" fill="url(#g)" opacity="0.25"/>
        <circle cx="64" cy="50" r="22" fill="#cfe0ef"/>
        <rect x="24" y="78" width="80" height="34" rx="17" fill="#cfe0ef"/>
      </svg>`;
    return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
  }
  function photoOrFallback(url) {
    return url && url.trim() ? `<img class="emp-avatar" src="${url}" alt="">` : `<div class="emp-avatar"></div>`;
  }

  /* >>> NOVO: render com 3 pontinhos e dropdown */
  function renderFuncionarios(q = '') {
    if (!empGrid) return;
    const all = getFuncionariosLS();
    const term = q.trim().toLowerCase();
    const list = term ? all.filter((f) => f.nome.toLowerCase().includes(term)) : all;

    empGrid.innerHTML =
      list
        .map((f) => {
          const inactiveClass = f.ativo ? '' : 'inactive';
          const offBadge = f.ativo ? '' : `<span class="emp-badge-off">INATIVO</span>`;

          const menu = `
            <div class="emp-menu" data-id="${f.id}" title="Opções" aria-haspopup="menu" aria-expanded="false">
              <i class="fa-solid fa-ellipsis-vertical"></i>
            </div>
            <div class="emp-menu-dropdown" data-menu="${f.id}" role="menu">
              ${
                f.ativo
                  ? `
                    <button data-action="desativar" data-id="${f.id}">
                      <i class="fa-regular fa-circle-xmark"></i> Desativar
                    </button>
                  `
                  : `
                    <button data-action="ativar" data-id="${f.id}">
                      <i class="fa-regular fa-circle-check"></i> Ativar
                    </button>
                  `
              }
              <button class="danger" data-action="excluir" data-id="${f.id}">
                <i class="fa-solid fa-trash"></i> Excluir
              </button>
            </div>`;

          return `
            <div class="emp-card ${inactiveClass}" data-id="${f.id}">
              ${menu}
              ${offBadge}
              ${photoOrFallback(f.foto)}
              <div>
                <div class="emp-name">${f.nome}</div>
                <div class="emp-role">${f.funcao} • ${f.idade} anos</div>
              </div>
            </div>`;
        })
        .join('') || `<div style="color:#9fb1c3">Nenhum funcionário encontrado.</div>`;
  }
  renderFuncionarios();
  /* <<< FIM NOVO render */

  function syncSearchInputs(val) {
    try {
      if (typeof val !== 'string') val = '';
      if (funcSearch && funcSearch.value !== val) funcSearch.value = val;
      if (funcSearchGestao && funcSearchGestao.value !== val) funcSearchGestao.value = val;
    } catch {}
  }
  funcSearch?.addEventListener('input', (e) => {
    syncSearchInputs(e.target.value);
    renderFuncionarios(e.target.value);
  });
  funcClear?.addEventListener('click', () => {
    syncSearchInputs('');
    renderFuncionarios('');
  });
  funcSearchBtn?.addEventListener('click', () => renderFuncionarios(funcSearch?.value || ''));
  funcSearchGestao?.addEventListener('input', (e) => {
    syncSearchInputs(e.target.value);
    renderFuncionarios(e.target.value);
  });
  funcClearGestao?.addEventListener('click', () => {
    syncSearchInputs('');
    renderFuncionarios('');
  });
  funcSearchGestaoBtn?.addEventListener('click', () => renderFuncionarios(funcSearchGestao?.value || ''));

  /* Modal Funcionário (apenas Documentos Importantes) */
  let currentEmpId = null;

  /* >>> NOVO: alternância das abas dentro do modal */
  modalFuncionario?.addEventListener('click', (e) => {
    const btn = e.target.closest('.emp-tab-btn');
    if (!btn) return;
    e.preventDefault();

    // Botões
    document.querySelectorAll('#modalFuncionario .emp-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Panes
    document.querySelectorAll('#modalFuncionario .emp-pane').forEach(p => p.classList.remove('active'));
    const targetSel = btn.getAttribute('data-target');
    const pane = document.querySelector(targetSel);
    if (pane) pane.classList.add('active');

    // Sempre recarregar tabela quando entra em "Documentos importantes"
    if (targetSel === '#paneDocsImportantes') {
      renderImpDocsTable();
    }
  });
  /* <<< FIM novo listener de abas */

  function openFuncionario(empId) {
    const all = getFuncionariosLS();
    const f = all.find((x) => x.id === empId);
    if (!f) return;
    currentEmpId = f.id;
    if (funcModalNome) funcModalNome.textContent = f.nome;
    if (funcModalFuncao) funcModalFuncao.textContent = `${f.funcao} • ${f.idade} anos`;
    if (funcModalAvatar) funcModalAvatar.src = f.foto || defaultAvatarDataURL();

    /* >>> NOVO: força abrir na aba "Documentos importantes" */
    document.querySelectorAll('#modalFuncionario .emp-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('#modalFuncionario .emp-pane').forEach(p => p.classList.remove('active'));
    $('btnTabDocsImportantes')?.classList.add('active');
    $('paneDocsImportantes')?.classList.add('active');
    /* <<< */

    modalFuncionario && (modalFuncionario.style.display = 'flex');
    renderImpDocsTable();
  }
  function closeFuncionario() {
    modalFuncionario && (modalFuncionario.style.display = 'none');
  }
  fecharFuncionario?.addEventListener('click', closeFuncionario);

  /* >>> NOVO: gerenciamento do menu de 3 pontinhos e ações */
  function closeAllEmpMenus() {
    document.querySelectorAll('.emp-menu-dropdown.open').forEach((el) => el.classList.remove('open'));
    document.querySelectorAll('.emp-menu[aria-expanded="true"]').forEach((el) => el.setAttribute('aria-expanded', 'false'));
  }
  function toggleEmpMenu(id) {
    const dd = document.querySelector(`.emp-menu-dropdown[data-menu="${id}"]`);
    const btn = document.querySelector(`.emp-menu[data-id="${id}"]`);
    if (!dd || !btn) return;
    const willOpen = !dd.classList.contains('open');
    closeAllEmpMenus();
    if (willOpen) {
      dd.classList.add('open');
      btn.setAttribute('aria-expanded', 'true');
    }
  }
  function setFuncionarioAtivo(id, ativo) {
    const arr = getFuncionariosLS();
    const idx = arr.findIndex((f) => f.id === id);
    if (idx < 0) return;
    arr[idx].ativo = !!ativo;
    setFuncionariosLS(arr);
    notify(ativo ? 'Funcionário ativado.' : 'Funcionário desativado.', 'success');
    renderFuncionarios(funcSearch?.value || '');
    renderVT();
    renderVR();
  }
  function excluirFuncionario(id) {
    const arr = getFuncionariosLS();
    const f = arr.find((x) => x.id === id);
    if (!f) return;
    if (!confirm(`Excluir definitivamente “${f.nome}”?`)) return;

    const novo = arr.filter((x) => x.id !== id);
    setFuncionariosLS(novo);

    // Limpa vínculos
    try {
      const vrMap = getVRMap(); delete vrMap[id]; setVRMap(vrMap);
      const vtMap = getVTMap(); delete vtMap[id]; setVTMap(vtMap);
      const imp = getImpDocsMap(); delete imp[id]; setImpDocsMap(imp);
      const alerts = getAlerts().filter(a => a.empId !== id); setAlerts(alerts);
      updateNotifDot();
    } catch {}

    if (currentEmpId === id) {
      currentEmpId = null;
      modalFuncionario && (modalFuncionario.style.display = 'none');
    }

    notify('Funcionário excluído.', 'success');
    renderFuncionarios(funcSearch?.value || '');
    renderVT();
    renderVR();
  }

  empGrid?.addEventListener('click', (e) => {
    const onMenuBtn = e.target.closest('.emp-menu');
    const onMenuDD  = e.target.closest('.emp-menu-dropdown');
    const onAction  = e.target.closest('.emp-menu-dropdown [data-action]');

    // Clique nos 3 pontinhos
    if (onMenuBtn) {
      e.stopPropagation();
      const id = onMenuBtn.getAttribute('data-id');
      toggleEmpMenu(id);
      return;
    }

    // Clique dentro do dropdown (sem ação)
    if (onMenuDD && !onAction) {
      e.stopPropagation();
      return;
    }

    // Ações do dropdown
    if (onAction) {
      e.stopPropagation();
      const act = onAction.getAttribute('data-action');
      const id = onAction.getAttribute('data-id');
      if (act === 'desativar') setFuncionarioAtivo(id, false);
      if (act === 'ativar')    setFuncionarioAtivo(id, true);
      if (act === 'excluir')   excluirFuncionario(id);
      closeAllEmpMenus();
      return;
    }

    // Clique no card (fora do menu) -> abre modal
    const card = e.target.closest('.emp-card');
    if (!card) return;
    const id = card.getAttribute('data-id');
    if (id) openFuncionario(id);
  });

  // Fechar menus clicando fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.emp-menu') && !e.target.closest('.emp-menu-dropdown')) {
      closeAllEmpMenus();
    }
  });
  /* <<< FIM NOVO bloco de menus */

  /* Documentos Importantes (por funcionário) + Alertas */
  async function fileToDataURL_imp(file) {
    return fileToDataURL(file);
  }
  function renderImpDocsTable() {
    if (!impDocsTable) return;
    const map = getImpDocsMap();
    const list = map[currentEmpId] || [];
    if (!list.length) {
      impDocsTable.innerHTML = `<tr><td colspan="5" style="color:#9fb1c3">Nenhum documento importante.</td></tr>`;
      return;
    }
    impDocsTable.innerHTML = list
      .map((d, idx) => {
        const issue = d.issue ? new Date(d.issue + 'T00:00:00') : null;
        const due = d.due ? new Date(d.due + 'T00:00:00') : null;
        const issueLabel = issue ? `${two(issue.getDate())}/${two(issue.getMonth() + 1)}/${issue.getFullYear()}` : '—';
        const dueLabel = due ? `${two(due.getDate())}/${two(due.getMonth() + 1)}/${due.getFullYear()}` : '—';
        const bellIcon = d.subscribed ? 'fa-solid fa-bell' : 'fa-regular fa-bell';
        const bellTitle = d.subscribed ? 'Lembrete ativado' : 'Ativar lembrete';
        return `<tr>
          <td style="text-align:left">${escapeHTML(d.name || '(sem nome)')}</td>
          <td>${escapeHTML(d.type || '—')}</td>
          <td>${issueLabel}</td>
          <td>${dueLabel}</td>
          <td>
            ${d.dataURL ? `<a class="btn btn-light" href="${d.dataURL}" download="${encodeURIComponent(d.name || 'documento')}" target="_blank"><i class="fa-solid fa-download"></i> Baixar</a>` : ''}
            <button class="btn btn-light" data-imp-sub="${idx}" title="${bellTitle}">
              <i class="${bellIcon}"></i>
            </button>
            <button class="btn btn-ghost" data-imp-del="${idx}"><i class="fa-solid fa-trash"></i> Excluir</button>
          </td>
        </tr>`;
      })
      .join('');
  }
  btnAddImpDoc?.addEventListener('click', async () => {
    if (!currentEmpId) return notify('Abra um funcionário primeiro.', 'warn');
    const file = impDocFile?.files?.[0] || null;
    const name = (impDocName?.value || '').trim();
    const type = (impDocType?.value || '').trim();
    const issue = (impDocIssue?.value || '').trim();
    const due = (impDocDue?.value || '').trim();
    if (!file) return notify('Selecione um arquivo.', 'warn');
    if (!name) return notify('Informe o nome do documento.', 'warn');
    if (!type) return notify('Informe o tipo do documento.', 'warn');
    if (!issue) return notify('Informe a data de emissão.', 'warn');
    if (!due) return notify('Informe a data de validade.', 'warn');

    let dataURL = '';
    try {
      dataURL = await fileToDataURL_imp(file);
    } catch {}
    const map = getImpDocsMap();
    map[currentEmpId] = map[currentEmpId] || [];
    const id = uid('doc');
    map[currentEmpId].push({
      id,
      name,
      type,
      issue,
      due,
      uploadedAt: new Date().toISOString(),
      size: file.size || 0,
      dataURL,
      subscribed: false
    });
    setImpDocsMap(map);

    // limpa
    if (impDocFile) impDocFile.value = '';
    if (impDocName) impDocName.value = '';
    if (impDocType) impDocType.value = '';
    if (impDocIssue) impDocIssue.value = '';
    if (impDocDue) impDocDue.value = '';

    renderImpDocsTable();
    notify('Documento importante adicionado.', 'success');
    checkImportantDocExpirations(); // atualiza alertas
  });
  impDocsTable?.addEventListener('click', (e) => {
    const del = e.target.closest('[data-imp-del]');
    const sub = e.target.closest('[data-imp-sub]');
    const map = getImpDocsMap();
    const list = map[currentEmpId] || [];

    if (del) {
      const idx = Number(del.getAttribute('data-imp-del'));
      if (!Number.isFinite(idx)) return;
      if (!confirm('Excluir este documento importante?')) return;
      list.splice(idx, 1);
      map[currentEmpId] = list;
      setImpDocsMap(map);
      renderImpDocsTable();
      notify('Documento excluído.', 'success');
      checkImportantDocExpirations();
    }
    if (sub) {
      const idx = Number(sub.getAttribute('data-imp-sub'));
      if (!Number.isFinite(idx)) return;
      const item = list[idx];
      item.subscribed = !item.subscribed;
      map[currentEmpId] = list;
      setImpDocsMap(map);
      renderImpDocsTable();

      if (item.subscribed) {
        const alerts = getAlerts();
        alerts.push({
          id: uid('al'),
          refKey: `sub|${currentEmpId}|${item.id}`,
          type: 'subscription',
          empId: currentEmpId,
          empNome: funcModalNome?.textContent || '',
          docName: item.name,
          due: item.due,
          createdAt: new Date().toISOString(),
          unread: true,
          status: 'Lembrete salvo'
        });
        setAlerts(alerts);
        updateNotifDot();
        notify('Lembrete ativado para este documento.', 'success');
        checkImportantDocExpirations();
      } else {
        notify('Lembrete desativado para este documento.', 'info');
      }
    }
  });

  /* Alertas */
  function updateNotifDot() {
    if (!notifDot) return;
    const anyUnread = getAlerts().some((a) => a.unread);
    if (anyUnread) notifDot.removeAttribute('hidden');
    else notifDot.setAttribute('hidden', '');
  }
  function checkImportantDocExpirations() {
    const map = getImpDocsMap();
    const allAlerts = getAlerts();
    const today = new Date();
    const soonDays = 7;
    const soonMs = soonDays * 24 * 3600 * 1000;

    function addAlertUnique(refKey, payload) {
      if (allAlerts.some((a) => a.refKey === refKey)) return;
      allAlerts.push({ id: uid('al'), unread: true, createdAt: new Date().toISOString(), ...payload, refKey });
    }

    Object.entries(map).forEach(([empId, docs]) => {
      const emp = getFuncionariosLS().find((f) => f.id === empId);
      const empNome = emp?.nome || 'Funcionário';
      docs.forEach((d) => {
        if (!d.due) return;
        const due = new Date(d.due + 'T00:00:00');
        const diff = due - today;
        const isOver = diff < 0;
        const isSoon = diff >= 0 && diff <= soonMs;

        if (isOver) {
          addAlertUnique(`over|${empId}|${d.id}`, {
            type: 'due_over',
            empId,
            empNome,
            docName: d.name,
            due: d.due,
            status: 'Vencido'
          });
        } else if (isSoon) {
          addAlertUnique(`soon|${empId}|${d.id}`, {
            type: 'due_soon',
            empId,
            empNome,
            docName: d.name,
            due: d.due,
            status: `Vence em até ${soonDays} dias`
          });
        }
      });
    });

    setAlerts(allAlerts);
    updateNotifDot();
  }
  function renderAlertsTable() {
    if (!alertsTable) return;
    const list = getAlerts().sort((a, b) => (a.createdAt < b.createdAt ? 1 : -1));
    alertsTable.innerHTML =
      list.length === 0
        ? `<tr><td colspan="5">Sem lembretes.</td></tr>`
        : list
            .map((al) => {
              const status =
                al.status ||
                (al.type === 'due_over'
                  ? 'Vencido'
                  : al.type === 'due_soon'
                  ? 'Próximo de vencer'
                  : 'Lembrete');
              const cls =
                al.type === 'due_over' ? 'err' : al.type === 'due_soon' ? 'warn' : al.unread ? 'info' : 'ok';
              return `<tr>
                <td>${escapeHTML(al.empNome || '—')}</td>
                <td>${escapeHTML(al.docName || '—')}</td>
                <td>${al.due ? al.due.split('-').reverse().join('/') : '—'}</td>
                <td><span class="status-dot ${cls}"></span> ${escapeHTML(status)}</td>
                <td>
                  <button class="btn btn-light" data-alert-read="${al.id}">${al.unread ? 'Marcar como lido' : 'Lido'}</button>
                </td>
              </tr>`;
            })
            .join('');
  }
  btnAlerts?.addEventListener('click', () => {
    renderAlertsTable();
    modalAlerts && (modalAlerts.style.display = 'flex');
  });
  btnCloseAlerts?.addEventListener('click', () => (modalAlerts.style.display = 'none'));
  alertsTable?.addEventListener('click', (e) => {
    const b = e.target.closest('[data-alert-read]');
    if (!b) return;
    const id = b.getAttribute('data-alert-read');
    const list = getAlerts();
    const idx = list.findIndex((x) => x.id === id);
    if (idx >= 0) {
      list[idx].unread = false;
      setAlerts(list);
      renderAlertsTable();
      updateNotifDot();
    }
  });

  /* ===================== CADASTRO (modal) ===================== */
  (function mountCadastroModal() {
    const cadWrap = document.querySelector('.gestao-cadastro-wrap');
    const cadBox = cadWrap ? cadWrap.querySelector('.gestao-cadastro') : null;

    function openModal() {
      if (cadBox && modalCadastroBody && cadBox.parentElement !== modalCadastroBody) {
        modalCadastroBody.appendChild(cadBox);
      }
      modalCadastroUsuario && (modalCadastroUsuario.style.display = 'flex');
    }
    function closeModal() {
      if (cadWrap && cadBox && cadBox.parentElement !== cadWrap) cadWrap.appendChild(cadBox);
      modalCadastroUsuario && (modalCadastroUsuario.style.display = 'none');
    }
    btnAbrirCadastro?.addEventListener('click', openModal);
    btnFecharCadastro?.addEventListener('click', closeModal);
    modalCadastroUsuario?.addEventListener('click', (e) => {
      if (e.target === modalCadastroUsuario) closeModal();
    });
    document.addEventListener('keydown', (e) => e.key === 'Escape' && closeModal());
  })();

  cadFoto?.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) {
      if (cadFotoPreview) cadFotoPreview.src = '';
      return;
    }
    const dataURL = await fileToDataURL(f);
    if (cadFotoPreview) cadFotoPreview.src = dataURL;
  });

  btnSalvarCadastro?.addEventListener('click', async () => {
    const nome = (cadNome?.value || '').trim();
    const funcao = (cadFuncao?.value || '').trim();
    if (!nome || !funcao) return notify('Nome e Função são obrigatórios.', 'warn');

    const rg = (cadRG?.value || '').trim();
    const cpf = (cadCPF?.value || '').trim();
    const idade = parseInt((cadIdade?.value || '0').trim(), 10) || 0;
    const cargo = cadCargo ? (cadCargo.value || '').trim() : funcao;
    const salario = parseFloat(String(cadSalario?.value || '0').replace(',', '.')) || 0;

    const optVR = !!cadOptVR?.checked;
    const optVT = !!cadOptVT?.checked;

    const vtUnitV = parseFloat(String(cadVtUnit?.value || '').replace(',', '.'));
    const vrDailyV = parseFloat(String(cadVrDaily?.value || '').replace(',', '.'));

    let foto = '';
    if (cadFoto?.files?.[0]) {
      try {
        foto = await fileToDataURL(cadFoto.files[0]);
      } catch {}
    }

    const arr = getFuncionariosLS();
    const id = 'fid_' + Date.now();
    arr.push({
      id,
      nome,
      funcao,
      rg,
      cpf,
      idade,
      cargo,
      salario,
      optVR,
      optVT,
      foto,
      ativo: true
    });
    setFuncionariosLS(arr);

    /* VR/VT maps */
    try {
      const vrMap = getVRMap();
      vrMap[id] = Object.assign({ enabled: optVR, sal: salario }, vrMap[id] || {});
      if (Number.isFinite(vrDailyV)) vrMap[id].daily = vrDailyV;
      setVRMap(vrMap);

      const vtMap = getVTMap();
      vtMap[id] = Object.assign({ enabled: optVT }, vtMap[id] || {});
      if (Number.isFinite(vtUnitV)) vtMap[id].unit = vtUnitV;
      setVTMap(vtMap);
    } catch {}

    /* documento anexo */
    if (cadDocumento?.files?.[0]) {
      try {
        const file = cadDocumento.files[0];
        const dataURL = await fileToDataURL(file);
        const imp = getImpDocsMap();
        imp[id] = imp[id] || [];
        imp[id].push({
          id: uid('doc'),
          name: file.name,
          type: 'Outros',
          issue: '',
          due: '',
          uploadedAt: new Date().toISOString(),
          size: file.size || 0,
          dataURL,
          subscribed: false
        });
        setImpDocsMap(imp);
      } catch {}
    }

    notify('Funcionário cadastrado!', 'success');

    /* limpar */
    [cadNome, cadFuncao, cadRG, cadCPF, cadIdade, cadCargo, cadSalario, cadAdmissao, cadVtUnit, cadVrDaily].forEach(
      (el) => el && (el.value = '')
    );
    if (cadDocumento) cadDocumento.value = '';
    if (cadFoto) cadFoto.value = '';
    if (cadFotoPreview) cadFotoPreview.src = '';
    if (cadOptVR) cadOptVR.checked = false;
    if (cadOptVT) cadOptVT.checked = false;

    renderFuncionarios(funcSearchGestao ? funcSearchGestao.value : '');
    renderVT();
    renderVR();
  });

  btnLimparCadastro?.addEventListener('click', () => {
    [cadNome, cadFuncao, cadRG, cadCPF, cadIdade, cadCargo, cadSalario, cadAdmissao, cadVtUnit, cadVrDaily].forEach(
      (el) => el && (el.value = '')
    );
    if (cadDocumento) cadDocumento.value = '';
    if (cadFoto) cadFoto.value = '';
    if (cadFotoPreview) cadFotoPreview.src = '';
    if (cadOptVR) cadOptVR.checked = false;
    if (cadOptVT) cadOptVT.checked = false;
  });

  /* ===================== BENEFÍCIOS: VT ===================== */
  function getVTSettings() {
    const def = { unit: 5.0, creditDay: 5 };
    try {
      const s = JSON.parse(localStorage.getItem(KEY_VT_SETTINGS) || 'null');
      return Object.assign({}, def, s || {});
    } catch {
      return def;
    }
  }
  function setVTSettings(o) {
    localStorage.setItem(KEY_VT_SETTINGS, JSON.stringify(o || {}));
  }
  function getVTMap() {
    try {
      return JSON.parse(localStorage.getItem(KEY_VT_MAP) || '{}');
    } catch {
      return {};
    }
  }
  function setVTMap(map) {
    localStorage.setItem(KEY_VT_MAP, JSON.stringify(map || {}));
  }
  const brl = (n) => (isFinite(n) ? n : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  function clampDay(y, m, day) {
    const last = new Date(y, m + 1, 0).getDate();
    return Math.min(Math.max(1, day), last);
  }
  function nextDateForDay(day, ref = new Date()) {
    const d = new Date(ref.getFullYear(), ref.getMonth(), clampDay(ref.getFullYear(), ref.getMonth(), day));
    if (d <= ref) {
      const y = ref.getFullYear(),
        m = ref.getMonth() + 1;
      return new Date(y, m, clampDay(y, m, day));
    }
    return d;
  }

  function renderVT() {
    if (!vtBody) return;
    const s = getVTSettings();
    if (vtUnit) vtUnit.value = Number(s.unit || 0).toFixed(2);
    if (vtCreditDay) vtCreditDay.value = s.creditDay || 1;

    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVTMap();

    let totalEnabled = 0,
      totalQtd = 0,
      totalValor = 0;

    if (emps.length === 0) {
      vtBody.innerHTML = `<tr><td colspan="7" style="color:#9fb1c3">Não há funcionários ativos.</td></tr>`;
    } else {
      vtBody.innerHTML = emps
        .map((f) => {
          const c = conf[f.id] || {};
          const enabled = typeof c.enabled === 'boolean' ? c.enabled : !!f.optVT;
          const qty = Number.isFinite(c.qty) ? c.qty : 44;
          const unit = Number.isFinite(c.unit) ? c.unit : s.unit;
          const day = Number.isFinite(c.day) ? c.day : s.creditDay;
          const next = nextDateForDay(day, new Date());
          const valor = enabled ? qty * unit : 0;

          if (enabled) {
            totalEnabled++;
            totalQtd += qty;
            totalValor += valor;
          }
          const rowClass = enabled ? 'vt-on' : 'vt-off';
          return `<tr class="${rowClass}">
            <td><input type="checkbox" disabled ${enabled ? 'checked' : ''}></td>
            <td class="vt-cell-left">${f.nome}</td>
            <td><input type="number" value="${qty}" disabled></td>
            <td><input type="number" value="${Number(unit || 0).toFixed(2)}" disabled></td>
            <td><input type="number" value="${day}" disabled></td>
            <td>${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}</td>
            <td><strong>${brl(valor)}</strong></td>
          </tr>`;
        })
        .join('');
    }
    if (vtKColab) vtKColab.textContent = String(totalEnabled);
    if (vtKQtd) vtKQtd.textContent = String(totalQtd);
    if (vtKValor) vtKValor.textContent = brl(totalValor);
    if (vtSumQtd) vtSumQtd.textContent = String(totalQtd);
    if (vtSumValor) vtSumValor.textContent = brl(totalValor);
  }
  vtUnit?.addEventListener('input', (e) => {
    let v = parseFloat(String(e.target.value).replace(',', '.'));
    if (!isFinite(v) || v < 0) v = 0;
    const s = getVTSettings();
    s.unit = v;
    setVTSettings(s);
    renderVT();
  });
  vtCreditDay?.addEventListener('input', (e) => {
    let d = parseInt(e.target.value, 10);
    if (!isFinite(d) || d < 1) d = 1;
    if (d > 31) d = 31;
    const s = getVTSettings();
    s.creditDay = d;
    setVTSettings(s);
    renderVT();
  });

  btnExportVTCSV?.addEventListener('click', () => {
    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVTMap();
    const s = getVTSettings();
    const rows = [['Ativo', 'Funcionário', 'Qtd VT/mês', 'Tarifa (R$)', 'Dia crédito', 'Próximo crédito', 'Valor (R$)']];
    emps.forEach((f) => {
      const c = conf[f.id] || {};
      const enabled = typeof c.enabled === 'boolean' ? c.enabled : !!f.optVT;
      const qty = Number.isFinite(c.qty) ? c.qty : 44;
      const unit = Number.isFinite(c.unit) ? c.unit : s.unit;
      const day = Number.isFinite(c.day) ? c.day : s.creditDay;
      const next = nextDateForDay(day, new Date());
      const valor = enabled ? qty * unit : 0;
      rows.push([
        enabled ? 'SIM' : 'NÃO',
        f.nome,
        qty,
        unit.toFixed(2).replace('.', ','),
        day,
        `${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}`,
        valor.toFixed(2).replace('.', ',')
      ]);
    });
    const csv = rows.map((r) => r.map((x) => `"${String(x).replace(/"/g, '""')}"`).join(';')).join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'vale_transporte.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    notify('CSV do VT exportado.', 'success');
  });
  btnExportVTPDF?.addEventListener('click', () => {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF não carregado.', 'error');
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const mx = 28;
    let y = 36;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('Relatório — Vale Transporte', mx, y);
    y += 16;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(new Date().toLocaleString('pt-BR'), mx, y);
    y += 10;

    const headers = ['Ativo', 'Funcionário', 'Qtd', 'Tarifa', 'Dia', 'Próx. Crédito', 'Valor'];
    const widths = [46, 190, 40, 60, 36, 110, 60];

    function drawHeader() {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      let x = mx;
      headers.forEach((h, i) => {
        doc.text(h, x + 4, y + 12);
        x += widths[i];
      });
      doc.setDrawColor(180);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;
      doc.setFont('helvetica', 'normal');
    }
    drawHeader();

    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVTMap();
    const s = getVTSettings();

    let totQtd = 0,
      totVal = 0;
    for (const f of emps) {
      const c = conf[f.id] || {};
      const enabled = typeof c.enabled === 'boolean' ? c.enabled : !!f.optVT;
      const qty = Number.isFinite(c.qty) ? c.qty : 44;
      const unit = Number.isFinite(c.unit) ? c.unit : s.unit;
      const day = Number.isFinite(c.day) ? c.day : s.creditDay;
      const next = nextDateForDay(day, new Date());
      const valor = enabled ? qty * unit : 0;

      if (y > 770) {
        doc.addPage();
        y = 36;
        drawHeader();
      }

      let x = mx;
      const cells = [
        enabled ? 'SIM' : 'NÃO',
        f.nome,
        String(qty),
        'R$ ' + unit.toFixed(2).replace('.', ','),
        String(day),
        `${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}`,
        'R$ ' + valor.toFixed(2).replace('.', ',')
      ];
      widths.forEach((w, i) => {
        doc.text(String(cells[i]), x + 4, y + 12);
        x += w;
      });
      doc.setDrawColor(230);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;

      if (enabled) {
        totQtd += qty;
        totVal += valor;
      }
    }

    y += 8;
    doc.setFont('helvetica', 'bold');
    doc.text('Totais:', mx, y);
    doc.setFont('helvetica', 'normal');
    doc.text(`Qtd VT/mês: ${totQtd}`, mx + 60, y);
    doc.text(`Valor total: R$ ${totVal.toFixed(2).replace('.', ',')}`, mx + 180, y);

    doc.save('vale_transporte.pdf');
    notify('PDF do VT exportado.', 'success');
  });

  /* seed VT map, se vazio */
  (function seedVT() {
    const map = getVTMap();
    if (Object.keys(map).length > 0) return;
    const emps = getFuncionariosLS().filter((f) => f.ativo);
    const s = getVTSettings();
    const m = {};
    emps.forEach((f) => (m[f.id] = { enabled: !!f.optVT, qty: 44, unit: s.unit, day: s.creditDay }));
    setVTMap(m);
  })();

  /* ===================== BENEFÍCIOS: VR ===================== */
  function getVRSettings() {
    const def = { daily: 25.0, days: 22, pct: 6.0, creditDay: 5, cap: true };
    try {
      const s = JSON.parse(localStorage.getItem(KEY_VR_SETTINGS) || 'null');
      return Object.assign({}, def, s || {});
    } catch {
      return def;
    }
  }
  function setVRSettings(o) {
    localStorage.setItem(KEY_VR_SETTINGS, JSON.stringify(o || {}));
  }
  function getVRMap() {
    try {
      return JSON.parse(localStorage.getItem(KEY_VR_MAP) || '{}');
    } catch {
      return {};
    }
  }
  function setVRMap(map) {
    localStorage.setItem(KEY_VR_MAP, JSON.stringify(map || {}));
  }

  function renderVR() {
    if (!vrBody) return;
    const s = getVRSettings();

    if (vrDaily) vrDaily.value = Number(s.daily || 0).toFixed(2);
    if (vrDays) vrDays.value = Number(s.days || 0);
    if (vrPct) vrPct.value = Number(s.pct || 0).toFixed(2);
    if (vrCreditDay) vrCreditDay.value = Number(s.creditDay || 1);
    if (vrCapDiscount) vrCapDiscount.checked = !!s.cap;

    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVRMap();

    let adesoes = 0,
      totBenef = 0,
      totDesc = 0,
      totLiq = 0;

    if (emps.length === 0) {
      vrBody.innerHTML = `<tr><td colspan="10" style="color:#9fb1c3">Não há funcionários ativos.</td></tr>`;
    } else {
      vrBody.innerHTML = emps
        .map((f) => {
          const c = conf[f.id] || {};
          const enabled = 'enabled' in c ? !!c.enabled : !!f.optVR;
          const salario = isFinite(c.sal) ? Number(c.sal) : Number(f.salario || 0);
          const daily = isFinite(c.daily) ? Number(c.daily) : s.daily;
          const days = Number.isFinite(c.days) ? Number(c.days) : s.days;
          const pct = Number.isFinite(c.pct) ? Number(c.pct) : s.pct;
          const creditD = Number.isFinite(c.day) ? Number(c.day) : s.creditDay;
          const next = nextDateForDay(creditD, new Date());

          const beneficio = enabled ? daily * days : 0;
          let desconto = enabled ? salario * (pct / 100) : 0;
          if (s.cap) desconto = Math.min(desconto, beneficio);
          const liquido = enabled ? beneficio - desconto : 0;

          if (enabled) {
            adesoes++;
            totBenef += beneficio;
            totDesc += desconto;
            totLiq += liquido;
          }

          const rowClass = enabled ? 'vr-on' : 'vr-off';
          return `<tr class="${rowClass}">
            <td><input type="checkbox" data-emp="${f.id}" data-field="enabled" ${enabled ? 'checked' : ''}></td>
            <td class="vr-cell-left">${f.nome}</td>
            <td><input type="number" min="0" step="0.01" data-emp="${f.id}" data-field="sal" value="${salario || 0}"></td>
            <td><input type="number" min="0" step="0.01" data-emp="${f.id}" data-field="daily" value="${Number(daily || 0).toFixed(2)}"></td>
            <td><input type="number" min="0" max="31" step="1" data-emp="${f.id}" data-field="days" value="${days}"></td>
            <td><input type="number" min="1" max="31" step="1" data-emp="${f.id}" data-field="day" value="${creditD}"></td>
            <td>${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}</td>
            <td class="vr-money">${brl(beneficio)}</td>
            <td class="vr-money">${brl(desconto)}</td>
            <td class="vr-money">${brl(liquido)}</td>
          </tr>`;
        })
        .join('');
    }

    if (vrKAdesoes) vrKAdesoes.textContent = String(adesoes);
    if (vrKBeneficio) vrKBeneficio.textContent = brl(totBenef);
    if (vrKDesconto) vrKDesconto.textContent = brl(totDesc);
    if (vrKLiquido) vrKLiquido.textContent = brl(totLiq);
    if (vrSumBeneficio) vrSumBeneficio.textContent = brl(totBenef);
    if (vrSumDesconto) vrSumDesconto.textContent = brl(totDesc);
    if (vrSumLiquido) vrSumLiquido.textContent = brl(totLiq);
  }
  vrDaily?.addEventListener('input', (e) => {
    let v = parseFloat(String(e.target.value).replace(',', '.'));
    if (!isFinite(v) || v < 0) v = 0;
    const s = getVRSettings();
    s.daily = v;
    setVRSettings(s);
    renderVR();
  });
  vrDays?.addEventListener('input', (e) => {
    let d = parseInt(e.target.value, 10);
    if (!isFinite(d) || d < 0) d = 0;
    if (d > 31) d = 31;
    const s = getVRSettings();
    s.days = d;
    setVRSettings(s);
    renderVR();
  });
  vrPct?.addEventListener('input', (e) => {
    let p = parseFloat(String(e.target.value).replace(',', '.'));
    if (!isFinite(p) || p < 0) p = 0;
    if (p > 100) p = 100;
    const s = getVRSettings();
    s.pct = p;
    setVRSettings(s);
    renderVR();
  });
  vrCreditDay?.addEventListener('input', (e) => {
    let d = parseInt(e.target.value, 10);
    if (!isFinite(d) || d < 1) d = 1;
    if (d > 31) d = 31;
    const s = getVRSettings();
    s.creditDay = d;
    setVRSettings(s);
    renderVR();
  });
  vrCapDiscount?.addEventListener('change', (e) => {
    const s = getVRSettings();
    s.cap = !!e.target.checked;
    setVRSettings(s);
    renderVR();
  });
  vrBody?.addEventListener('input', (e) => {
    const el = e.target;
    const id = el.getAttribute('data-emp');
    const field = el.getAttribute('data-field');
    if (!id || !field) return;

    const map = getVRMap();
    map[id] = map[id] || { enabled: false, sal: 0, daily: null, days: null, pct: null, day: null };

    if (field === 'enabled') map[id].enabled = !!el.checked;
    else if (field === 'sal') {
      let v = parseFloat(String(el.value).replace(',', '.'));
      if (!isFinite(v) || v < 0) v = 0;
      map[id].sal = v;
    } else if (field === 'daily') {
      let v = parseFloat(String(el.value).replace(',', '.'));
      if (!isFinite(v) || v < 0) v = 0;
      map[id].daily = v;
    } else if (field === 'days') {
      let v = parseInt(el.value, 10);
      if (!isFinite(v) || v < 0) v = 0;
      if (v > 31) v = 31;
      map[id].days = v;
    } else if (field === 'pct') {
      let v = parseFloat(String(el.value).replace(',', '.'));
      if (!isFinite(v) || v < 0) v = 0;
      if (v > 100) v = 100;
      map[id].pct = v;
    } else if (field === 'day') {
      let v = parseInt(el.value, 10);
      if (!isFinite(v) || v < 1) v = 1;
      if (v > 31) v = 31;
      map[id].day = v;
    }
    setVRMap(map);
    renderVR();
  });

  (function seedVR() {
    const map = getVRMap();
    if (Object.keys(map).length > 0) return;
    const emps = getFuncionariosLS().filter((f) => f.ativo);
    const s = getVRSettings();
    const m = {};
    emps.forEach((f) => {
      m[f.id] = {
        enabled: !!f.optVR,
        sal: Number(f.salario || 0),
        daily: s.daily,
        days: s.days,
        pct: s.pct,
        day: s.creditDay
      };
    });
    setVRMap(m);
  })();

  function collectVRRows() {
    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVRMap();
    const s = getVRSettings();

    const rows = [];
    let adesoes = 0,
      totBenef = 0,
      totDesc = 0,
      totLiq = 0;

    for (const f of emps) {
      const c = conf[f.id] || {};
      const enabled = 'enabled' in c ? !!c.enabled : !!f.optVR;
      const salario = isFinite(c.sal) ? Number(c.sal) : Number(f.salario || 0);
      const daily = isFinite(c.daily) ? Number(c.daily) : s.daily;
      const days = Number.isFinite(c.days) ? Number(c.days) : s.days;
      const pct = Number.isFinite(c.pct) ? Number(c.pct) : s.pct;
      const creditD = Number.isFinite(c.day) ? Number(c.day) : s.creditDay;
      const next = nextDateForDay(creditD, new Date());

      const beneficio = enabled ? daily * days : 0;
      let desconto = enabled ? salario * (pct / 100) : 0;
      if (s.cap) desconto = Math.min(desconto, beneficio);
      const liquido = enabled ? beneficio - desconto : 0;

      if (enabled) {
        adesoes++;
        totBenef += beneficio;
        totDesc += desconto;
        totLiq += liquido;
      }

      rows.push({
        enabled,
        nome: f.nome,
        salario,
        daily,
        days,
        creditD,
        nextFmt: `${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}`,
        beneficio,
        desconto,
        liquido
      });
    }
    return { rows, adesoes, totBenef, totDesc, totLiq };
  }
  btnExportVRCSV?.addEventListener('click', () => {
    const { rows } = collectVRRows();
    const header = [
      'Optou',
      'Funcionário',
      'Salário (R$)',
      'Valor diário (R$)',
      'Dias úteis',
      'Dia crédito',
      'Próximo crédito',
      'Benefício',
      'Desconto',
      'Líquido'
    ];
    const out = [header.join(';')];
    rows.forEach((r) => {
      out.push([
        r.enabled ? 'SIM' : 'NÃO',
        `"${r.nome.replace(/"/g, '""')}"`,
        r.salario.toFixed(2).replace('.', ','),
        r.daily.toFixed(2).replace('.', ','),
        r.days,
        r.creditD,
        r.nextFmt,
        r.beneficio.toFixed(2).replace('.', ','),
        r.desconto.toFixed(2).replace('.', ','),
        r.liquido.toFixed(2).replace('.', ',')
      ].join(';'));
    });
    const csv = out.join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'vale_refeicao.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    notify('CSV do VR exportado.', 'success');
  });
  btnExportVRPDF?.addEventListener('click', () => {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF não carregado.', 'error');
    const { rows, totBenef, totDesc, totLiq } = collectVRRows();
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const mx = 28;
    let y = 36;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('Relatório — Vale Refeição', mx, y);
    y += 16;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(new Date().toLocaleString('pt-BR'), mx, y);
    y += 10;

    const headers = ['Optou', 'Funcionário', 'Salário', 'V.Diário', 'Dias', 'Dia', 'Próx. Crédito', 'Benefício', 'Desconto', 'Líquido'];
    const widths = [44, 170, 64, 64, 36, 32, 110, 72, 72, 72];

    function drawHeader() {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      let x = mx;
      headers.forEach((h, i) => {
        doc.text(h, x + 4, y + 12);
        x += widths[i];
      });
      doc.setDrawColor(180);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;
      doc.setFont('helvetica', 'normal');
    }
    drawHeader();

    rows.forEach((r) => {
      if (y > 770) {
        doc.addPage();
        y = 36;
        drawHeader();
      }
      let x = mx;
      const cells = [
        r.enabled ? 'SIM' : 'NÃO',
        r.nome,
        'R$ ' + r.salario.toFixed(2).replace('.', ','),
        'R$ ' + r.daily.toFixed(2).replace('.', ','),
        String(r.days),
        String(r.creditD),
        r.nextFmt,
        'R$ ' + r.beneficio.toFixed(2).replace('.', ','),
        'R$ ' + r.desconto.toFixed(2).replace('.', ','),
        'R$ ' + r.liquido.toFixed(2).replace('.', ',')
      ];
      widths.forEach((w, i) => {
        doc.text(String(cells[i]), x + 4, y + 12);
        x += w;
      });
      doc.setDrawColor(230);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;
    });

    y += 8;
    doc.setFont('helvetica', 'bold');
    doc.text('Totais:', mx, y);
    doc.setFont('helvetica', 'normal');
    doc.text(
      `Benefício: R$ ${totBenef.toFixed(2).replace('.', ',')}   •   Desconto: R$ ${totDesc
        .toFixed(2)
        .replace('.', ',')}   •   Líquido: R$ ${totLiq.toFixed(2).replace('.', ',')}`,
      mx + 60,
      y
    );

    doc.save('vale_refeicao.pdf');
    notify('PDF do VR exportado.', 'success');
  });

  /* ===================== AJUSTES UI ===================== */
  function fitPontoTableToViewport() {
    try {
      const table = document.getElementById('tPonto');
      const wrap = table?.closest('.table-wrap');
      if (!table || !wrap) return;
      table.classList.remove('fit-mobile');
      table.style.transform = '';
      if (window.innerWidth > 430) return;
      const fullWidth = table.offsetWidth;
      const avail = wrap.clientWidth - 6;
      if (fullWidth > 0 && avail > 0) {
        const scale = Math.min(1, avail / fullWidth);
        if (scale < 1) {
          table.classList.add('fit-mobile');
          table.style.transform = `scale(${scale})`;
        }
      }
    } catch {}
  }
  window.addEventListener('resize', fitPontoTableToViewport);

  /* ===================== PUBLIC SIGN ===================== */
  function docTitleFromType(val) {
    const map = {
      interesse: 'DECLARAÇÃO DE INTERESSE',
      anuencia: 'CARTA DE ANUÊNCIA',
      dividas: 'DECLARAÇÃO DE AUSÊNCIA DE DÍVIDAS'
    };
    if (val && val.startsWith('tpl:')) {
      const tpl = (getTemplates() || []).find((t) => t.id === val.slice(4));
      return (tpl?.name || 'DOCUMENTO PERSONALIZADO').toUpperCase();
    }
    return (map[val] || 'DOCUMENTO').toUpperCase();
  }
  function buildSignLink() {
    const payload = {
      titulo: docTitleFromType(docTipo?.value),
      nome: docNome?.value || getMe().nome || '',
      documento: docDoc?.value || '',
      texto: String(docTexto?.value || '').slice(0, 250000)
    };
    const token = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const base = location.origin + location.pathname;
    return `${base}#assinar=${token}`;
  }
  btnGerarLinkAss?.addEventListener('click', () => {
    const link = buildSignLink();
    if (assLink) assLink.value = link;
    notify('Link de assinatura gerado!', 'success');
  });
  btnCopiarLinkAss?.addEventListener('click', async () => {
    if (!assLink?.value) return notify('Primeiro gere o link.', 'warn');
    try {
      await navigator.clipboard.writeText(assLink.value);
      notify('Link copiado.', 'success');
    } catch {
      notify('Não foi possível copiar automaticamente.', 'warn');
    }
  });

  let sigPadPublic = null;
  function initSigPublic() {
    const canvas = $('sigPadPublic');
    if (!canvas) return;
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    const ctx = canvas.getContext('2d');
    ctx.scale(ratio, ratio);
    sigPadPublic = new SignaturePad(canvas, { minWidth: 1.2, maxWidth: 2.5, penColor: '#eaf6ff', backgroundColor: 'rgba(0,0,0,0)' });
  }
  function showPublicSign(data) {
    document.querySelector('.container')?.setAttribute('style', 'display:none!important');
    $('btnHamb')?.setAttribute('style', 'display:none!important');
    if (pubDocTitle) pubDocTitle.textContent = data.titulo || 'DOCUMENTO';
    if (pubDocWho) pubDocWho.textContent = data.nome ? `${data.nome} • ${data.documento || ''}` : '—';
    if (pubDocText) pubDocText.textContent = data.texto || '';
    publicSign && (publicSign.style.display = 'block');
    setTimeout(initSigPublic, 30);
  }
  function hidePublicSign() {
    publicSign && (publicSign.style.display = 'none');
    document.querySelector('.container')?.setAttribute('style', '');
    $('btnHamb')?.setAttribute('style', '');
  }
  function parseSignHash() {
    if (!location.hash.startsWith('#assinar=')) return null;
    try {
      const token = location.hash.slice('#assinar='.length);
      const json = decodeURIComponent(escape(atob(token)));
      return JSON.parse(json);
    } catch {
      return null;
    }
  }
  window.addEventListener('hashchange', () => {
    const data = parseSignHash();
    if (data) showPublicSign(data);
    else hidePublicSign();
  });
  btnLimparAssPublic?.addEventListener('click', () => sigPadPublic?.clear());
  btnFecharPublic?.addEventListener('click', () => {
    hidePublicSign();
    history.replaceState(null, '', location.pathname + location.search);
  });
  btnBaixarPDFPublic?.addEventListener('click', () => {
    const data = parseSignHash();
    if (!data) return notify('Algo deu errado com o link.', 'error');
    if (!sigPadPublic || sigPadPublic.isEmpty()) return notify('Assine no quadro antes de baixar.', 'warn');
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF não carregado.', 'error');

    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const margin = 56;
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const contentW = pageW - margin * 2;
    const lineH = 16;
    let y = margin;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text(data.titulo || 'DOCUMENTO', margin, y);
    y += 22;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    if (data.nome) {
      doc.text(
        `Colaborador: ${data.nome}${data.documento ? ` — Doc.: ${data.documento}` : ''}`,
        margin,
        y
      );
      y += 18;
    }
    const paragraphs = String(data.texto || '').split('\n');
    for (const p of paragraphs) {
      const wrapped = doc.splitTextToSize(p || ' ', contentW);
      const arr = Array.isArray(wrapped) ? wrapped : [wrapped];
      for (const part of arr) {
        if (y + lineH > pageH - margin) {
          doc.addPage();
          y = margin;
        }
        doc.text(String(part), margin, y);
        y += lineH;
      }
    }

    if (y + 100 > pageH - margin) {
      doc.addPage();
      y = margin;
    }
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Assinatura do colaborador:', margin, y);
    y += 8;
    const img = sigPadPublic.toDataURL('image/png');
    doc.addImage(img, 'PNG', margin, y, 240, 80);
    y += 90;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text('Assinado via link público • ' + new Date().toLocaleString('pt-BR'), margin, pageH - 24);

    const safeName = (data.titulo || 'documento').replace(/\s+/g, '_').toLowerCase();
    doc.save(`${safeName}_assinado.pdf`);
    notify('PDF assinado gerado.', 'success');
  });

  /* ===================== DOMContentLoaded ===================== */
  document.addEventListener('DOMContentLoaded', () => {
    const me = getMe();
    if (docNome && !docNome.value) docNome.value = me.nome || '';
    refreshTexto();
    fitDocTextarea();
    fitPontoTableToViewport();

    /* Splash fade */
    const sp = $('splash');
    setTimeout(() => sp && sp.classList.add('hide'), 1200);
    setTimeout(() => sp && sp.remove(), 1800);

    /* Ancorar grade por padrão no "Gerenciar" */
    try {
      const body = document.querySelector('#tabFuncionarios .card-body');
      if (body && empGrid && !body.contains(empGrid)) body.appendChild(empGrid);
    } catch {}

    applyLayoutToUI();

    /* Alertas: varredura inicial */
    checkImportantDocExpirations();
    updateNotifDot();

    /* Public sign ao abrir com hash */
    const data = parseSignHash();
    if (data) showPublicSign(data);
  });
})();
</script>

<!-- Pré-carregar logo para o PDF -->
<img id="pdfLogoPreload" src="Assets/img/logo_new.png" alt="" style="display:none"/>
</body>
</html>
