<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<!-- Viewport corrigido: reduz leve zoom inicial e corrige atributo maximum-scale -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>RCR Engenharia ‚Äî RH (Ponto, Documentos & Assinaturas)</title>

<!-- √çcones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<!-- Leaflet (mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- jsPDF (PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- PDF.js (leitura de PDFs para texto) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script>
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js';
  }
</script>

<!-- Signature Pad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<!-- Link css -->
 <link rel="stylesheet" href="assets/css/00-reset.css">
<link rel="stylesheet" href="assets/css/01-tokens.css">
<link rel="stylesheet" href="assets/css/02-base.css">
<link rel="stylesheet" href="assets/css/10-layout.css">


<link rel="stylesheet" href="assets/css/20-components/button.css">
<link rel="stylesheet" href="assets/css/20-components/card.css">
<link rel="stylesheet" href="assets/css/20-components/table.css">
<link rel="stylesheet" href="assets/css/20-components/form.css">
<link rel="stylesheet" href="assets/css/20-components/modal.css">
<link rel="stylesheet" href="assets/css/20-components/tabs.css">
<link rel="stylesheet" href="assets/css/20-components/toast.css">
<link rel="stylesheet" href="assets/css/20-components/splash.css">


<link rel="stylesheet" href="assets/css/30-modulos/ponto.css">
<link rel="stylesheet" href="assets/css/30-modulos/incluir-ponto.css">
<link rel="stylesheet" href="assets/css/30-modulos/documentos.css">
<link rel="stylesheet" href="assets/css/30-modulos/funcionarios.css">
<link rel="stylesheet" href="assets/css/30-modulos/beneficios.css">
<link rel="stylesheet" href="assets/css/30-modulos/assinatura-publica.css">


<link rel="stylesheet" href="assets/css/40-integracoes.css">
<link rel="stylesheet" href="assets/css/90-utilities.css">
<link rel="stylesheet" href="assets/css/95-print.css">
<link rel="stylesheet" href="assets/css/99-overrides.css">

</head>
<body>

  <!-- Splash -->
  <div id="splash">
    <div class="splash-card">
      <img class="splash-logo" src="Assets/img/logo_new.png" alt="RCR" onerror="this.style.display='none'">
      <div class="splash-title">RCR Engenharia</div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <button class="menu-toggle" id="btnHamb" aria-label="Abrir menu"><i class="fa fa-bars" aria-hidden="true"></i></button>

  <div class="container">
    <!-- Sidebar -->
    <aside id="sidebar" aria-label="Menu lateral">
      <div class="brand">
        <img class="brand-logo" src="Assets/img/logo_new.png" alt="RCR" onerror="this.remove()">
        <strong>RCR Engenharia</strong>
      </div>

      <div class="user-card" aria-live="polite">
        <div class="name" id="uNome">Colaborador(a)</div>
        <div class="role" id="uFuncao">Fun√ß√£o</div>
      </div>

      <ul class="menu" id="menu">
        <li data-tab="tabPonto" class="active" aria-controls="tabPonto">
          <i class="fa-regular fa-calendar-days" aria-hidden="true"></i> Cart√£o de Ponto
        </li>
        <li data-tab="tabIncluir" aria-controls="tabIncluir">
          <i class="fa-solid fa-location-dot" aria-hidden="true"></i> Incluir Ponto
        </li>
        <li data-tab="tabDocs" aria-controls="tabDocs">
          <i class="fa-regular fa-file-lines" aria-hidden="true"></i> Documentos & Assinaturas
        </li>

        <!-- Funcion√°rios com SUBMENU (item-pai sem data-tab) -->
        <li class="has-submenu menu-func-root" aria-haspopup="true" aria-expanded="false">
          <div class="row-head">
            <i class="fa-solid fa-users" aria-hidden="true"></i> Funcion√°rios
            <i class="fa-solid fa-caret-down caret" aria-hidden="true"></i>
          </div>
          <ul class="submenu" id="submenuFuncionarios" role="menu">
            <li data-tab="tabFuncGestao" aria-controls="tabFuncGestao" role="menuitem">
              <i class="fa-solid fa-clipboard-user" aria-hidden="true"></i> Gest√£o de Funcion√°rios
            </li>
            <li data-tab="tabFuncionarios" aria-controls="tabFuncionarios" role="menuitem">
              <i class="fa-solid fa-user-gear" aria-hidden="true"></i> Gerenciar Funcion√°rios
            </li>
          </ul>
        </li>

        <!-- Benef√≠cios (submenu) -->
        <li class="has-submenu menu-benef-root" aria-haspopup="true" aria-expanded="false">
          <div class="row-head">
            <i class="fa-solid fa-hand-holding-heart" aria-hidden="true"></i> Benef√≠cios
            <i class="fa-solid fa-caret-down caret" aria-hidden="true"></i>
          </div>
          <ul class="submenu" id="submenuBeneficios" role="menu">
            <li data-tab="tabVT" aria-controls="tabVT" role="menuitem">
              <i class="fa-solid fa-bus" aria-hidden="true"></i> Vale Transporte
            </li>
            <li data-tab="tabVR" aria-controls="tabVR" role="menuitem">
              <i class="fa-solid fa-utensils" aria-hidden="true"></i> Vale Refei√ß√£o
            </li>
          </ul>
        </li>
      </ul>

      <div class="sidebar-mobile-footer">
        <button class="btn btn-light" id="btnCloseSidebar"><i class="fa-solid fa-arrow-left" aria-hidden="true"></i> Voltar</button>
      </div>
    </aside>

    <!-- Main -->
    <main>
      <div class="topbar">
        <div class="hello">Ol√°, <span id="helloNome">Colaborador(a)</span></div>
        <div class="right">
          <span class="badge"><i class="fa-regular fa-clock" aria-hidden="true"></i> <span id="nowClock">--:--:--</span></span>
          <button class="btn btn-light icon-btn" id="btnAlerts" title="Lembretes" aria-haspopup="dialog">
            <i class="fa-regular fa-bell" aria-hidden="true"></i>
            <span class="notif-dot" id="notifDot" hidden></span>
          </button>
        </div>
      </div>

      <!-- Cart√£o de Ponto -->
      <section id="tabPonto" class="tab active" role="region" aria-labelledby="hdrPonto">
        <div class="card">
          <div class="card-header" id="hdrPonto">Filtrar</div>
          <div class="card-body">
            <div class="filters">
              <div class="chip"><label for="pInicio">In√≠cio</label><input type="date" id="pInicio"/></div>
              <div class="chip"><label for="pFim">Fim</label><input type="date" id="pFim"/></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-primary" id="btnAplicarFiltro"><i class="fa fa-filter" aria-hidden="true"></i> Aplicar</button></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-light" id="btnPeriodoAtual"><i class="fa-regular fa-calendar" aria-hidden="true"></i> 15 dias</button></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-primary" id="btnExportPonto"><i class="fa-regular fa-file-pdf" aria-hidden="true"></i> Exportar PDF</button></div>
            </div>

            <div class="kpis">
              <div class="kpi"><div class="title">Horas no per√≠odo</div><div class="value" id="kHoras">00:00</div></div>
              <div class="kpi"><div class="title">Saldo</div><div class="value" id="kSaldo">00:00</div></div>
              <div class="kpi"><div class="title">Dias com pend√™ncia</div><div class="value" id="kPend">0</div></div>
            </div>

            <div class="table-wrap">
              <table class="table" id="tPonto">
                <thead>
                  <tr>
                    <th>Status</th><th>Data</th>
                    <th>Entrada 1</th><th>Sa√≠da 1</th>
                    <th>Entrada 2</th><th>Sa√≠da 2</th>
                    <th>Entrada 3</th><th>Sa√≠da 3</th>
                    <th>Saldo</th>
                  </tr>
                </thead>
                <tbody><!-- via JS --></tbody>
              </table>
              <div class="muted-hint">Dica: clique em uma linha para ver <b>todos</b> os batimentos daquele dia.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Incluir Ponto -->
      <section id="tabIncluir" class="tab" role="region" aria-labelledby="hdrIncluir">
        <div class="card">
          <div class="card-header" id="hdrIncluir">Incluir Ponto (geolocaliza√ß√£o)</div>
          <div class="card-body">
            <div id="map"><div class="map-skeleton">Carregando mapa‚Ä¶</div></div>

            <div class="inline-row">
              <div class="chip"><label>Data/Hora atual</label><div id="lblAgora" class="kv-strong">--/--/---- --:--:--</div></div>
              <div class="chip"><label>Coordenadas</label><div id="lblCoord" class="kv-strong">--</div></div>
              <div class="chip"><label style="visibility:hidden">.</label><button class="btn btn-ok" id="btnBaterPonto"><i class="fa-regular fa-circle-dot" aria-hidden="true"></i> Incluir Ponto</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Documentos & Assinaturas -->
      <section id="tabDocs" class="tab" role="region" aria-labelledby="hdrDocs">
        <div class="card" style="height:100%;min-height:580px">
          <div class="card-header" id="hdrDocs">Documentos &amp; Assinaturas</div>
          <div class="card-body" style="padding:0;height:calc(100% - 48px)">

            <!-- ================== Documentos & Assinaturas: HERO ================== -->
            <div id="docs-sign-root" class="docs-shell" hidden>
              <div class="docs-hero">
                <!-- Chip "Templates" (abre o gerenciador de templates existente) -->
                <button id="btn-templates" type="button" class="chip chip-primary">Templates</button>

                <!-- Cart√£o central com CTA -->
                <section class="docs-cta-card" role="region" aria-labelledby="docs-cta-title">
                  <h2 id="docs-cta-title" class="sr-only">Documentos & Assinaturas</h2>
                  <button id="btn-open" type="button" class="btn-gradient btn-cta">Gerar documento</button>
                </section>
              </div>

              <footer class="docs-footer">¬© Atrium ‚Ä¢ Somente front. <span class="grad">ciano‚Üímagenta</span></footer>

              <!-- MODAL WIZARD GERAR DOCUMENTO (resiz√°vel) -->
              <div id="wizard" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
                <div class="modal" id="wizardModal">
                  <div class="modal-h">Gera√ß√£o de documentos</div>
                  <div class="modal-b">
                    <!-- STEP 1 -->
                    <div id="step1" class="grid grid-2">
                      <div>
                        <label for="template">Selecione o template</label>
                        <select id="template" class="select-dark"></select>
                        <small class="tiny">Crie/edite templates no bot√£o ‚ÄúTemplates‚Äù.</small>
                      </div>

                      <div>
                        <label>Vincular funcion√°rio?</label>
                        <!-- radios sem fundo/borda -->
                        <div class="radio-inline">
                          <label><input type="radio" name="vinc" value="sim" checked> Sim</label>
                          <label><input type="radio" name="vinc" value="nao"> N√£o</label>
                        </div>
                      </div>

                      <div id="func-wrap">
                        <label for="func">Escolha o funcion√°rio</label>
                        <select id="func" class="select-dark"></select>
                      </div>

                      <div class="panel" style="grid-column:1/-1">
                        <small class="muted">Vari√°veis: <code>{nome}</code>, <code>{cpf}</code>, <code>{endereco.cidade}</code>, <code>{salario|money}</code>, <code>{admissao|date}</code>, <code>{nome|upper}</code>, <code>{hoje}</code>.</small>
                      </div>
                    </div>

                    <!-- STEP 2 -->
                    <div id="step2" style="display:none;">
                      <div class="cols">
                        <div class="panel">
                          <h4>Vari√°veis detectadas</h4>
                          <div id="vars"></div>
                          <hr style="border-color:rgba(255,255,255,.08);margin:10px 0">
                          <label class="radio-inline" style="gap:8px;">
                            <input type="checkbox" id="chk-preview" checked> Pr√©-visualizar com dados do funcion√°rio
                          </label>
                          <div class="panel" style="margin-top:10px;">
                            <small class="muted">Clique em uma vari√°vel para inserir no cursor do editor.</small>
                          </div>

                          <!-- ======= Configura√ß√µes de Layout ======= -->
                          <div class="panel" style="margin-top:12px;">
                            <h4>Configura√ß√µes de layout</h4>
                            <div class="grid">
                              <div>
                                <label for="ly-font-family">Fonte</label>
                                <select id="ly-font-family" class="select-dark">
                                  <option value="Arial, Helvetica, sans-serif">Arial / Helvetica</option>
                                  <option value="Times New Roman, Times, serif">Times New Roman</option>
                                  <option value="Calibri, Arial, Helvetica, sans-serif">Calibri</option>
                                  <option value="Cambria, Georgia, 'Times New Roman', Times, serif">Cambria</option>
                                  <option value="Roboto, Arial, Helvetica, sans-serif">Roboto</option>
                                </select>
                              </div>
                              <div>
                                <label for="ly-font-size">Tamanho base da fonte (px)</label>
                                <input id="ly-font-size" type="number" class="input-dark" min="8" max="20" step="1" />
                              </div>
                              <div>
                                <label for="ly-line-height">Altura de linha</label>
                                <input id="ly-line-height" type="number" class="input-dark" min="1" max="2" step="0.05" />
                              </div>
                              <div>
                                <label for="ly-p-spacing">Espa√ßo entre par√°grafos (px)</label>
                                <input id="ly-p-spacing" type="number" class="input-dark" min="0" max="40" step="1" />
                              </div>

                              <div>
                                <label for="ly-h1">Tamanho H1 (x da base)</label>
                                <input id="ly-h1" type="number" class="input-dark" min="1.0" max="3" step="0.05" />
                              </div>
                              <div>
                                <label for="ly-h2">Tamanho H2 (x da base)</label>
                                <input id="ly-h2" type="number" class="input-dark" min="1.0" max="3" step="0.05" />
                              </div>
                              <div>
                                <label for="ly-h3">Tamanho H3 (x da base)</label>
                                <input id="ly-h3" type="number" class="input-dark" min="1.0" max="3" step="0.05" />
                              </div>

                              <div>
                                <label for="ly-page-format">Formato da p√°gina</label>
                                <select id="ly-page-format" class="select-dark">
                                  <option value="a4">A4</option>
                                  <option value="letter">Carta (Letter)</option>
                                </select>
                              </div>
                              <div>
                                <label for="ly-orientation">Orienta√ß√£o</label>
                                <select id="ly-orientation" class="select-dark">
                                  <option value="p">Retrato</option>
                                  <option value="l">Paisagem</option>
                                </select>
                              </div>

                              <div>
                                <label for="ly-mt">Margem superior (mm)</label>
                                <input id="ly-mt" type="number" class="input-dark" min="0" max="50" step="1" />
                              </div>
                              <div>
                                <label for="ly-mr">Margem direita (mm)</label>
                                <input id="ly-mr" type="number" class="input-dark" min="0" max="50" step="1" />
                              </div>
                              <div>
                                <label for="ly-mb">Margem inferior (mm)</label>
                                <input id="ly-mb" type="number" class="input-dark" min="0" max="50" step="1" />
                              </div>
                              <div>
                                <label for="ly-ml">Margem esquerda (mm)</label>
                                <input id="ly-ml" type="number" class="input-dark" min="0" max="50" step="1" />
                              </div>
                            </div>

                            <div class="panel" style="margin-top:12px;">
                              <div class="row">
                                <label class="radio-inline" style="gap:8px;">
                                  <input type="checkbox" id="ly-logo-enabled"> Inserir logo no topo
                                </label>
                              </div>
                              <div class="grid" style="margin-top:8px;">
                                <div>
                                  <label for="ly-logo-size">Tamanho do logo (px)</label>
                                  <input id="ly-logo-size" type="number" class="input-dark" min="24" max="600" step="1" />
                                </div>
                                <div>
                                  <label for="ly-logo-align">Alinhamento do logo</label>
                                  <select id="ly-logo-align" class="select-dark">
                                    <option value="left">Esquerda</option>
                                    <option value="center">Centro</option>
                                    <option value="right">Direita</option>
                                  </select>
                                </div>
                                <div>
                                  <label for="ly-logo-space">Espa√ßo abaixo do logo (px)</label>
                                  <input id="ly-logo-space" type="number" class="input-dark" min="0" max="80" step="1" />
                                </div>
                                <div>
                                  <label for="ly-logo-file">Logo (imagem)</label>
                                  <div class="file-input">
                                    <input id="ly-logo-file" type="file" accept="image/*" hidden />
                                    <button id="ly-logo-file-btn" type="button" class="input-like">
                                      <span>Selecionar imagem</span>
                                      <span class="tiny">üñºÔ∏è</span>
                                    </button>
                                    <div id="ly-logo-file-info" class="tiny file-name">Nenhum arquivo selecionado</div>
                                  </div>
                                </div>
                              </div>

                              <div class="row" style="margin-top:10px;">
                                <label class="radio-inline" style="gap:8px;">
                                  <input type="checkbox" id="ly-logo-resize-first" checked>
                                  Redimensionar primeira imagem do conte√∫do (usa o tamanho do logo)
                                </label>
                              </div>
                            </div>

                            <div class="row" style="margin-top:10px;">
                              <button id="ly-reset" class="btn secondary">Resetar</button>
                              <div style="display:flex;gap:8px;">
                                <button id="ly-save" class="btn">Salvar como padr√£o</button>
                              </div>
                            </div>
                          </div>
                          <!-- ======= /Configura√ß√µes de Layout ======= -->
                        </div>

                        <div>
                          <div class="toolbar">
                            <button class="tb-btn" data-cmd="bold"><b>N</b></button>
                            <button class="tb-btn" data-cmd="italic"><i>I</i></button>
                            <button class="tb-btn" data-cmd="underline"><u>S</u></button>
                            <button class="tb-btn" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
                            <button class="tb-btn" data-cmd="insertOrderedList">1. Lista</button>
                            <button class="tb-btn" id="btn-clear">Limpar formata√ß√£o</button>
                          </div>
                          <div id="editor" class="editor" contenteditable="true"></div>
                          <div id="preview" class="preview"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="modal-f">
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                      <button id="btn-back" class="btn secondary">Voltar</button>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                      <button id="btn-close" class="btn secondary">Fechar</button>
                      <button id="btn-next" class="btn">Avan√ßar</button>
                      <button id="btn-concluir" class="btn" style="display:none;">Concluir (PDF)</button>
                    </div>
                  </div>

                  <!-- handles de resize -->
                  <div class="resizer-e" id="wizardResizeE"></div>
                  <div class="resizer-se" id="wizardResizeSE"></div>
                </div>
              </div>

              <!-- MODAL GERENCIAR TEMPLATES -->
              <div id="tplModal" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
                <div class="modal" style="width:min(1100px,96vw)">
                  <div class="modal-h row">
                    <span>Templates</span>
                    <button id="btn-close-tpl" class="btn secondary">Fechar</button>
                  </div>
                  <div class="modal-b">
                    <!-- Lista -->
                    <div id="tplListView">
                      <div class="row" style="margin-bottom:10px;">
                        <h3 style="margin:0">Meus templates</h3>
                        <button id="btn-new-tpl" class="btn">Criar template</button>
                      </div>
                      <div class="list" id="tplList"></div>
                      <div class="panel" style="margin-top:10px;">
                        <small class="muted">Templates ‚Äúpadr√£o‚Äù n√£o podem ser apagados. Para editar, use ‚ÄúDuplicar‚Äù e edite a c√≥pia.</small>
                      </div>
                    </div>

                    <!-- Criar/Editar -->
                    <div id="tplEditView" style="display:none;">
                      <div class="grid grid-2">
                        <div>
                          <label for="tplName">Nome do template</label>
                          <input id="tplName" type="text" class="input-dark" placeholder="Ex: Contrato CLT ‚Äì Loja SP" />
                        </div>

                        <div>
                          <label for="docxTpl">Importar Word (.docx)</label>
                          <!-- controle estilizado (mesma altura do input) -->
                          <div class="file-input">
                            <input id="docxTpl" type="file" accept=".docx" hidden />
                            <button id="docxTplBtn" type="button" class="input-like">
                              <span>Selecionar arquivo .docx</span>
                              <span class="tiny">üìÑ</span>
                            </button>
                            <div id="docxTplInfo" class="tiny file-name">Nenhum arquivo selecionado</div>
                          </div>
                          <small class="tiny">A importa√ß√£o mant√©m a formata√ß√£o (t√≠tulos, listas, negrito etc.).</small>
                        </div>

                        <div class="panel" style="grid-column:1/-1">
                          <small class="muted">Vari√°veis: <code>{nome}</code>, <code>{cpf}</code>, <code>{endereco.cidade}</code>, <code>{salario|money}</code>, <code>{admissao|date}</code>, <code>{nome|upper}</code>, <code>{hoje}</code>.</small>
                        </div>
                      </div>

                      <div class="cols" style="margin-top:12px;">
                        <div class="panel">
                          <h4>Vari√°veis detectadas</h4>
                          <div id="tplVars"></div>
                        </div>
                        <div>
                          <div class="toolbar">
                            <button class="tb-btn" data-cmd="bold"><b>N</b></button>
                            <button class="tb-btn" data-cmd="italic"><i>I</i></button>
                            <button class="tb-btn" data-cmd="underline"><u>S</u></button>
                            <button class="tb-btn" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
                            <button class="tb-btn" data-cmd="insertOrderedList">1. Lista</button>
                            <button class="tb-btn" id="btn-clear-tpl">Limpar formata√ß√£o</button>
                          </div>
                          <div id="tplEditor" class="editor" contenteditable="true"></div>
                        </div>
                      </div>

                      <div class="row" style="margin-top:12px;">
                        <button id="btn-back-list" class="btn secondary">Cancelar</button>
                        <div style="display:flex;gap:8px;">
                          <button id="btn-save-tpl" class="btn">Salvar template</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-f">
                    <small class="tiny">Armazenamento local: <code>localStorage</code></small>
                  </div>
                </div>
              </div>

              <!-- √Årea oculta para render do PDF -->
              <div id="print-area"></div>

            </div>
          </div>
        </div>
      </section>

      <!-- GEST√ÉO DE FUNCION√ÅRIOS -->
      <section id="tabFuncGestao" class="tab" role="region" aria-labelledby="hdrFuncGestao">
        <div class="card">
          <div class="card-header" id="hdrFuncGestao">Gest√£o de Funcion√°rios</div>
          <div class="card-body">

            <!-- (Bloco de cadastro √© aberto em modal) -->
            <div class="gestao-cadastro-wrap">
              <div class="gestao-cadastro">
                <div class="card flat">
                  <div class="card-header">Cadastro de Funcion√°rios</div>
                  <div class="card-body">
                    <!-- FOTO -->
                    <div class="row">
                      <div class="col" style="max-width:320px">
                        <label for="cadFoto">Foto do funcion√°rio</label>
                        <input type="file" id="cadFoto" accept="image/*">
                      </div>
                      <div class="col" style="display:flex;align-items:flex-end;gap:12px">
                        <div>
                          <label style="visibility:hidden">.</label>
                          <img id="cadFotoPreview" class="emp-avatar" src="" alt="" style="width:90px;height:90px;border-radius:16px">
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <label for="cadNome">Nome</label>
                        <input type="text" id="cadNome" placeholder="Nome completo">
                      </div>
                      <div class="col">
                        <label for="cadFuncao">Fun√ß√£o</label>
                        <input type="text" id="cadFuncao" placeholder="Cargo/Fun√ß√£o">
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <label for="cadRG">RG</label>
                        <input type="text" id="cadRG" placeholder="00.000.000-0">
                      </div>
                      <div class="col">
                        <label for="cadCPF">CPF</label>
                        <input type="text" id="cadCPF" placeholder="000.000.000-00">
                      </div>
                      <div class="col">
                        <label for="cadIdade">Idade</label>
                        <input type="number" id="cadIdade" min="0" placeholder="0">
                      </div>
                    </div>

                    <div class="row" id="wrapAdmissaoSalario">
                      <div class="col">
                        <label for="cadAdmissao">Data de admiss√£o</label>
                        <input type="date" id="cadAdmissao">
                      </div>
                      <div class="col">
                        <label for="cadSalario">Sal√°rio (R$)</label>
                        <input type="number" id="cadSalario" min="0" step="0.01" placeholder="0,00">
                      </div>
                    </div>

                    <div class="row benefit-prices">
                      <div class="col">
                        <label for="cadVtUnit">Tarifa VT (R$)</label>
                        <input type="number" id="cadVtUnit" step="0.01" min="0" placeholder="ex.: 5,00">
                      </div>
                      <div class="col">
                        <label for="cadVrDaily">Valor di√°rio VR (R$)</label>
                        <input type="number" id="cadVrDaily" step="0.01" min="0" placeholder="ex.: 25,00">
                      </div>
                    </div>

                    <div class="row" id="wrapCargoField">
                      <div class="col">
                        <label for="cadCargo">Cargo</label>
                        <input type="text" id="cadCargo" placeholder="Ex.: Analista, Engenheiro">
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <div class="benefit-toggles" id="benefitToggleRow">
                          <label><input type="checkbox" id="cadOptVR"> VR</label>
                          <label><input type="checkbox" id="cadOptVT"> VT</label>
                        </div>
                        <div class="vr-help">Marque as op√ß√µes desejadas. Voc√™ pode editar regras em <b>Benef√≠cios</b> depois.</div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col">
                        <label for="cadDocumento">Documento (arquivo)</label>
                        <input type="file" id="cadDocumento">
                      </div>
                      <div class="col">
                        <label style="visibility:hidden">.</label>
                        <div class="inline-row">
                          <button class="btn btn-primary" id="btnSalvarCadastro">
                            <i class="fa-regular fa-floppy-disk" aria-hidden="true"></i> Salvar cadastro
                          </button>
                          <button class="btn btn-light" id="btnLimparCadastro">
                            <i class="fa-solid fa-eraser" aria-hidden="true"></i> Limpar
                          </button>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>

            <!-- BUSCA (Gest√£o) -->
            <div class="emp-tools centered" id="empToolsGestao">
              <div class="search-group">
                <input type="text" id="funcSearchGestao" placeholder="Pesquisar funcion√°rio‚Ä¶ (digite para filtrar)">
                <button class="btn btn-light" id="funcSearchGestaoBtn" title="Pesquisar">
                  <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                </button>
                <button class="btn btn-light" id="funcClearGestao">
                  <i class="fa-solid fa-xmark" aria-hidden="true"></i> Limpar
                </button>
              </div>
            </div>

            <!-- Bot√£o Cadastro de Usu√°rio -->
            <div class="gestao-actions-left">
              <button class="btn btn-primary" id="btnAbrirCadastro">
                <i class="fa-solid fa-user-plus" aria-hidden="true"></i> Cadastro de Usu√°rio
              </button>
            </div>

            <!-- Host para a grade -->
            <div id="empGridHostGestao"></div>
          </div>
        </div>
      </section>
      <!-- FIM GEST√ÉO -->

      <!-- GERENCIAR FUNCION√ÅRIOS -->
      <section id="tabFuncionarios" class="tab" role="region" aria-labelledby="hdrFuncionarios">
        <div class="card">
          <div class="card-header" id="hdrFuncionarios">Funcion√°rios</div>
          <div class="card-body">

            <!-- Busca simples -->
            <div class="emp-tools centered">
              <div class="search-group">
                <input type="text" id="funcSearch" placeholder="Pesquisar funcion√°rio‚Ä¶ (digite para filtrar)">
                <button class="btn btn-light" id="funcSearchBtn" title="Pesquisar">
                  <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                </button>
                <button class="btn btn-light" id="funcClear">
                  <i class="fa-solid fa-xmark" aria-hidden="true"></i> Limpar
                </button>
              </div>
            </div>

            <!-- A√ß√µes injetadas via JS -->

            <div class="emp-grid" id="empGrid"><!-- via JS --></div>

          </div>
        </div>
      </section>

      <!-- Benef√≠cios ‚Äî VT -->
      <section id="tabVT" class="tab" role="region" aria-labelledby="hdrVT">
        <div class="card">
          <div class="card-header" id="hdrVT">Benef√≠cios ‚Äî Vale Transporte</div>
          <div class="card-body">
            <div class="kpis">
              <div class="kpi">
                <div class="title">Colaboradores com VT</div>
                <div class="value" id="vtKColab">0</div>
              </div>
              <div class="kpi">
                <div class="title">Total de VTs / m√™s</div>
                <div class="value" id="vtKQtd">0</div>
              </div>
              <div class="kpi">
                <div class="title">Valor total (R$)</div>
                <div class="value" id="vtKValor">R$ 0,00</div>
              </div>
            </div>

            <div class="row" style="align-items:flex-end">
              <div class="col" style="max-width:220px">
                <label for="vtUnit">Tarifa padr√£o (R$)</label>
                <input type="number" step="0.01" min="0" id="vtUnit" placeholder="ex.: 5.00" disabled>
              </div>
              <div class="col" style="max-width:220px">
                <label for="vtCreditDay">Dia do cr√©dito (geral)</label>
                <input type="number" min="1" max="31" id="vtCreditDay" placeholder="1 a 31" disabled>
              </div>
              <div class="col">
                <div class="vt-help">Dados preenchidos automaticamente a partir do cadastro (somente visualiza√ß√£o).</div>
              </div>
            </div>

            <div class="filters">
              <button class="btn btn-light" id="btnExportVTCSV"><i class="fa-regular fa-file-excel" aria-hidden="true"></i> Exportar Excel (CSV)</button>
              <button class="btn btn-primary" id="btnExportVTPDF"><i class="fa-regular fa-file-pdf" aria-hidden="true"></i> Exportar PDF</button>
            </div>

            <div class="table-wrap">
              <table class="table" id="vtTable">
                <thead>
                  <tr>
                    <th>Ativo</th>
                    <th class="vt-cell-left">Funcion√°rio</th>
                    <th>Qtd VT/m√™s</th>
                    <th>Tarifa (R$)</th>
                    <th>Dia cr√©dito</th>
                    <th>Pr√≥ximo cr√©dito</th>
                    <th>Valor (R$)</th>
                  </tr>
                </thead>
                <tbody id="vtBody"><tr><td colspan="7">‚Äî</td></tr></tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="t-right">Totais</th>
                    <th id="vtSumQtd">0</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th id="vtSumValor">R$ 0,00</th>
                  </tr>
                </tfoot>
              </table>
            </div>

          </div>
        </div>
      </section>

      <!-- Benef√≠cios ‚Äî VR -->
      <section id="tabVR" class="tab" role="region" aria-labelledby="hdrVR">
        <div class="card">
          <div class="card-header" id="hdrVR">Benef√≠cios ‚Äî Vale Refei√ß√£o</div>
          <div class="card-body">
            <div class="kpis">
              <div class="kpi">
                <div class="title">Ades√µes (VR)</div>
                <div class="value" id="vrKAdesoes">0</div>
              </div>
              <div class="kpi">
                <div class="title">Custo total do benef√≠cio</div>
                <div class="value" id="vrKBeneficio">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="title">Desconto total (func.)</div>
                <div class="value" id="vrKDesconto">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="title">Custo l√≠quido p/ empresa</div>
                <div class="value" id="vrKLiquido">R$ 0,00</div>
              </div>

              <div class="export-actions">
                <button class="btn btn-light" id="btnExportVRCSV"><i class="fa-regular fa-file-excel" aria-hidden="true"></i> Exportar Excel (CSV)</button>
                <button class="btn btn-primary" id="btnExportVRPDF"><i class="fa-regular fa-file-pdf" aria-hidden="true"></i> Exportar PDF</button>
              </div>
            </div>

            <div class="row" style="align-items:flex-end">
              <div class="col" style="max-width:220px">
                <label for="vrDaily">Valor di√°rio (R$)</label>
                <input type="number" step="0.01" min="0" id="vrDaily" placeholder="ex.: 25.00">
              </div>
              <div class="col" style="max-width:220px">
                <label for="vrDays">Dias √∫teis / m√™s</label>
                <input type="number" min="0" max="31" id="vrDays" placeholder="ex.: 22">
              </div>
              <div class="col" style="max-width:220px">
                <label for="vrPct">% desconto sobre sal√°rio</label>
                <input type="number" min="0" max="100" step="0.01" id="vrPct" placeholder="6">
              </div>
              <div class="col" style="max-width:220px">
                <label for="vrCreditDay">Dia do cr√©dito (geral)</label>
                <input type="number" min="1" max="31" id="vrCreditDay" placeholder="1 a 31">
              </div>
            </div>

            <div class="row" style="align-items:center">
              <div class="col" style="max-width:320px">
                <label>
                  <input type="checkbox" id="vrCapDiscount" style="margin-right:6px">
                  Limitar desconto ao valor do benef√≠cio
                </label>
                <div class="vr-help">Quando marcado, o desconto (6% do sal√°rio por padr√£o) jamais supera o total do VR do m√™s para aquele colaborador.</div>
              </div>
            </div>

            <div class="table-wrap">
              <table class="table" id="vrTable">
                <thead>
                  <tr>
                    <th>Optou</th>
                    <th class="vr-cell-left">Funcion√°rio</th>
                    <th>Sal√°rio (R$)</th>
                    <th>Valor di√°rio (R$)</th>
                    <th>Dias √∫teis</th>
                    <th>Dia cr√©dito</th>
                    <th>Pr√≥ximo cr√©dito</th>
                    <th>Benef√≠cio</th>
                    <th>Desconto</th>
                    <th>L√≠quido</th>
                  </tr>
                </thead>
                <tbody id="vrBody"><tr><td colspan="10">‚Äî</td></tr></tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="t-right">Totais</th>
                    <th></th><th></th><th></th><th></th><th></th>
                    <th id="vrSumBeneficio">R$ 0,00</th>
                    <th id="vrSumDesconto">R$ 0,00</th>
                    <th id="vrSumLiquido">R$ 0,00</th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="vr-help" style="margin-top:8px">
              Observa√ß√£o: os campos por funcion√°rio aceitam sobrescrever os padr√µes (valor di√°rio, dias, % desconto e dia do cr√©dito).
            </div>

          </div>
        </div>
      </section>

      <!-- Configura√ß√µes -->
      <section id="tabConfig" class="tab" role="region" aria-labelledby="hdrConfig">
        <div class="card">
          <div class="card-header" id="hdrConfig">Configura√ß√µes</div>
          <div class="card-body">
            <div class="muted-hint">Nenhuma op√ß√£o dispon√≠vel no momento.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Batimentos do Dia -->
  <div class="modal" id="modalBatimentosDia" role="dialog" aria-modal="true" aria-labelledby="batimentosDiaTitulo">
    <div class="modal-content">
      <div class="modal-header"><span id="batimentosDiaTitulo">Batimentos do dia</span></div>
      <div class="modal-body">
        <div class="bat-dia-nav">
          <button class="btn btn-light" id="btnPrevDia">‚óÄ Dia anterior</button>
          <div class="bat-dia-picker"><input type="date" id="batimentosDatePicker"></div>
          <button class="btn btn-light" id="btnNextDia">Pr√≥ximo dia ‚ñ∂</button>
        </div>
        <table class="table">
          <thead><tr><th>#</th><th>Tipo</th><th>Hor√°rio</th><th>Origem</th><th>Observa√ß√£o</th></tr></thead>
          <tbody id="batimentosDiaBody"><tr><td colspan="5">-</td></tr></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="fecharBatimentosDia">Fechar</button>
        <button class="btn btn-ghost" id="justificarAusenciaDia">Justificar Aus√™ncia</button>
        <button class="btn btn-primary" id="incluirPontoDia">Incluir Ponto</button>
      </div>
    </div>
  </div>

  <!-- Modal Funcion√°rio -->
  <div class="modal" id="modalFuncionario" role="dialog" aria-modal="true" aria-labelledby="funcModalTitle">
    <div class="modal-content">
      <div class="modal-header"><span id="funcModalTitle">Funcion√°rio</span></div>
      <div class="modal-body">
        <div class="emp-modal-header">
          <img id="funcModalAvatar" class="emp-avatar" src="" alt="">
          <div>
            <div class="emp-name" id="funcModalNome">‚Äî</div>
            <div class="emp-role" id="funcModalFuncao">‚Äî</div>
          </div>
        </div>

        <!-- Abas (duas: Documentos e Documentos Importantes) -->
        <div class="emp-tabs" role="tablist" aria-label="Documentos do funcion√°rio">
          <button class="btn btn-light emp-tab-btn active" id="btnTabDocsSimples" data-target="#paneDocsSimples">
            <i class="fa-regular fa-folder-open" aria-hidden="true"></i> Documentos
          </button>
          <button class="btn btn-warn emp-tab-btn" id="btnTabDocsImportantes" data-target="#paneDocsImportantes">
            <i class="fa-regular fa-bell" aria-hidden="true"></i> Documentos importantes
          </button>
        </div>

        <!-- Pane: Documentos simples -->
        <div class="emp-pane active" id="paneDocsSimples">
          <div class="inline-row" style="margin-bottom:10px">
            <input type="file" id="genDocFile" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx,.txt" style="min-width:260px">
            <button class="btn btn-ok" id="btnAddGenDoc"><i class="fa-solid fa-upload" aria-hidden="true"></i> Anexar</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Arquivo</th>
                <th>Tamanho</th>
                <th>Enviado em</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="genDocsTable"><tr><td colspan="4">‚Äî</td></tr></tbody>
          </table>
        </div>

        <!-- Pane: Documentos importantes -->
        <div class="emp-pane" id="paneDocsImportantes">
          <div class="imp-docs-form">
            <div>
              <label for="impDocFile">Arquivo</label>
              <input type="file" id="impDocFile" accept=".pdf,.png,.jpg,.jpeg">
            </div>
            <div>
              <label for="impDocName">Nome do documento</label>
              <input type="text" id="impDocName" placeholder="Ex.: CNH, ASO, Certid√£o">
            </div>
            <div>
              <label for="impDocType">Tipo</label>
              <select id="impDocType">
                <option value="CNH">CNH</option>
                <option value="ASO">ASO</option>
                <option value="Certid√£o">Certid√£o</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div>
              <label for="impDocIssue">Data de emiss√£o</label>
              <input type="date" id="impDocIssue">
            </div>
            <div>
              <label for="impDocDue">Data de validade</label>
              <input type="date" id="impDocDue">
            </div>
            <div>
              <button class="btn btn-ok" id="btnAddImpDoc">
                <i class="fa-solid fa-plus" aria-hidden="true"></i> Adicionar
              </button>
            </div>
          </div>

          <div class="filehint imp-bell" style="margin-bottom:6px">
            <i class="fa-regular fa-bell" aria-hidden="true"></i> Ative o sino por documento para ser avisado no vencimento.
          </div>

          <table class="table" style="margin-top:8px">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Emiss√£o</th>
                <th>Validade</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="impDocsTable"><tr><td colspan="5">‚Äî</td></tr></tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="fecharFuncionario">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Criar Tipo de Documento -->
  <div class="modal" id="modalNovoDoc" role="dialog" aria-modal="true" aria-labelledby="novoDocTitulo">
    <div class="modal-content">
      <div class="modal-header" id="novoDocTitulo">Criar tipo de documento</div>
      <div class="modal-body">
        <div class="row">
          <div class="col">
            <label for="tplNome">Nome do tipo</label>
            <input type="text" id="tplNome" placeholder="Ex.: Atestado, Termo de Responsabilidade">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="tplTexto">Conte√∫do do modelo</label>
            <textarea id="tplTexto" spellcheck="false" placeholder="Digite o conte√∫do do documento. Voc√™ pode usar {{nome}}, {{documento}} e {{data}} para preencher automaticamente."></textarea>
          </div>
        </div>
        <div class="filehint">Dica: use <b>{{nome}}</b>, <b>{{documento}}</b> e <b>{{data}}</b> como vari√°veis que ser√£o preenchidas.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="btnCancelarNovoDoc">Cancelar</button>
        <button class="btn btn-primary" id="btnSalvarNovoDoc"><i class="fa-regular fa-floppy-disk" aria-hidden="true"></i> Salvar tipo</button>
      </div>
    </div>
  </div>

  <!-- Modal Cadastro de Usu√°rio -->
  <div class="modal" id="modalCadastroUsuario" role="dialog" aria-modal="true" aria-labelledby="cadastroTitulo">
    <div class="modal-content">
      <div class="modal-header" id="cadastroTitulo">Cadastro de Usu√°rio</div>
      <div class="modal-body" id="modalCadastroBody"><!-- o bloco .gestao-cadastro ser√° movido aqui via JS --></div>
      <div class="modal-footer">
        <button class="btn btn-light" id="btnFecharCadastro">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Lembretes -->
  <div class="modal" id="modalAlerts" role="dialog" aria-modal="true" aria-labelledby="alertsTitulo">
    <div class="modal-content">
      <div class="modal-header" id="alertsTitulo">Lembretes</div>
      <div class="modal-body">
        <table class="table">
          <thead><tr><th>Funcion√°rio</th><th>Documento</th><th>Vencimento</th><th>Status</th><th>A√ß√µes</th></tr></thead>
          <tbody id="alertsTable"><tr><td colspan="5">Sem lembretes.</td></tr></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" id="btnCloseAlerts">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Tela p√∫blica de assinatura -->
  <div id="publicSign" class="public-sign" aria-live="polite">
    <div class="wrap">
      <div class="card">
        <div class="card-header">Assinar Documento</div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <label>Documento</label>
              <div id="pubDocTitle" class="kv-strong">‚Äî</div>
            </div>
            <div class="col">
              <label>Colaborador</label>
              <div id="pubDocWho" class="kv-strong">‚Äî</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Conte√∫do</label>
              <div id="pubDocText" class="doc-box scroll-styled" style="max-height:40vh"></div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>Assinatura</label>
              <div class="sig-toolbar" style="margin-bottom:6px">
                <button class="btn btn-light" id="btnLimparAssPublic">Limpar</button>
                <button class="btn btn-primary" id="btnBaixarPDFPublic"><i class="fa-regular fa-file-pdf" aria-hidden="true"></i> Assinar e baixar PDF</button>
              </div>
              <div class="sig-wrap"><canvas id="sigPadPublic"></canvas></div>
            </div>
          </div>
          <div class="inline-row mt-8">
            <button class="btn btn-light" id="btnFecharPublic"><i class="fa-solid fa-xmark" aria-hidden="true"></i> Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/* RCR Engenharia ‚Äî RH (JS corrigido e consolidado) */
/* eslint-disable no-unused-vars */
(() => {
  'use strict';

  /* ===================== REFS ===================== */
  const $ = (id) => document.getElementById(id);

  const uNome = $('uNome');
  const uFuncao = $('uFuncao');
  const helloNome = $('helloNome');

  const btnPeriodoAtual = $('btnPeriodoAtual');
  const btnAplicarFiltro = $('btnAplicarFiltro');
  const btnExportPonto = $('btnExportPonto');
  const pInicio = $('pInicio');
  const pFim = $('pFim');
  const kHoras = $('kHoras');
  const kSaldo = $('kSaldo');
  const kPend = $('kPend');

  const lblAgora = $('lblAgora');
  const lblCoord = $('lblCoord');
  const btnBaterPonto = $('btnBaterPonto');

  const sigPadEl = $('sigPad');
  const btnLimparAss = $('btnLimparAss');
  const btnGerarPDF = $('btnGerarPDF');
  const sigImport = $('sigImport');

  const tplImport = $('tplImport');
  const docTipo = $('docTipo');
  const docNome = $('docNome');
  const docDoc = $('docDoc');
  const docTexto = $('docTexto');

  const docHeaderTitle = $('docHeaderTitle');
  const docHeaderAlign = $('docHeaderAlign');
  const docFooterText = $('docFooterText');
  const docPageNums = $('docPageNums');
  const docHeaderLogo = $('docHeaderLogo');
  const btnSalvarLayoutDoc = $('btnSalvarLayoutDoc');

  const btnCriarTipoDoc = $('btnCriarTipoDoc');
  const modalNovoDoc = $('modalNovoDoc');
  const btnSalvarNovoDoc = $('btnSalvarNovoDoc');
  const btnCancelarNovoDoc = $('btnCancelarNovoDoc');
  const tplNome = $('tplNome');
  const tplTexto = $('tplTexto');

  const impDocFile = $('impDocFile');
  const impDocName = $('impDocName');
  const impDocType = $('impDocType');
  const impDocIssue = $('impDocIssue');
  const impDocDue = $('impDocDue');
  const btnAddImpDoc = $('btnAddImpDoc');
  const impDocsTable = $('impDocsTable');

  // >>> NOVO: Documentos simples (anexos gerais no modal do funcion√°rio)
  const genDocFile = $('genDocFile');
  const btnAddGenDoc = $('btnAddGenDoc');
  const genDocsTable = $('genDocsTable');
  // <<<

  const btnAlerts = $('btnAlerts');
  const notifDot = $('notifDot');
  const modalAlerts = $('modalAlerts');
  const alertsTable = $('alertsTable');
  const btnCloseAlerts = $('btnCloseAlerts');

  const btnHamb = $('btnHamb');
  const sidebar = $('sidebar');
  const btnCloseSidebar = $('btnCloseSidebar');

  const empGrid = $('empGrid');
  const funcSearch = $('funcSearch');
  const funcClear = $('funcClear');
  const funcSearchBtn = $('funcSearchBtn');
  const funcSearchGestao = $('funcSearchGestao');
  const funcClearGestao = $('funcClearGestao');
  const funcSearchGestaoBtn = $('funcSearchGestaoBtn');
  const empGridHostGestao = $('empGridHostGestao');

  const modalFuncionario = $('modalFuncionario');
  const funcModalNome = $('funcModalNome');
  const funcModalFuncao = $('funcModalFuncao');
  const funcModalAvatar = $('funcModalAvatar');
  const fecharFuncionario = $('fecharFuncionario');

  const btnAbrirCadastro = $('btnAbrirCadastro');
  const btnFecharCadastro = $('btnFecharCadastro');
  const modalCadastroUsuario = $('modalCadastroUsuario');
  const modalCadastroBody = $('modalCadastroBody');

  const cadFoto = $('cadFoto');
  const cadFotoPreview = $('cadFotoPreview');
  const cadNome = $('cadNome');
  const cadFuncao = $('cadFuncao');
  const cadRG = $('cadRG');
  const cadCPF = $('cadCPF');
  const cadIdade = $('cadIdade');
  const cadCargo = $('cadCargo');
  const cadSalario = $('cadSalario');
  const cadOptVR = $('cadOptVR');
  const cadOptVT = $('cadOptVT');
  const cadAdmissao = $('cadAdmissao');
  const cadVtUnit = $('cadVtUnit');
  const cadVrDaily = $('cadVrDaily');
  const cadDocumento = $('cadDocumento');
  const btnSalvarCadastro = $('btnSalvarCadastro');
  const btnLimparCadastro = $('btnLimparCadastro');

  /* VT */
  const vtUnit = $('vtUnit');
  const vtCreditDay = $('vtCreditDay');
  const vtBody = $('vtBody');
  const vtKColab = $('vtKColab');
  const vtKQtd = $('vtKQtd');
  const vtKValor = $('vtKValor');
  const vtSumQtd = $('vtSumQtd');
  const vtSumValor = $('vtSumValor');
  const btnExportVTCSV = $('btnExportVTCSV');
  const btnExportVTPDF = $('btnExportVTPDF');

  /* VR */
  const vrDaily = $('vrDaily');
  const vrDays = $('vrDays');
  const vrPct = $('vrPct');
  const vrCreditDay = $('vrCreditDay');
  const vrCapDiscount = $('vrCapDiscount');
  const vrBody = $('vrBody');
  const vrKAdesoes = $('vrKAdesoes');
  const vrKBeneficio = $('vrKBeneficio');
  const vrKDesconto = $('vrKDesconto');
  const vrKLiquido = $('vrKLiquido');
  const vrSumBeneficio = $('vrSumBeneficio');
  const vrSumDesconto = $('vrSumDesconto');
  const vrSumLiquido = $('vrSumLiquido');
  const btnExportVRCSV = $('btnExportVRCSV');
  const btnExportVRPDF = $('btnExportVRPDF');

  /* Ponto (detalhes) */
  const modalBat = $('modalBatimentosDia');
  const batimentosDiaTitulo = $('batimentosDiaTitulo');
  const batimentosDiaBody = $('batimentosDiaBody');
  const batimentosDatePicker = $('batimentosDatePicker');
  const fecharBatimentosDia = $('fecharBatimentosDia');
  const btnPrevDia = $('btnPrevDia');
  const btnNextDia = $('btnNextDia');
  const incluirPontoDia = $('incluirPontoDia');
  const justificarAusenciaDia = $('justificarAusenciaDia');

  /* Public sign */
  const btnGerarLinkAss = $('btnGerarLinkAss');
  const btnCopiarLinkAss = $('btnCopiarLinkAss');
  const assLink = $('assLink');
  const publicSign = $('publicSign');
  const pubDocTitle = $('pubDocTitle');
  const pubDocWho = $('pubDocWho');
  const pubDocText = $('pubDocText');
  const btnLimparAssPublic = $('btnLimparAssPublic');
  const btnFecharPublic = $('btnFecharPublic');
  const btnBaixarPDFPublic = $('btnBaixarPDFPublic');

  /* Extras */
  const toastRoot = $('toastContainer');


  // [FIX] Sistema de abas robusto + registro da aba "funcionarios"
function ensureTab(id, label) {
  const nav = document.querySelector('#leftNav, nav, .sidebar'); // ajuste se necess√°rio
  const main = document.querySelector('#main, main, .content');  // ajuste se necess√°rio
  if (!nav || !main) return;

  // bot√£o da aba
  let btn = nav.querySelector(`[data-tab="${id}"]`);
  if (!btn) {
    btn = document.createElement('button');
    btn.type = 'button';
    btn.dataset.tab = id;
    btn.id = `tabBtn-${id}`;
    btn.className = 'nav-btn';
    btn.textContent = label;
    nav.appendChild(btn);
  }

  // container da aba
  let tab = document.querySelector(`#tab-${id}`);
  if (!tab) {
    tab = document.createElement('section');
    tab.id = `tab-${id}`;
    tab.className = 'tab';
    tab.hidden = true;
    tab.innerHTML = `
      <h2>Funcion√°rios</h2>
      <div id="funcGrid"></div>
      <div id="funcMiniModal" hidden></div>
    `;
    main.appendChild(tab);
  }
}

function showTab(name) {
  document.querySelectorAll('.tab').forEach(el => (el.hidden = true));
  document.querySelectorAll('[data-tab]').forEach(b => b.classList?.remove('active'));
  const sec = document.querySelector(`#tab-${name}`);
  const btn = document.querySelector(`[data-tab="${name}"]`);
  if (sec) sec.hidden = false;
  btn?.classList?.add('active');
}

function wireTabs() {
  const nav = document.querySelector('#leftNav, nav, .sidebar');
  if (!nav || nav.__wired) return;
  nav.__wired = true;
  nav.addEventListener('click', (e) => {
    const t = e.target.closest('[data-tab]');
    if (!t) return;
    e.preventDefault();
    showTab(t.dataset.tab);
    if (t.dataset.tab === 'funcionarios') {
      initFuncionarios?.(); // n√£o quebra se n√£o existir
    }
  });
}

// chame no boot:
ensureTab('funcionarios', 'Gest√£o de Funcion√°rios');
wireTabs();
// se quiser j√° abrir essa aba ao carregar, depois do boot:
try { showTab('funcionarios'); } catch {}

  /* ===================== UTILS ===================== */
  const two = (n) => String(n).padStart(2, '0');
  const toYMD = (d) => d.getFullYear() + '-' + two(d.getMonth() + 1) + '-' + two(d.getDate());
  const fromYMD = (s) => {
    const [y, m, d] = String(s || '').split('-').map(Number);
    return new Date(y, (m || 1) - 1, d || 1);
  };
  const nowTime = () => {
    const n = new Date();
    return `${two(n.getHours())}:${two(n.getMinutes())}:${two(n.getSeconds())}`;
  };
  const todayYMD = () => toYMD(new Date());
  const diffHHMM = (mins) => {
    const sign = mins < 0 ? '-' : '';
    const a = Math.abs(mins);
    const h = Math.floor(a / 60),
      m = a % 60;
    return sign + two(h) + ':' + two(m);
  };
  const brDate = (d) =>
    d.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });

  const escapeHTML = (str) =>
    String(str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

  const bytesHuman = (b) => {
    if (b < 1024) return b + ' B';
    const kb = b / 1024;
    if (kb < 1024) return kb.toFixed(1) + ' KB';
    const mb = kb / 1024;
    return mb.toFixed(1) + ' MB';
  };

  const slugify = (s) =>
    (s || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 40) || 'tipo-' + Date.now();

  /* ===================== TOAST ===================== */
  function notify(message, type = 'info', { duration = 3400 } = {}) {
    if (!window.__nativeAlert) {
      // preserva o alert nativo antes de qualquer override
      window.__nativeAlert = window.alert.bind(window);
    }
    function notify(msg) {
      try {
        // Se voc√™ tiver um toast/snackbar, chame aqui
        console.log('[notify]', msg);
      } catch (e) {
        __nativeAlert(String(msg));
      }
    }
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.innerHTML = `
      <div class="msg">${escapeHTML(String(message))}</div>
      <span class="close">&times;</span>
    `;
    toastRoot.appendChild(el);
    setTimeout(() => el.classList.add('show'), 10);
    const t = setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 200);
    }, duration);
    el.querySelector('.close').onclick = () => {
      clearTimeout(t);
      el.classList.remove('show');
      setTimeout(() => el.remove(), 200);
    };
  }
  window.alert = (msg) => notify(msg, 'info');

  /* ===================== STORAGE KEYS ===================== */
  const LS_KEYS = {
    ME: 'rh_me',
    PUNCHES: 'batimentos',
    FUNCS: 'rh_funcionarios'
  };
  const KEY_DOC_TEMPLATES = 'rh_doc_templates';
  const KEY_DOC_LAYOUT = 'rh_doc_layout';
  const KEY_DOCS_IMPORT = 'rh_docs_important'; // por funcion√°rio
  const KEY_ALERTS = 'rh_alerts';
  // >>> NOVO: documentos simples anexados (por funcion√°rio)
  const KEY_GEN_DOCS = 'rh_docs_general';
  // <<<

  /* VT/VR */
  const KEY_VT_SETTINGS = 'rh_benef_vt_settings';
  const KEY_VT_MAP = 'rh_benef_vt';
  const KEY_VR_SETTINGS = 'rh_benef_vr_settings';
  const KEY_VR_MAP = 'rh_benef_vr';

  /* ===================== STORAGE HELPERS ===================== */
  const getMe = () =>
    JSON.parse(localStorage.getItem(LS_KEYS.ME) || '{"nome":"Gustavo (exemplo)","funcao":"Colaborador"}');
  const setMe = (o) => localStorage.setItem(LS_KEYS.ME, JSON.stringify(o || {}));

  const getAllPunches = () => JSON.parse(localStorage.getItem(LS_KEYS.PUNCHES) || '[]');
  const setAllPunches = (a) => localStorage.setItem(LS_KEYS.PUNCHES, JSON.stringify(a || []));

  const getTemplates = () => JSON.parse(localStorage.getItem(KEY_DOC_TEMPLATES) || '[]');
  const setTemplates = (a) => localStorage.setItem(KEY_DOC_TEMPLATES, JSON.stringify(a || []));

  const getImpDocsMap = () => JSON.parse(localStorage.getItem(KEY_DOCS_IMPORT) || '{}');
  const setImpDocsMap = (o) => localStorage.setItem(KEY_DOCS_IMPORT, JSON.stringify(o || {}));

  // >>> NOVO: docs simples (anexos gerais)
  const getGenDocsMap = () => JSON.parse(localStorage.getItem(KEY_GEN_DOCS) || '{}');
  const setGenDocsMap = (o) => localStorage.setItem(KEY_GEN_DOCS, JSON.stringify(o || {}));
  // <<<

  const getAlerts = () => JSON.parse(localStorage.getItem(KEY_ALERTS) || '[]');
  const setAlerts = (a) => localStorage.setItem(KEY_ALERTS, JSON.stringify(a || []));

  const uid = (p = 'id') => `${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 6)}`;

  let __docsAppMounted = false;
  function mountDocsApp(){

    // Dentro de mountDocsApp(), logo ap√≥s pegar o root:
    const root = document.getElementById('docs-sign-root');
    if (root) root.classList.add('docs-shell');

    // S√≥ isola em <iframe> se DOCS_APP_HTML existir.
    const hasIsolatedApp = typeof window.DOCS_APP_HTML !== 'undefined' && window.DOCS_APP_HTML;
    if (!hasIsolatedApp) {
      // Usa o markup inline j√° presente na p√°gina (fallback seguro)
      root.style.display = 'block';
      root.style.height = '100%';
      __docsAppMounted = true;
      return;
    }

    // Caso voc√™ passe a injetar o app isolado, este trecho continua funcionando.
    const blob = new Blob([window.DOCS_APP_HTML], { type: 'text/html' });
    const url  = URL.createObjectURL(blob);

    const ifr = document.createElement('iframe');
    ifr.src = url;
    ifr.title = 'Documentos & Assinaturas';
    ifr.style.width  = '100%';
    ifr.style.height = '100%';
    ifr.style.border = '0';

    root.innerHTML = '';
    root.appendChild(ifr);
    __docsAppMounted = true;

    ifr.addEventListener('load', () => { try{ URL.revokeObjectURL(url); }catch{} }, { once:true });
  }


  /* ===================== MENU / TABS ===================== */
  btnHamb?.addEventListener('click', () => {
    sidebar?.classList.toggle('active');
    document.body.classList.toggle('sidebar-open');
  });
  btnCloseSidebar?.addEventListener('click', () => {
    sidebar?.classList.remove('active');
    document.body.classList.remove('sidebar-open');
  });

  document.getElementById('menu')?.addEventListener('click', (e) => {
    const clickedRowHead = e.target.closest('.row-head');
    const rootItem = e.target.closest('li.has-submenu');
    const clickedSubItem = e.target.closest('ul.submenu > li[data-tab]');
    if (clickedRowHead && rootItem) {
      rootItem.classList.toggle('open');
      rootItem.classList.add('active');
      return;
    }
    const li = e.target.closest('li[data-tab]');
    if (!li) return;

    if (li.classList.contains('has-submenu') && !clickedSubItem) {
      li.classList.toggle('open');
      li.classList.add('active');
      return;
    }

    document.querySelectorAll('.menu li, .menu li .submenu li').forEach((x) => x.classList.remove('active'));
    li.classList.add('active');
    const parentRoot = li.closest('li.has-submenu');
    if (parentRoot) {
      parentRoot.classList.add('active');
      parentRoot.classList.add('open');
    }

    const tab = li.getAttribute('data-tab');
    document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
    document.getElementById(tab)?.classList.add('active');

    if (window.innerWidth <= 960) {
      sidebar?.classList.remove('active');
      document.body.classList.remove('sidebar-open');
    }

    if (tab === 'tabIncluir' && !mapInited) initMap();
    if (tab === 'tabDocs') {
      // carrega o novo m√≥dulo (uma √∫nica vez)
      mountDocsApp();
    }
    if (tab === 'tabVT') renderVT();
    if (tab === 'tabVR') renderVR();

    /* move a grade entre Gest√£o e Gerenciar */
    try {
      const grid = empGrid;
      if (tab === 'tabFuncGestao') {
        const host = empGridHostGestao;
        if (host && grid && host !== grid.parentElement) host.appendChild(grid);
      } else if (tab === 'tabFuncionarios') {
        const body = document.querySelector('#tabFuncionarios .card-body');
        if (body && grid && !body.contains(grid)) body.appendChild(grid);
      }
    } catch {}
    if (tab === 'tabPonto') setTimeout(fitPontoTableToViewport, 60);
  });

  /* ===================== REL√ìGIO ===================== */
  function tick() {
    $('nowClock') && ($('nowClock').textContent = nowTime());
    lblAgora && (lblAgora.textContent = new Date().toLocaleString('pt-BR'));
  }
  setInterval(tick, 1000);
  tick();

  /* ===================== PERFIL ===================== */
  (function initMe() {
    const me = getMe();
    if (uNome) uNome.textContent = me.nome || 'Colaborador(a)';
    if (uFuncao) uFuncao.textContent = me.funcao || 'Fun√ß√£o';
    if (helloNome) helloNome.textContent = me.nome || 'Colaborador(a)';
  })();

  /* ===================== SEED BATIMENTOS ===================== */
  if (getAllPunches().length === 0) {
    const seed = [];
    const base = new Date();
    base.setDate(base.getDate() - 7);
    for (let i = 0; i < 10; i++) {
      const d = new Date(base);
      d.setDate(base.getDate() + i);
      const ymd = toYMD(d);
      if (d.getDay() !== 0) {
        seed.push({ date: ymd, time: '09:00', type: 'Entrada', origin: 'Web', note: '' });
        seed.push({ date: ymd, time: '12:00', type: 'Sa√≠da', origin: 'Web', note: 'Almo√ßo' });
        seed.push({ date: ymd, time: '13:00', type: 'Entrada', origin: 'Web', note: '' });
        seed.push({ date: ymd, time: '18:00', type: 'Sa√≠da', origin: 'Web', note: '' });
      }
    }
    setAllPunches(seed);
  }

  /* ===================== CART√ÉO DE PONTO ===================== */
  const tPontoBody = document.querySelector('#tPonto tbody');

  function setDefaultPeriod() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 14);
    pInicio && (pInicio.value = toYMD(start));
    pFim && (pFim.value = toYMD(end));
  }
  btnPeriodoAtual?.addEventListener('click', () => {
    setDefaultPeriod();
    renderPonto();
  });
  btnAplicarFiltro?.addEventListener('click', renderPonto);
  setDefaultPeriod();

  function punchesByDate(ymd) {
    return getAllPunches()
      .filter((b) => b.date === ymd)
      .sort((a, b) => a.time.localeCompare(b.time));
  }
  function calcSaldoMinsForDay(list) {
    let mins = 0,
      lastIn = null;
    for (const b of list) {
      if (b.type === 'Entrada') lastIn = b.time;
      else if (b.type === 'Sa√≠da' && lastIn) {
        const [h1, m1] = lastIn.split(':').map(Number);
        const [h2, m2] = b.time.split(':').map(Number);
        mins += h2 * 60 + m2 - (h1 * 60 + m1);
        lastIn = null;
      }
    }
    return mins;
  }
  function statusForDay(list) {
    if (list.length === 0) return { cls: 'warn', tip: 'Sem marca√ß√µes' };
    const first = list[0].type,
      last = list[list.length - 1].type;
    if (first === 'Sa√≠da' || last === 'Entrada') return { cls: 'err', tip: 'Pend√™ncias' };
    return { cls: 'ok', tip: 'OK' };
  }
  function dayRow(list, ymd) {
    const entries = list.filter((b) => b.type === 'Entrada').map((b) => b.time);
    const exits = list.filter((b) => b.type === 'Sa√≠da').map((b) => b.time);
    const saldo = diffHHMM(calcSaldoMinsForDay(list));
    const stat = statusForDay(list);
    const d = fromYMD(ymd);
    const br = d.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit' });
    return `<tr class="row-dia" data-date="${ymd}" title="Clique para detalhar">
      <td><span class="status-dot ${stat.cls}" title="${stat.tip}"></span></td>
      <td>${br}</td>
      <td>${entries[0] || ''}</td><td>${exits[0] || ''}</td>
      <td>${entries[1] || ''}</td><td>${exits[1] || ''}</td>
      <td>${entries[2] || ''}</td><td>${exits[2] || ''}</td>
      <td>${saldo}</td>
    </tr>`;
  }
  function renderPonto() {
    if (!tPontoBody) return;
    const ini = fromYMD(pInicio?.value || todayYMD());
    const fim = fromYMD(pFim?.value || todayYMD());
    if (fim < ini) {
      notify('Per√≠odo inv√°lido.', 'warn');
      return;
    }
    let html = '',
      totalMins = 0,
      pend = 0;
    for (let d = new Date(ini); d <= fim; d.setDate(d.getDate() + 1)) {
      const ymd = toYMD(d);
      const list = punchesByDate(ymd);
      html += dayRow(list, ymd);
      const st = statusForDay(list);
      if (st.cls !== 'ok') pend++;
      totalMins += calcSaldoMinsForDay(list);
    }
    tPontoBody.innerHTML =
      html || `<tr><td colspan="9" style="color:#9fb1c3">Sem registros no per√≠odo.</td></tr>`;
    kHoras && (kHoras.textContent = diffHHMM(totalMins));
    kSaldo && (kSaldo.textContent = diffHHMM(totalMins));
    kPend && (kPend.textContent = String(pend));
  }
  renderPonto();

  /* abrir modal do dia */
  document.addEventListener('click', (ev) => {
    const row = ev.target.closest('.row-dia[data-date]');
    if (!row) return;
    openBatimentosDia(row.getAttribute('data-date'));
  });

  function getPunchesForDate(ymd) {
    return punchesByDate(ymd).map((b, i) => ({ idx: i + 1, ...b }));
  }
  function openBatimentosDia(ymd) {
    if (!modalBat) return;
    const d = fromYMD(ymd);
    batimentosDiaTitulo && (batimentosDiaTitulo.textContent = 'Batimentos de ' + brDate(d));
    batimentosDatePicker && (batimentosDatePicker.value = ymd);
    const rows = getPunchesForDate(ymd);
    if (batimentosDiaBody) {
      batimentosDiaBody.innerHTML = rows.length
        ? rows
            .map(
              (r) =>
                `<tr><td>${r.idx}</td><td>${r.type}</td><td>${r.time}</td><td>${r.origin || '-'}</td><td>${
                  r.note || '-'
                }</td></tr>`
            )
            .join('')
        : `<tr><td colspan="5" style="color:#9fb1c3">Nenhum batimento para este dia.</td></tr>`;
    }
    modalBat.style.display = 'flex';
  }
  function closeBatimentosDia() {
    modalBat && (modalBat.style.display = 'none');
  }
  fecharBatimentosDia?.addEventListener('click', closeBatimentosDia);
  btnPrevDia?.addEventListener('click', () => {
    const d = fromYMD(batimentosDatePicker?.value || todayYMD());
    d.setDate(d.getDate() - 1);
    openBatimentosDia(toYMD(d));
  });
  btnNextDia?.addEventListener('click', () => {
    const d = fromYMD(batimentosDatePicker?.value || todayYMD());
    d.setDate(d.getDate() + 1);
    openBatimentosDia(toYMD(d));
  });
  batimentosDatePicker?.addEventListener('change', (e) => e.target.value && openBatimentosDia(e.target.value));
  incluirPontoDia?.addEventListener('click', () => {
    closeBatimentosDia();
    document.querySelector('.menu li[data-tab="tabIncluir"]')?.click();
  });
  justificarAusenciaDia?.addEventListener('click', () =>
    notify('Abrir fluxo de justificativa (integra√ß√£o futura).', 'info')
  );

  /* Exportar Cart√£o em PDF */
  async function imgElToDataURL_FIX(src) {
    return new Promise((resolve) => {
      const img = new Image();
      try {
        const u = new URL(src, location.href);
        if (u.origin !== location.origin) img.crossOrigin = 'anonymous';
      } catch {}
      img.onload = () => {
        try {
          const c = document.createElement('canvas');
          c.width = img.naturalWidth;
          c.height = img.naturalHeight;
          c.getContext('2d').drawImage(img, 0, 0);
          resolve(c.toDataURL('image/png'));
        } catch {
          resolve(null);
        }
      };
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }
  async function getCompanyLogoDataURL() {
    const el = document.querySelector('.brand-logo');
    if (el && el.complete && el.naturalWidth) {
      try {
        const c = document.createElement('canvas');
        c.width = el.naturalWidth;
        c.height = el.naturalHeight;
        c.getContext('2d').drawImage(el, 0, 0);
        return c.toDataURL('image/png');
      } catch {}
    }
    if (el && el.src) {
      const d = await imgElToDataURL_FIX(el.src);
      if (d) return d;
    }
    const splash = document.querySelector('.splash-logo');
    if (splash && splash.src) {
      const d = await imgElToDataURL_FIX(splash.src);
      if (d) return d;
    }
    return await imgElToDataURL_FIX('Assets/img/logo_new.png');
  }

  btnExportPonto?.addEventListener('click', async () => {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF n√£o carregado.', 'error');
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const mx = 28;
    let y = 22;

    doc.setFillColor(245, 246, 250);
    doc.rect(0, 0, pageW, 70, 'F');

    const logo = await getCompanyLogoDataURL();
    if (logo) {
      const fmtMatch = /^data:image\/(png|jpeg|jpg|webp)/i.exec(logo);
      doc.addImage(logo, (fmtMatch ? fmtMatch[1] : 'png').toUpperCase(), mx, 16, 120, 40);
    } else {
      doc.setDrawColor(160);
      doc.rect(mx, 16, 120, 40);
    }

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('CART√ÉO PONTO', pageW - mx, 32, { align: 'right' });
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Per√≠odo: ${pInicio?.value} at√© ${pFim?.value}`, pageW - mx, 50, { align: 'right' });

    const me = getMe();
    const empresaNome = document.querySelector('.brand strong')?.textContent?.trim() || 'RCR ENGENHARIA';

    function kvRow(x, lab, val, x2, lab2, val2) {
      const lh = 14;
      doc.setFont('helvetica', 'bold');
      doc.text(lab, x, y);
      doc.setFont('helvetica', 'normal');
      doc.text(val, x + 82, y);
      if (lab2) {
        doc.setFont('helvetica', 'bold');
        doc.text(lab2, x2, y);
        doc.setFont('helvetica', 'normal');
        doc.text(val2, x2 + 82, y);
      }
      y += lh;
    }

    y = 88;
    kvRow(mx, 'EMPRESA:', empresaNome);
    kvRow(mx, 'NOME:', me.nome || 'Colaborador(a)');
    kvRow(mx, 'FUN√á√ÉO:', me.funcao || '‚Äî');
    kvRow(mx, 'OBSERVA√á√ÉO:', '');
    y += 6;

    const tableX = mx;
    const tableW = pageW - 2 * mx;
    const rowH = 18;
    const cols = [
      { w: 74, title: 'DATA' },
      { w: 52, title: 'E1' },
      { w: 52, title: 'S1' },
      { w: 52, title: 'E2' },
      { w: 52, title: 'S2' },
      { w: 52, title: 'E3' },
      { w: 52, title: 'S3' },
      { w: 51, title: 'SALDO' },
      { w: 51, title: 'FALTAS' },
      { w: 51, title: 'NOT.TOT.' }
    ];

    doc.setFillColor(230, 232, 236);
    doc.rect(tableX, y, tableW, rowH, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    let cx = tableX + 6;
    cols.forEach((c) => {
      doc.text(c.title, cx, y + 12);
      cx += c.w;
    });
    doc.setDrawColor(180);
    doc.rect(tableX, y, tableW, rowH);
    y += rowH;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    let totalMins = 0;

    const ini = fromYMD(pInicio?.value || todayYMD());
    const fim = fromYMD(pFim?.value || todayYMD());

    for (let d = new Date(ini); d <= fim; d.setDate(d.getDate() + 1)) {
      const ymd = toYMD(d);
      const list = punchesByDate(ymd);
      const entries = list.filter((b) => b.type === 'Entrada').map((b) => b.time);
      const exits = list.filter((b) => b.type === 'Sa√≠da').map((b) => b.time);

      const vals = {
        e1: entries[0] || '',
        s1: exits[0] || '',
        e2: entries[1] || '',
        s2: exits[1] || '',
        e3: entries[2] || '',
        s3: exits[2] || '',
        saldo: ''
      };

      if (list.length) {
        const mins = calcSaldoMinsForDay(list);
        totalMins += mins;
        vals.saldo = mins === 0 ? '00:00' : diffHHMM(mins);
      } else {
        vals.e1 = vals.s1 = vals.e2 = vals.s2 = vals.e3 = vals.s3 = 'FOLGA';
        vals.saldo = '';
      }

      const dtLabel =
        d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) +
        ' - ' +
        d.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');

      if (y > pageH - 80) {
        doc.addPage();
        y = 40;
        doc.setFillColor(230, 232, 236);
        doc.rect(tableX, y, tableW, rowH, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        let cxh = tableX + 6;
        cols.forEach((c) => {
          doc.text(c.title, cxh, y + 12);
          cxh += c.w;
        });
        doc.setDrawColor(180);
        doc.rect(tableX, y, tableW, rowH);
        y += rowH;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
      }

      doc.setDrawColor(210);
      doc.rect(tableX, y, tableW, rowH);

      let tx = tableX + 6;
      doc.text(dtLabel, tx, y + 12);
      tx += cols[0].w;

      const values = [vals.e1, vals.s1, vals.e2, vals.s2, vals.e3, vals.s3, vals.saldo, '', ''];
      for (let i = 1; i < cols.length; i++) {
        const w = cols[i].w;
        doc.text(String(values[i - 1] || ''), tx + w / 2, y + 12, { align: 'center' });
        tx += w;
      }
      y += rowH;
    }

    if (y > pageH - 70) {
      doc.addPage();
      y = 40;
    }
    doc.setDrawColor(0);
    doc.setLineWidth(0.8);
    doc.line(mx, y + 6, pageW - mx, y + 6);
    y += 20;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text('TOTAIS', mx, y);
    doc.setFont('helvetica', 'normal');
    doc.text(`Horas no per√≠odo: ${diffHHMM(totalMins)}`, mx + 70, y);

    const me2 = getMe();
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text(me2.nome || 'Colaborador(a)', mx, pageH - 24);
    doc.text(empresaNome, pageW - mx, pageH - 24, { align: 'right' });

    doc.save('folha_de_ponto.pdf');
  });

  /* ===================== MAPA & GEO ===================== */
  let mapInited = false,
    map,
    marker;

 function initMap() {
  if (mapInited) return;
  mapInited = true;

  const skel = document.querySelector('#map .map-skeleton');

  const last = JSON.parse(localStorage.getItem('lastLatLng') || 'null');
  map = L.map('map', { zoomControl: true, preferCanvas: true });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 })
    .addTo(map)
    .on('load', () => skel?.remove()); // <<< remove skeleton ao carregar

  const fallback = last || [-23.5619, -46.6564];
  map.setView(fallback, last ? 16 : 13);
  if (last) marker = L.marker(last).addTo(map);

  const GEO_OPTS = { enableHighAccuracy: false, maximumAge: 180000, timeout: 7000 };
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        if (!marker) marker = L.marker(latlng).addTo(map); else marker.setLatLng(latlng);
        map.setView(latlng, 17);
        localStorage.setItem('lastLatLng', JSON.stringify(latlng));
        lblCoord && (lblCoord.textContent = latlng[0].toFixed(5) + ', ' + latlng[1].toFixed(5));
        skel?.remove(); // <<< garante remo√ß√£o
      },
      () => {}
      , GEO_OPTS
    );
  }
}


  function nextTypeFor(dateYMD) {
    const list = punchesByDate(dateYMD);
    if (list.length === 0) return 'Entrada';
    return list[list.length - 1].type === 'Entrada' ? 'Sa√≠da' : 'Entrada';
  }
  btnBaterPonto?.addEventListener('click', () => {
    const ymd = todayYMD();
    const next = nextTypeFor(ymd);
    const list = punchesByDate(ymd);
    const eCount = list.filter((b) => b.type === 'Entrada').length;
    const sCount = list.filter((b) => b.type === 'Sa√≠da').length;
    if (next === 'Entrada' && eCount >= 3) return notify('Limite atingido: 3 entradas.', 'error');
    if (next === 'Sa√≠da' && sCount >= 3) return notify('Limite atingido: 3 sa√≠das.', 'error');

    let lat = '--',
      lon = '--';
    if (map && map.getCenter()) {
      const c = map.getCenter();
      lat = c.lat.toFixed(5);
      lon = c.lng.toFixed(5);
    }
    const all = getAllPunches();
    all.push({ date: ymd, time: nowTime().slice(0, 5), type: next, origin: 'Web', note: `GPS ${lat},${lon}` });
    setAllPunches(all);
    renderPonto();
    openBatimentosDia(ymd);
  });

  /* ===================== MODELOS & DOCS ===================== */
  function modeloTexto(tipo, nome, documento) {
    const hoje = new Date().toLocaleDateString('pt-BR');
    if (tipo === 'interesse')
      return `DECLARA√á√ÉO DE INTERESSE

Eu, ${nome} (doc. ${documento}), declaro para os devidos fins que tenho interesse em participar do processo/atividade em refer√™ncia, estando ciente das condi√ß√µes e responsabilidades envolvidas.

Local e data: ____________________, ${hoje}
Assinatura: ____________________________`;
    if (tipo === 'anuencia')
      return `CARTA DE ANU√äNCIA

Eu, ${nome} (doc. ${documento}), declaro que estou ciente e anuente quanto √†(s) condi√ß√µes apresentada(s), n√£o havendo qualquer oposi√ß√£o quanto √† continuidade dos tr√¢mites.

Local e data: ____________________, ${hoje}
Assinatura: ____________________________`;
    if (tipo === 'dividas')
      return `DECLARA√á√ÉO DE AUS√äNCIA DE D√çVIDAS

Eu, ${nome} (doc. ${documento}), declaro, sob as penas da lei, n√£o possuir quaisquer d√©bitos/d√≠vidas em aberto junto √† empresa/entidade, at√© a presente data.

Local e data: ____________________, ${hoje}
Assinatura: ____________________________`;

    if (tipo?.startsWith('tpl:')) {
      const slug = tipo.slice(4);
      const tpl = getTemplates().find((t) => t.id === slug);
      if (tpl) {
        return (tpl.content || '')
          .replaceAll('{{nome}}', nome)
          .replaceAll('{{documento}}', documento || '________________')
          .replaceAll('{{data}}', hoje);
      }
    }
    return '';
    }
  function refreshTexto() {
    const nome = docNome?.value || getMe().nome || '________________';
    const documento = docDoc?.value || '________________';
    if (docTexto) docTexto.value = modeloTexto(docTipo?.value, nome, documento);
  }
  docTipo?.addEventListener('change', () => {
    refreshTexto();
    fitDocTextarea();
  });
  [docNome, docDoc].forEach((e) => e?.addEventListener('input', refreshTexto));

  /* Altura din√¢mica */
  function fitDocTextarea() {
    const ta = docTexto;
    if (!ta) return;
    const isMobile = window.innerWidth <= 960;
    if (isMobile) {
      const h = Math.max(180, Math.floor(window.innerHeight * 0.45));
      ta.style.height = h + 'px';
      ta.style.maxHeight = '60vh';
    } else {
      const rect = ta.getBoundingClientRect();
      const newH = Math.max(220, Math.floor(window.innerHeight - rect.top - 24));
      ta.style.height = newH + 'px';
      ta.style.maxHeight = '';
    }
    ta.classList.add('scroll-styled');
    ta.style.resize = 'vertical';
  }
  window.addEventListener('resize', fitDocTextarea);

  /* SignaturePad */
  let sigPad = null;
  function initSig() {
    if (!sigPadEl) return;
    const canvas = sigPadEl;
    function fit() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      if (sigPad) sigPad.clear();
    }
    window.addEventListener('resize', fit);
    fit();
    sigPad = new SignaturePad(canvas, { minWidth: 1.2, maxWidth: 2.5, penColor: '#eaf6ff', backgroundColor: 'rgba(0,0,0,0)' });
  }
  function resizeSigCanvas() {
    if (!sigPad) return;
    const canvas = sigPadEl;
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
    sigPad.clear();
  }
  setTimeout(initSig, 300);
  btnLimparAss?.addEventListener('click', () => sigPad && sigPad.clear());

  async function fileToDataURL(file) {
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }
  sigImport?.addEventListener('change', async (e) => {
    if (!sigPad || !e.target.files || !e.target.files[0]) return;
    const dataURL = await fileToDataURL(e.target.files[0]);
    try {
      sigPad.fromDataURL(dataURL, { ratio: 1, width: sigPadEl.offsetWidth, height: sigPadEl.offsetHeight });
    } catch {}
  });

  /* Layout (cabe√ßalho/rodap√©) */
  const defaultLayout = () => ({
    headerTitle: '',
    headerAlign: 'left', // left|center|right
    footerText: '',
    pageNums: 'none', // none|p_de_n|p_simples
    headerLogo: 'auto' // auto|off
  });
  const getDocLayout = () => {
    try {
      return Object.assign(defaultLayout(), JSON.parse(localStorage.getItem(KEY_DOC_LAYOUT) || '{}'));
    } catch {
      return defaultLayout();
    }
  };
  const setDocLayout = (o) => localStorage.setItem(KEY_DOC_LAYOUT, JSON.stringify(o || {}));
  function applyLayoutToUI() {
    const l = getDocLayout();
    if (docHeaderTitle) docHeaderTitle.value = l.headerTitle || '';
    if (docHeaderAlign) docHeaderAlign.value = l.headerAlign || 'left';
    if (docFooterText) docFooterText.value = l.footerText || '';
    if (docPageNums) docPageNums.value = l.pageNums || 'none';
    if (docHeaderLogo) docHeaderLogo.value = l.headerLogo || 'auto';
  }
  function readLayoutFromUI() {
    return {
      headerTitle: docHeaderTitle?.value || '',
      headerAlign: docHeaderAlign?.value || 'left',
      footerText: docFooterText?.value || '',
      pageNums: docPageNums?.value || 'none',
      headerLogo: docHeaderLogo?.value || 'auto'
    };
  }
  btnSalvarLayoutDoc?.addEventListener('click', () => {
    setDocLayout(readLayoutFromUI());
    notify('Layout salvo como padr√£o.', 'success');
  });

  /* Gerar PDF assinado (com layout) */
  btnGerarPDF?.addEventListener('click', async (ev) => {
    ev.preventDefault();
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF n√£o carregado.', 'error');

    const layout = Object.assign(getDocLayout(), readLayoutFromUI());

    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const margin = 56;
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const contentW = pageW - margin * 2;
    const lineH = 16;

    const mapTitle = {
      interesse: 'DECLARA√á√ÉO DE INTERESSE',
      anuencia: 'CARTA DE ANU√äNCIA',
      dividas: 'DECLARA√á√ÉO DE AUS√äNCIA DE D√çVIDAS'
    };
    const tituloBase =
      (mapTitle[docTipo?.value] || docTipo?.options?.[docTipo.selectedIndex]?.text || 'DOCUMENTO').toUpperCase();
    const tituloHeader = layout.headerTitle || tituloBase;

    const logo = layout.headerLogo !== 'off' ? await getCompanyLogoDataURL() : null;
    function drawHeader() {
      const yTop = 30;
      if (logo) {
        try {
          const fmtMatch = /^data:image\/(png|jpeg|jpg|webp)/i.exec(logo);
          doc.addImage(logo, (fmtMatch ? fmtMatch[1] : 'png').toUpperCase(), margin, yTop - 6, 80, 26);
        } catch {}
      }
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      let x = margin;
      if (layout.headerAlign === 'center') x = pageW / 2;
      if (layout.headerAlign === 'right') x = pageW - margin;
      doc.text(String(tituloHeader), x, yTop + 14, { align: layout.headerAlign });
      doc.setDrawColor(220);
      doc.line(margin, yTop + 22, pageW - margin, yTop + 22);
    }
    function drawFooter(page, pages) {
      const yBottom = pageH - 30;
      doc.setDrawColor(220);
      doc.line(margin, yBottom - 12, pageW - margin, yBottom - 12);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      let footer = layout.footerText || '';
      if (layout.pageNums === 'p_de_n') footer += (footer ? ' ‚Ä¢ ' : '') + `p√°g. ${page} de ${pages}`;
      if (layout.pageNums === 'p_simples') footer += (footer ? ' ‚Ä¢ ' : '') + `p√°g. ${page}`;
      doc.text(footer || '', margin, yBottom);
    }

    let y = 76;
    drawHeader();

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text(tituloBase, margin, y);
    y += 18;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);

    const paragraphs = String(docTexto?.value || '').split('\n');
    function ensureSpace(h) {
      if (y + h > pageH - 60) {
        doc.addPage();
        drawHeader();
        y = 76;
      }
    }
    for (const p of paragraphs) {
      const wrapped = doc.splitTextToSize(p || ' ', contentW);
      const arr = Array.isArray(wrapped) ? wrapped : [wrapped];
      for (const part of arr) {
        ensureSpace(lineH);
        doc.text(String(part), margin, y);
        y += lineH;
      }
      y += 4;
    }

    const nomeAss = docNome?.value || getMe().nome || '________________';
    ensureSpace(30);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Assinatura do colaborador:', margin, y);
    y += 10;

    if (sigPad && !sigPad.isEmpty()) {
      ensureSpace(90);
      const img = sigPad.toDataURL('image/png');
      doc.addImage(img, 'PNG', margin, y, 240, 80);
      y += 90;
    } else {
      ensureSpace(50);
      y += 50;
      doc.text('____________________________', margin, y);
      y += 14;
    }

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    ensureSpace(18);
    doc.text(nomeAss, margin, y);

    const pages = doc.getNumberOfPages();
    for (let p = 1; p <= pages; p++) {
      doc.setPage(p);
      drawFooter(p, pages);
    }

    const safe = (tituloBase || 'documento').replace(/\s+/g, '_').toLowerCase();
    doc.save(`${safe}.pdf`);
  });

  /* Importar modelos (.txt/.md/.json) e PDFs (conte√∫do para docTexto) */
  (function handleTplImport() {
    if (!tplImport) return;

    async function readText(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ''));
        r.onerror = reject;
        r.readAsText(file, 'utf-8');
      });
    }
    async function readPDF(file) {
      const buf = await file.arrayBuffer();
      if (!window.pdfjsLib) throw new Error('PDF.js n√£o carregado');
      const loadingTask = window.pdfjsLib.getDocument({ data: buf });
      const pdf = await loadingTask.promise;
      const parts = [];
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent({ normalizeWhitespace: true });
        const text = (content.items || [])
          .map((it) => it.str || '')
          .join(' ')
          .replace(/\s+\n/g, '\n')
          .trim();
        parts.push(text);
      }
      return parts.join('\n\n---\n\n');
    }
    function addTemplates(items) {
      if (!Array.isArray(items)) return 0;
      const list = getTemplates();
      let added = 0;
      for (const it of items) {
        const name = (it?.name || '').trim();
        const content = String(it?.content || '').trim();
        if (!name || !content) continue;
        let id = slugify(name),
          base = id,
          n = 1;
        while (list.some((t) => t.id === id)) {
          n++;
          id = base + '-' + n;
        }
        list.push({ id, name, content });
        added++;
      }
      if (added > 0) setTemplates(list);
      return added;
    }
    function inferNameFromFilename(fn) {
      return (fn || 'documento').replace(/\.[^.]+$/, '').replace(/[_\-]+/g, ' ').trim();
    }
    function populateCustomDocTypes() {
      const esc = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const group = $('docCustomGroup'); if (!group) return;
      const list = getTemplates();
      group.innerHTML = list.map(t => `<option value="tpl:${t.id}">${esc(t.name)}</option>`).join('');

      const sel = $('tplManageSelect');
      if (sel) {
        sel.innerHTML = [`<option value="">‚Äî Selecione um tipo personalizado ‚Äî</option>`]
          .concat(list.map(t => `<option value="${t.id}">${esc(t.name)}</option>`))
          .join('');
      }
    }
    function setTipoAndRefresh(id) {
      if (docTipo) docTipo.value = 'tpl:' + id;
      refreshTexto();
    }

    tplImport.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      let totalAdded = 0;
      let firstNewId = null;
      const pdfTexts = [];

      for (const file of files) {
        try {
          const isPDF =
            /\.(pdf)$/i.test(file.name.trim()) || (String(file.type || '').toLowerCase() === 'application/pdf');
          if (isPDF) {
            try {
              const txt = await readPDF(file);
              if (txt && txt.trim()) pdfTexts.push(`# ${file.name}\n\n${txt.trim()}`);
            } catch {}
            continue;
          }

          const text = await readText(file);
          let addedNow = 0;

          if (/\.(json)$/i.test(file.name.trim()) || (file.type || '').includes('json')) {
            try {
              const data = JSON.parse(text);
              let arr = [];
              if (Array.isArray(data)) arr = data;
              else if (data && Array.isArray(data.templates)) arr = data.templates;
              else if (data && typeof data === 'object' && data.name && data.content) arr = [data];
              addedNow = addTemplates(arr);
              if (addedNow > 0 && !firstNewId) {
                const list = getTemplates();
                const last = list.slice(-addedNow);
                firstNewId = last[0]?.id || null;
              }
            } catch {}
          } else {
            const name = inferNameFromFilename(file.name);
            addedNow = addTemplates([{ name, content: text }]);
            if (addedNow > 0 && !firstNewId) {
              const list = getTemplates();
              const last = list.slice(-1)[0];
              firstNewId = last?.id || null;
            }
          }
          totalAdded += addedNow;
        } catch {}
      }

      if (pdfTexts.length > 0 && docTexto) {
        docTexto.value = pdfTexts.join('\n\n===== FIM DO ARQUIVO =====\n\n');
        notify(`${pdfTexts.length} PDF(s) importado(s) para o conte√∫do.`, 'success');
        fitDocTextarea();
      }

      if (totalAdded > 0) {
        populateCustomDocTypes();
        if (firstNewId) setTipoAndRefresh(firstNewId);
        notify(`${totalAdded} modelo(s) importado(s) com sucesso!`, 'success');
      } else if (pdfTexts.length === 0) {
        notify('N√£o foi poss√≠vel importar. Verifique o(s) arquivo(s).', 'error');
      }

      e.target.value = '';
    });

    /* Criar tipo manualmente */
    btnCriarTipoDoc?.addEventListener('click', () => {
      if (tplNome) tplNome.value = '';
      if (tplTexto) tplTexto.value = '';
      modalNovoDoc && (modalNovoDoc.style.display = 'flex');
    });
    btnCancelarNovoDoc?.addEventListener('click', () => (modalNovoDoc.style.display = 'none'));
    modalNovoDoc?.addEventListener('click', (e) => {
      if (e.target === modalNovoDoc) modalNovoDoc.style.display = 'none';
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') modalNovoDoc && (modalNovoDoc.style.display = 'none');
    });
    btnSalvarNovoDoc?.addEventListener('click', () => {
      const name = (tplNome?.value || '').trim();
      const content = (tplTexto?.value || '').trim();
      if (!name || !content) return notify('Preencha nome e conte√∫do.', 'warn');
      let id = slugify(name);
      const list = getTemplates();
      let suffix = 1;
      const base = id;
      while (list.some((t) => t.id === id)) {
        suffix++;
        id = base + '-' + suffix;
      }
      list.push({ id, name, content });
      setTemplates(list);
      const group = $('docCustomGroup');
      if (group) group.insertAdjacentHTML('beforeend', `<option value="tpl:${id}">${name}</option>`);
      if (docTipo) docTipo.value = 'tpl:' + id;
      refreshTexto();
      modalNovoDoc && (modalNovoDoc.style.display = 'none');
      notify('Tipo salvo!', 'success');
    });

    /* Gerenciar (excluir) tipos personalizados */
    (function manageDelete() {
      const manageSelect = $('tplManageSelect');
      const btnExcluir = $('btnExcluirTipoDoc');
      function removeTemplateById(id) {
        const list = getTemplates();
        const idx = list.findIndex((t) => t.id === id);
        if (idx < 0) return false;
        list.splice(idx, 1);
        setTemplates(list);
        return true;
      }
      btnExcluir?.addEventListener('click', () => {
        const id = manageSelect?.value || '';
        if (!id) return notify('Selecione um tipo personalizado.', 'warn');
        const list = getTemplates();
        const tpl = list.find((t) => t.id === id);
        if (!tpl) return notify('Tipo n√£o encontrado.', 'error');
        if (!confirm(`Excluir o tipo ‚Äú${tpl.name}‚Äù?`)) return;
        const ok = removeTemplateById(id);
        if (ok) {
          if (docTipo?.value === 'tpl:' + id) {
            docTipo.value = 'interesse';
            refreshTexto();
          }
          // repopula
          const group = $('docCustomGroup');
          if (group) group.innerHTML = getTemplates().map((t) => `<option value="tpl:${t.id}">${t.name}</option>`).join('');
          const sel = $('tplManageSelect');
          if (sel) {
            sel.innerHTML =
              `<option value="">‚Äî Selecione um tipo personalizado ‚Äî</option>` +
              getTemplates()
                .map((t) => `<option value="${t.id}">${t.name}</option>`)
                .join('');
          }
          notify('Tipo exclu√≠do.', 'success');
        } else notify('Falha ao excluir.', 'error');
      });
    })();
  })();

  /* ===================== FUNCION√ÅRIOS ===================== */

  const funcionariosSeed = [
    { id: 'f1', nome: 'Luana Ferreira', idade: 28, funcao: 'Assistente de RH', cargo: 'Assistente de RH', salario: 3200, optVR: true, optVT: true, foto: '', ativo: true },
    { id: 'f2', nome: 'Bruno Martins', idade: 35, funcao: 'Engenheiro Civil', cargo: 'Engenheiro', salario: 6800, optVR: false, optVT: true, foto: '', ativo: true }
  ];
  function getFuncionariosLS() {
    let arr = JSON.parse(localStorage.getItem(LS_KEYS.FUNCS) || 'null');
    if (!Array.isArray(arr) || arr.length === 0) {
      arr = funcionariosSeed;
      localStorage.setItem(LS_KEYS.FUNCS, JSON.stringify(arr));
    }
    arr.forEach((f, i) => {
      if (!f.id) f.id = 'fid_' + i;
      if (typeof f.ativo === 'undefined') f.ativo = true;
      if (typeof f.cargo === 'undefined') f.cargo = f.funcao || '';
      if (typeof f.salario !== 'number') f.salario = 0;
      if (typeof f.optVR === 'undefined') f.optVR = false;
      if (typeof f.optVT === 'undefined') f.optVT = false;
    });
    localStorage.setItem(LS_KEYS.FUNCS, JSON.stringify(arr));
    return arr;
  }
  function setFuncionariosLS(arr) {
    localStorage.setItem(LS_KEYS.FUNCS, JSON.stringify(arr || []));
  }
  function defaultAvatarDataURL() {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#00E0FF"/><stop offset="1" stop-color="#FF2FB9"/></linearGradient></defs>
        <rect width="128" height="128" rx="24" fill="url(#g)" opacity="0.25"/>
        <circle cx="64" cy="50" r="22" fill="#cfe0ef"/>
        <rect x="24" y="78" width="80" height="34" rx="17" fill="#cfe0ef"/>
      </svg>`;
    return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
  }
  function photoOrFallback(url) {
    return url && url.trim()
      ? `<img class="emp-avatar" src="${url}" alt="Foto" title="Clique para alterar foto">`
      : `<div class="emp-avatar" title="Clique para adicionar foto"></div>`;
  }

  /* >>> NOVO: render com 3 pontinhos e dropdown (mantido) */
function renderFuncionarios(q = '') {
  if (!empGrid) return;
  const all = getFuncionariosLS();
  const term = q.trim().toLowerCase();
  const list = term ? all.filter((f) => f.nome.toLowerCase().includes(term)) : all;

  empGrid.innerHTML = list.map((f) => {
    const inactiveClass = f.ativo ? '' : 'inactive';
    const offBadge = f.ativo ? '' : `<span class="emp-badge-off">INATIVO</span>`;
    const nameSafe = escapeHTML(f.nome);
    const roleSafe = escapeHTML(f.funcao);

    const menu = `
      <div class="emp-menu" data-id="${f.id}" title="Op√ß√µes" aria-haspopup="menu" aria-expanded="false">
        <i class="fa-solid fa-ellipsis-vertical"></i>
      </div>
      <div class="emp-menu-dropdown" data-menu="${f.id}" role="menu">
        ${f.ativo
          ? `<button data-action="desativar" data-id="${f.id}">
               <i class="fa-regular fa-circle-xmark"></i> Desativar
             </button>`
          : `<button data-action="ativar" data-id="${f.id}">
               <i class="fa-regular fa-circle-check"></i> Ativar
             </button>`
        }
        <button class="danger" data-action="excluir" data-id="${f.id}">
          <i class="fa-solid fa-trash"></i> Excluir
        </button>
      </div>`;

    return `
      <div class="emp-card ${inactiveClass}" data-id="${f.id}">
        ${menu}
        ${offBadge}
        ${photoOrFallback(f.foto)}
        <div>
          <div class="emp-name">${nameSafe}</div>
          <div class="emp-role">${roleSafe} ‚Ä¢ ${escapeHTML(String(f.idade))} anos</div>
        </div>
      </div>`;
  }).join('') || `<div style="color:#9fb1c3">Nenhum funcion√°rio encontrado.</div>`;
}
  renderFuncionarios();
  /* <<< FIM NOVO render */

  function syncSearchInputs(val) {
    try {
      if (typeof val !== 'string') val = '';
      if (funcSearch && funcSearch.value !== val) funcSearch.value = val;
      if (funcSearchGestao && funcSearchGestao.value !== val) funcSearchGestao.value = val;
    } catch {}
  }
  funcSearch?.addEventListener('input', (e) => {
    syncSearchInputs(e.target.value);
    renderFuncionarios(e.target.value);
  });
  funcClear?.addEventListener('click', () => {
    syncSearchInputs('');
    renderFuncionarios('');
  });
  funcSearchBtn?.addEventListener('click', () => renderFuncionarios(funcSearch?.value || ''));
  funcSearchGestao?.addEventListener('input', (e) => {
    syncSearchInputs(e.target.value);
    renderFuncionarios(e.target.value);
  });
  funcClearGestao?.addEventListener('click', () => {
    syncSearchInputs('');
    renderFuncionarios('');
  });
  funcSearchGestaoBtn?.addEventListener('click', () => renderFuncionarios(funcSearchGestao?.value || ''));

  /* Modal Funcion√°rio (apenas Documentos Importantes) */
  let currentEmpId = null;

  /* >>> AJUSTE: Mini-modal para ‚ÄúDocumentos importantes‚Äù */
  let impDocsMiniModal = null;
  function ensureImpDocsMiniModal() {
    if (impDocsMiniModal) return impDocsMiniModal;
    const wrap = document.createElement('div');
    wrap.className = 'modal';
    wrap.id = 'modalImpDocs';
    wrap.innerHTML = `
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="impDocsTitle">
        <div class="modal-header" id="impDocsTitle">Documentos importantes</div>
        <div class="modal-body" id="impDocsMiniBody"></div>
        <div class="modal-footer">
          <button class="btn btn-light" id="btnCloseImpDocs">Fechar</button>
        </div>
      </div>
    `;
    document.body.appendChild(wrap);

    // fechar ao clicar fora
    wrap.addEventListener('click', (e) => {
      if (e.target === wrap) closeImpDocsMini();
    });
    // fechar via ESC
    document.addEventListener('keydown', (e) => {
      if (wrap.style.display === 'flex' && e.key === 'Escape') closeImpDocsMini();
    });
    // bot√£o fechar
    wrap.querySelector('#btnCloseImpDocs')?.addEventListener('click', () => closeImpDocsMini());

    impDocsMiniModal = wrap;
    return impDocsMiniModal;
  }
  function openImpDocsMini() {
    const modal = ensureImpDocsMiniModal();
    const pane = $('paneDocsImportantes');
    const body = $('impDocsMiniBody');
    if (!pane || !body) return;

    // Move o conte√∫do existente para dentro do mini-modal (mant√©m listeners)
    if (body.children.length === 0) {
      while (pane.firstChild) body.appendChild(pane.firstChild);
    }
    renderImpDocsTable(); // garante atualiza√ß√£o
    modal.style.display = 'flex';
  }
  function closeImpDocsMini(silent = false) {
    if (!impDocsMiniModal) return;
    const pane = $('paneDocsImportantes');
    const body = $('impDocsMiniBody');
    if (pane && body && body.children.length > 0) {
      while (body.firstChild) pane.appendChild(body.firstChild);
    }
    impDocsMiniModal.style.display = 'none';
    if (!silent) {
      // volta visualmente para a aba ‚ÄúDocumentos‚Äù
      document.querySelectorAll('#modalFuncionario .emp-tab-btn').forEach(b => b.classList.remove('active'));
      $('btnTabDocsSimples')?.classList.add('active');
      document.querySelectorAll('#modalFuncionario .emp-pane').forEach(p => p.classList.remove('active'));
      $('paneDocsSimples')?.classList.add('active');
    }
  }
  /* <<< FIM AJUSTE mini-modal */

  /* >>> AJUSTE: Altern√¢ncia das abas ‚Äî abrir mini-modal ao clicar em ‚ÄúDocumentos importantes‚Äù */
  modalFuncionario?.addEventListener('click', (e) => {
    const btn = e.target.closest('.emp-tab-btn');
    if (!btn) return;
    e.preventDefault();

    const targetSel = btn.getAttribute('data-target');

    // Se clicar em ‚ÄúDocumentos importantes‚Äù, abre a telinha (mini-modal) e mant√©m a aba ‚ÄúDocumentos‚Äù ativa por baixo
    if (targetSel === '#paneDocsImportantes') {
      openImpDocsMini();
      return;
    }

    // Comportamento padr√£o para outras abas
    document.querySelectorAll('#modalFuncionario .emp-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('#modalFuncionario .emp-pane').forEach(p => p.classList.remove('active'));
    const pane = document.querySelector(targetSel);
    if (pane) pane.classList.add('active');
  });
  /* <<< FIM AJUSTE listener de abas */

  function openFuncionario(empId) {
    const all = getFuncionariosLS();
    const f = all.find((x) => x.id === empId);
    if (!f) return;
    currentEmpId = f.id;
    if (funcModalNome) funcModalNome.textContent = f.nome;
    if (funcModalFuncao) funcModalFuncao.textContent = `${f.funcao} ‚Ä¢ ${f.idade} anos`;
    if (funcModalAvatar) {
      funcModalAvatar.src = f.foto || defaultAvatarDataURL();
      funcModalAvatar.title = 'Clique para alterar a foto';
      funcModalAvatar.style.cursor = 'pointer';
    }

    /* >>> abrir inicialmente na aba ‚ÄúDocumentos‚Äù */
    document.querySelectorAll('#modalFuncionario .emp-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('#modalFuncionario .emp-pane').forEach(p => p.classList.remove('active'));
    $('btnTabDocsSimples')?.classList.add('active');
    $('paneDocsSimples')?.classList.add('active');

    // Garante mini-modal fechado/limpo
    closeImpDocsMini(true);

    // Render dos anexos gerais (Documentos)
    renderGenDocsTable();

    // Render dos importantes (caso j√° aberto via mini)
    renderImpDocsTable();

    // limpa input de anexo
    if (genDocFile) genDocFile.value = '';

    modalFuncionario && (modalFuncionario.style.display = 'flex');
  }
  function closeFuncionario() {
    // fecha mini-modal se estiver aberto e devolve conte√∫do
    closeImpDocsMini(true);
    modalFuncionario && (modalFuncionario.style.display = 'none');
  }
  fecharFuncionario?.addEventListener('click', closeFuncionario);

  /* >>> NOVO: gerenciamento do menu de 3 pontinhos e a√ß√µes + clique no avatar */
  function closeAllEmpMenus() {
    document.querySelectorAll('.emp-menu-dropdown.open').forEach((el) => el.classList.remove('open'));
    document.querySelectorAll('.emp-menu[aria-expanded="true"]').forEach((el) => el.setAttribute('aria-expanded', 'false'));
  }
  function toggleEmpMenu(id) {
    const dd = document.querySelector(`.emp-menu-dropdown[data-menu="${id}"]`);
    const btn = document.querySelector(`.emp-menu[data-id="${id}"]`);
    if (!dd || !btn) return;
    const willOpen = !dd.classList.contains('open');
    closeAllEmpMenus();
    if (willOpen) {
      dd.classList.add('open');
      btn.setAttribute('aria-expanded', 'true');
    } else {
      btn.setAttribute('aria-expanded', 'false');
    }
  }
  function setFuncionarioAtivo(id, ativo) {
    const arr = getFuncionariosLS();
    const idx = arr.findIndex((f) => f.id === id);
    if (idx < 0) return;
    arr[idx].ativo = !!ativo;
    setFuncionariosLS(arr);
    notify(ativo ? 'Funcion√°rio ativado.' : 'Funcion√°rio desativado.', 'success');
    renderFuncionarios(funcSearch?.value || '');
    renderVT();
    renderVR();
  }
  function excluirFuncionario(id) {
    const arr = getFuncionariosLS();
    const f = arr.find((x) => x.id === id);
    if (!f) return;
    if (!confirm(`Excluir definitivamente ‚Äú${f.nome}‚Äù?`)) return;

    const novo = arr.filter((x) => x.id !== id);
    setFuncionariosLS(novo);

    // Limpa v√≠nculos
    try {
      const vrMap = getVRMap(); delete vrMap[id]; setVRMap(vrMap);
      const vtMap = getVTMap(); delete vtMap[id]; setVTMap(vtMap);
      const imp = getImpDocsMap(); delete imp[id]; setImpDocsMap(imp);
      const gen = getGenDocsMap(); delete gen[id]; setGenDocsMap(gen);
      const alerts = getAlerts().filter(a => a.empId !== id); setAlerts(alerts);
      updateNotifDot();
    } catch {}

    if (currentEmpId === id) {
      currentEmpId = null;
      modalFuncionario && (modalFuncionario.style.display = 'none');
    }

    notify('Funcion√°rio exclu√≠do.', 'success');
    renderFuncionarios(funcSearch?.value || '');
    renderVT();
    renderVR();
  }

  // >>> NOVO: seletor de foto reutiliz√°vel
  let hiddenPhotoInput = null;
  function ensureHiddenPhotoInput() {
    if (!hiddenPhotoInput) {
      hiddenPhotoInput = document.createElement('input');
      hiddenPhotoInput.type = 'file';
      hiddenPhotoInput.accept = 'image/*';
      hiddenPhotoInput.style.display = 'none';
      document.body.appendChild(hiddenPhotoInput);
    }
    return hiddenPhotoInput;
  }
  async function changePhotoForEmp(empId) {
    const input = ensureHiddenPhotoInput();
    input.value = '';
    input.onchange = async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      try {
        const dataURL = await fileToDataURL(f);
        const arr = getFuncionariosLS();
        const idx = arr.findIndex(x => x.id === empId);
        if (idx >= 0) {
          arr[idx].foto = dataURL;
          setFuncionariosLS(arr);
          renderFuncionarios(funcSearch?.value || '');
          if (currentEmpId === empId && funcModalAvatar) funcModalAvatar.src = dataURL;
          notify('Foto atualizada.', 'success');
        }
      } catch {
        notify('N√£o foi poss√≠vel carregar a imagem.', 'error');
      }
    };
    input.click();
  }
  // Avatar clic√°vel no modal
  funcModalAvatar?.addEventListener('click', () => {
    if (currentEmpId) changePhotoForEmp(currentEmpId);
  });

  empGrid?.addEventListener('click', (e) => {
    // Clique na foto/placeholder -> alterar foto
    const avatar = e.target.closest('.emp-avatar');
    if (avatar) {
      e.stopPropagation();
      const card = e.target.closest('.emp-card');
      const id = card?.getAttribute('data-id');
      if (id) changePhotoForEmp(id);
      return;
    }

    const onMenuBtn = e.target.closest('.emp-menu');
    const onMenuDD  = e.target.closest('.emp-menu-dropdown');
    const onAction  = e.target.closest('.emp-menu-dropdown [data-action]');

    // Clique nos 3 pontinhos
    if (onMenuBtn) {
      e.stopPropagation();
      const id = onMenuBtn.getAttribute('data-id');
      toggleEmpMenu(id);
      return;
    }

    // Clique dentro do dropdown (sem a√ß√£o)
    if (onMenuDD && !onAction) {
      e.stopPropagation();
      return;
    }

    // A√ß√µes do dropdown
    if (onAction) {
      e.stopPropagation();
      const act = onAction.getAttribute('data-action');
      const id = onAction.getAttribute('data-id');
      if (act === 'desativar') setFuncionarioAtivo(id, false);
      if (act === 'ativar')    setFuncionarioAtivo(id, true);
      if (act === 'excluir')   excluirFuncionario(id);
      closeAllEmpMenus();
      return;
    }

    // Clique no card (fora do menu/foto) -> abre modal
    const card = e.target.closest('.emp-card');
    if (!card) return;
    const id = card.getAttribute('data-id');
    if (id) openFuncionario(id);
  });

  // Fechar menus clicando fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.emp-menu') && !e.target.closest('.emp-menu-dropdown')) {
      closeAllEmpMenus();
    }
  });
  /* <<< FIM NOVO bloco de menus/foto */

  /* Documentos Importantes (por funcion√°rio) + Alertas */
  /* Vers√£o com limite, usada nos Documentos Importantes */
  async function fileToDataURL_imp(file) {
    const MAX = 4 * 1024 * 1024; // 4MB
    if (file.size > MAX) {
      notify('Arquivo grande (>' + (MAX/1024/1024) + 'MB). Considere armazenar fora do navegador.', 'warn');
    }
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  function renderImpDocsTable() {
    if (!impDocsTable) return;
    const map = getImpDocsMap();
    const list = map[currentEmpId] || [];
    if (!list.length) {
      impDocsTable.innerHTML = `<tr><td colspan="5" style="color:#9fb1c3">Nenhum documento importante.</td></tr>`;
      return;
    }
    impDocsTable.innerHTML = list
      .map((d, idx) => {
        const issue = d.issue ? new Date(d.issue + 'T00:00:00') : null;
        const due = d.due ? new Date(d.due + 'T00:00:00') : null;
        const issueLabel = issue ? `${two(issue.getDate())}/${two(issue.getMonth() + 1)}/${issue.getFullYear()}` : '‚Äî';
        const dueLabel = due ? `${two(due.getDate())}/${two(due.getMonth() + 1)}/${due.getFullYear()}` : '‚Äî';
        const bellIcon = d.subscribed ? 'fa-solid fa-bell' : 'fa-regular fa-bell';
        const bellTitle = d.subscribed ? 'Lembrete ativado' : 'Ativar lembrete';
        return `<tr>
          <td style="text-align:left">${escapeHTML(d.name || '(sem nome)')}</td>
          <td>${escapeHTML(d.type || '‚Äî')}</td>
          <td>${issueLabel}</td>
          <td>${dueLabel}</td>
          <td>
            ${d.dataURL ? `<a class="btn btn-light" href="${d.dataURL}" download="${encodeURIComponent(d.name || 'documento')}" target="_blank"><i class="fa-solid fa-download"></i> Baixar</a>` : ''}
            <button class="btn btn-light" data-imp-sub="${idx}" title="${bellTitle}">
              <i class="${bellIcon}"></i>
            </button>
            <button class="btn btn-ghost" data-imp-del="${idx}"><i class="fa-solid fa-trash"></i> Excluir</button>
          </td>
        </tr>`;
      })
      .join('');
  }
  btnAddImpDoc?.addEventListener('click', async () => {
    if (!currentEmpId) return notify('Abra um funcion√°rio primeiro.', 'warn');
    const file = impDocFile?.files?.[0] || null;
    const name = (impDocName?.value || '').trim();
    const type = (impDocType?.value || '').trim();
    const issue = (impDocIssue?.value || '').trim();
    const due = (impDocDue?.value || '').trim();
    if (!file) return notify('Selecione um arquivo.', 'warn');
    if (!name) return notify('Informe o nome do documento.', 'warn');
    if (!type) return notify('Informe o tipo do documento.', 'warn');
    if (!issue) return notify('Informe a data de emiss√£o.', 'warn');
    if (!due) return notify('Informe a data de validade.', 'warn');

    let dataURL = '';
    try {
      dataURL = await fileToDataURL_imp(file);
    } catch {}
    const map = getImpDocsMap();
    map[currentEmpId] = map[currentEmpId] || [];
    const id = uid('doc');
    map[currentEmpId].push({
      id,
      name,
      type,
      issue,
      due,
      uploadedAt: new Date().toISOString(),
      size: file.size || 0,
      dataURL,
      subscribed: false
    });
    setImpDocsMap(map);

    // limpa
    if (impDocFile) impDocFile.value = '';
    if (impDocName) impDocName.value = '';
    if (impDocType) impDocType.value = '';
    if (impDocIssue) impDocIssue.value = '';
    if (impDocDue) impDocDue.value = '';

    renderImpDocsTable();
    notify('Documento importante adicionado.', 'success');
    checkImportantDocExpirations(); // atualiza alertas
  });
  impDocsTable?.addEventListener('click', (e) => {
    const del = e.target.closest('[data-imp-del]');
    const sub = e.target.closest('[data-imp-sub]');
    const map = getImpDocsMap();
    const list = map[currentEmpId] || [];

    if (del) {
      const idx = Number(del.getAttribute('data-imp-del'));
      if (!Number.isFinite(idx)) return;
      if (!confirm('Excluir este documento importante?')) return;
      list.splice(idx, 1);
      map[currentEmpId] = list;
      setImpDocsMap(map);
      renderImpDocsTable();
      notify('Documento exclu√≠do.', 'success');
      checkImportantDocExpirations();
    }
    if (sub) {
      const idx = Number(sub.getAttribute('data-imp-sub'));
      if (!Number.isFinite(idx)) return;
      const item = list[idx];
      item.subscribed = !item.subscribed;
      map[currentEmpId] = list;
      setImpDocsMap(map);
      renderImpDocsTable();

      if (item.subscribed) {
        const alerts = getAlerts();
        alerts.push({
          id: uid('al'),
          refKey: `sub|${currentEmpId}|${item.id}`,
          type: 'subscription',
          empId: currentEmpId,
          empNome: funcModalNome?.textContent || '',
          docName: item.name,
          due: item.due,
          createdAt: new Date().toISOString(),
          unread: true,
          status: 'Lembrete salvo'
        });
        setAlerts(alerts);
        updateNotifDot();
        notify('Lembrete ativado para este documento.', 'success');
        checkImportantDocExpirations();
      } else {
        notify('Lembrete desativado para este documento.', 'info');
      }
    }
  });

  /* >>> NOVO: Documentos Simples (anexos gerais) */
  function renderGenDocsTable() {
    if (!genDocsTable) return;
    const map = getGenDocsMap();
    const list = map[currentEmpId] || [];
    if (!list.length) {
      genDocsTable.innerHTML = `<tr><td colspan="4">‚Äî</td></tr>`;
      return;
    }
    genDocsTable.innerHTML = list
      .map((d, idx) => {
        const when = d.uploadedAt ? new Date(d.uploadedAt) : null;
        const whenLabel = when
          ? `${two(when.getDate())}/${two(when.getMonth() + 1)}/${when.getFullYear()} ${two(when.getHours())}:${two(when.getMinutes())}`
          : '‚Äî';
        return `<tr>
          <td style="text-align:left">${escapeHTML(d.name || '(sem nome)')}</td>
          <td>${bytesHuman(d.size || 0)}</td>
          <td>${whenLabel}</td>
          <td>
            ${d.dataURL ? `<a class="btn btn-light" href="${d.dataURL}" download="${encodeURIComponent(d.name || 'documento')}" target="_blank"><i class="fa-solid fa-download"></i> Baixar</a>` : ''}
            <button class="btn btn-ghost" data-gen-del="${idx}"><i class="fa-solid fa-trash"></i> Excluir</button>
          </td>
        </tr>`;
      })
      .join('');
  }
  btnAddGenDoc?.addEventListener('click', async () => {
    if (!currentEmpId) return notify('Abra um funcion√°rio primeiro.', 'warn');
    const file = genDocFile?.files?.[0];
    if (!file) return notify('Selecione um arquivo para anexar.', 'warn');
    try {
      const dataURL = await fileToDataURL(file);
      const map = getGenDocsMap();
      map[currentEmpId] = map[currentEmpId] || [];
      map[currentEmpId].push({
        id: uid('gdoc'),
        name: file.name,
        size: file.size || 0,
        uploadedAt: new Date().toISOString(),
        dataURL
      });
      setGenDocsMap(map);
      if (genDocFile) genDocFile.value = '';
      renderGenDocsTable();
      notify('Documento anexado.', 'success');
    } catch {
      notify('Falha ao anexar o documento.', 'error');
    }
  });
  genDocsTable?.addEventListener('click', (e) => {
    const del = e.target.closest('[data-gen-del]');
    if (!del) return;
    const idx = Number(del.getAttribute('data-gen-del'));
    if (!Number.isFinite(idx)) return;
    const map = getGenDocsMap();
    const list = map[currentEmpId] || [];
    if (!list[idx]) return;
    if (!confirm(`Excluir o anexo ‚Äú${list[idx].name}‚Äù?`)) return;
    list.splice(idx, 1);
    map[currentEmpId] = list;
    setGenDocsMap(map);
    renderGenDocsTable();
    notify('Anexo exclu√≠do.', 'success');
  });
  /* <<< FIM Documentos Simples */

  /* Alertas */
  function updateNotifDot() {
    if (!notifDot) return;
    const anyUnread = getAlerts().some((a) => a.unread);
    if (anyUnread) notifDot.removeAttribute('hidden');
    else notifDot.setAttribute('hidden', '');
  }
  function checkImportantDocExpirations() {
    const map = getImpDocsMap();
    const allAlerts = getAlerts();
    const today = new Date();
    const soonDays = 7;
    const soonMs = soonDays * 24 * 3600 * 1000;

    function addAlertUnique(refKey, payload) {
      if (allAlerts.some((a) => a.refKey === refKey)) return;
      allAlerts.push({ id: uid('al'), unread: true, createdAt: new Date().toISOString(), ...payload, refKey });
    }

    Object.entries(map).forEach(([empId, docs]) => {
      const emp = getFuncionariosLS().find((f) => f.id === empId);
      const empNome = emp?.nome || 'Funcion√°rio';
      docs.forEach((d) => {
        if (!d.due) return;
        const due = new Date(d.due + 'T00:00:00');
        const diff = due - today;
        const isOver = diff < 0;
        const isSoon = diff >= 0 && diff <= soonMs;

        if (isOver) {
          addAlertUnique(`over|${empId}|${d.id}`, {
            type: 'due_over',
            empId,
            empNome,
            docName: d.name,
            due: d.due,
            status: 'Vencido'
          });
        } else if (isSoon) {
          addAlertUnique(`soon|${empId}|${d.id}`, {
            type: 'due_soon',
            empId,
            empNome,
            docName: d.name,
            due: d.due,
            status: `Vence em at√© ${soonDays} dias`
          });
        }
      });
    });

    setAlerts(allAlerts);
    updateNotifDot();
  }
  function renderAlertsTable() {
    if (!alertsTable) return;
    const list = getAlerts().sort((a, b) => (a.createdAt < b.createdAt ? 1 : -1));
    alertsTable.innerHTML =
      list.length === 0
        ? `<tr><td colspan="5">Sem lembretes.</td></tr>`
        : list
            .map((al) => {
              const status =
                al.status ||
                (al.type === 'due_over'
                  ? 'Vencido'
                  : al.type === 'due_soon'
                  ? 'Pr√≥ximo de vencer'
                  : 'Lembrete');
              const cls =
                al.type === 'due_over' ? 'err' : al.type === 'due_soon' ? 'warn' : al.unread ? 'info' : 'ok';
              return `<tr>
                <td>${escapeHTML(al.empNome || '‚Äî')}</td>
                <td>${escapeHTML(al.docName || '‚Äî')}</td>
                <td>${al.due ? al.due.split('-').reverse().join('/') : '‚Äî'}</td>
                <td><span class="status-dot ${cls}"></span> ${escapeHTML(status)}</td>
                <td>
                  <button class="btn btn-light" data-alert-read="${al.id}">${al.unread ? 'Marcar como lido' : 'Lido'}</button>
                </td>
              </tr>`;
            })
            .join('');
  }
  btnAlerts?.addEventListener('click', () => {
    renderAlertsTable();
    modalAlerts && (modalAlerts.style.display = 'flex');
  });
  btnCloseAlerts?.addEventListener('click', () => (modalAlerts.style.display = 'none'));
  alertsTable?.addEventListener('click', (e) => {
    const b = e.target.closest('[data-alert-read]');
    if (!b) return;
    const id = b.getAttribute('data-alert-read');
    const list = getAlerts();
    const idx = list.findIndex((x) => x.id === id);
    if (idx >= 0) {
      list[idx].unread = false;
      setAlerts(list);
      renderAlertsTable();
      updateNotifDot();
    }
  });

  /* ===================== CADASTRO (modal) ===================== */
  (function mountCadastroModal() {
    const cadWrap = document.querySelector('.gestao-cadastro-wrap');
    const cadBox = cadWrap ? cadWrap.querySelector('.gestao-cadastro') : null;

    function openModal() {
      if (cadBox && modalCadastroBody && cadBox.parentElement !== modalCadastroBody) {
        modalCadastroBody.appendChild(cadBox);
      }
      modalCadastroUsuario && (modalCadastroUsuario.style.display = 'flex');
    }
    function closeModal() {
      if (cadWrap && cadBox && cadBox.parentElement !== cadWrap) cadWrap.appendChild(cadBox);
      modalCadastroUsuario && (modalCadastroUsuario.style.display = 'none');
    }
    btnAbrirCadastro?.addEventListener('click', openModal);
    btnFecharCadastro?.addEventListener('click', closeModal);
    modalCadastroUsuario?.addEventListener('click', (e) => {
      if (e.target === modalCadastroUsuario) closeModal();
    });
    document.addEventListener('keydown', (e) => e.key === 'Escape' && closeModal());
  })();

  cadFoto?.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) {
      if (cadFotoPreview) cadFotoPreview.src = '';
      return;
    }
    const dataURL = await fileToDataURL(f);
    if (cadFotoPreview) cadFotoPreview.src = dataURL;
  });

  btnSalvarCadastro?.addEventListener('click', async () => {
    const nome = (cadNome?.value || '').trim();
    const funcao = (cadFuncao?.value || '').trim();
    if (!nome || !funcao) return notify('Nome e Fun√ß√£o s√£o obrigat√≥rios.', 'warn');

    const rg = (cadRG?.value || '').trim();
    const cpf = (cadCPF?.value || '').trim();
    const idade = parseInt((cadIdade?.value || '0').trim(), 10) || 0;
    const cargo = cadCargo ? (cadCargo.value || '').trim() : funcao;
    const salario = parseFloat(String(cadSalario?.value || '0').replace(',', '.')) || 0;

    const optVR = !!cadOptVR?.checked;
    const optVT = !!cadOptVT?.checked;

    const vtUnitV = parseFloat(String(cadVtUnit?.value || '').replace(',', '.'));
    const vrDailyV = parseFloat(String(cadVrDaily?.value || '').replace(',', '.'));

    let foto = '';
    if (cadFoto?.files?.[0]) {
      try {
        foto = await fileToDataURL(cadFoto.files[0]);
      } catch {}
    }

    const arr = getFuncionariosLS();
    const id = 'fid_' + Date.now();
    arr.push({
      id,
      nome,
      funcao,
      rg,
      cpf,
      idade,
      cargo,
      salario,
      optVR,
      optVT,
      foto,
      ativo: true
    });
    setFuncionariosLS(arr);

    /* VR/VT maps */
    try {
      const vrMap = getVRMap();
      vrMap[id] = Object.assign({ enabled: optVR, sal: salario }, vrMap[id] || {});
      if (Number.isFinite(vrDailyV)) vrMap[id].daily = vrDailyV;
      setVRMap(vrMap);

      const vtMap = getVTMap();
      vtMap[id] = Object.assign({ enabled: optVT }, vtMap[id] || {});
      if (Number.isFinite(vtUnitV)) vtMap[id].unit = vtUnitV;
      setVTMap(vtMap);
    } catch {}

    /* documento anexo */
    if (cadDocumento?.files?.[0]) {
      try {
        const file = cadDocumento.files[0];
        const dataURL = await fileToDataURL(file);
        const imp = getImpDocsMap();
        imp[id] = imp[id] || [];
        imp[id].push({
          id: uid('doc'),
          name: file.name,
          type: 'Outros',
          issue: '',
          due: '',
          uploadedAt: new Date().toISOString(),
          size: file.size || 0,
          dataURL,
          subscribed: false
        });
        setImpDocsMap(imp);
      } catch {}
    }

    notify('Funcion√°rio cadastrado!', 'success');

    /* limpar */
    [cadNome, cadFuncao, cadRG, cadCPF, cadIdade, cadCargo, cadSalario, cadAdmissao, cadVtUnit, cadVrDaily].forEach(
      (el) => el && (el.value = '')
    );
    if (cadDocumento) cadDocumento.value = '';
    if (cadFoto) cadFoto.value = '';
    if (cadFotoPreview) cadFotoPreview.src = '';
    if (cadOptVR) cadOptVR.checked = false;
    if (cadOptVT) cadOptVT.checked = false;

    renderFuncionarios(funcSearchGestao ? funcSearchGestao.value : '');
    renderVT();
    renderVR();
  });

  btnLimparCadastro?.addEventListener('click', () => {
    [cadNome, cadFuncao, cadRG, cadCPF, cadIdade, cadCargo, cadSalario, cadAdmissao, cadVtUnit, cadVrDaily].forEach(
      (el) => el && (el.value = '')
    );
    if (cadDocumento) cadDocumento.value = '';
    if (cadFoto) cadFoto.value = '';
    if (cadFotoPreview) cadFotoPreview.src = '';
    if (cadOptVR) cadOptVR.checked = false;
    if (cadOptVT) cadOptVT.checked = false;
  });

  /* ===================== BENEF√çCIOS: VT ===================== */
  function getVTSettings() {
    const def = { unit: 5.0, creditDay: 5 };
    try {
      const s = JSON.parse(localStorage.getItem(KEY_VT_SETTINGS) || 'null');
      return Object.assign({}, def, s || {});
    } catch {
      return def;
    }
  }
  function setVTSettings(o) {
    localStorage.setItem(KEY_VT_SETTINGS, JSON.stringify(o || {}));
  }
  function getVTMap() {
    try {
      return JSON.parse(localStorage.getItem(KEY_VT_MAP) || '{}');
    } catch {
      return {};
    }
  }
  function setVTMap(map) {
    localStorage.setItem(KEY_VT_MAP, JSON.stringify(map || {}));
  }
  const brl = (n) => (isFinite(n) ? n : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  function clampDay(y, m, day) {
    const last = new Date(y, m + 1, 0).getDate();
    return Math.min(Math.max(1, day), last);
  }
  function nextDateForDay(day, ref = new Date()) {
    const d = new Date(ref.getFullYear(), ref.getMonth(), clampDay(ref.getFullYear(), ref.getMonth(), day));
    if (d <= ref) {
      const y = ref.getFullYear(),
        m = ref.getMonth() + 1;
      return new Date(y, m, clampDay(y, m, day));
    }
    return d;
  }

  function renderVT() {
    if (!vtBody) return;
    const s = getVTSettings();
    if (vtUnit) vtUnit.value = Number(s.unit || 0).toFixed(2);
    if (vtCreditDay) vtCreditDay.value = s.creditDay || 1;

    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVTMap();

    let totalEnabled = 0,
      totalQtd = 0,
      totalValor = 0;

    if (emps.length === 0) {
      vtBody.innerHTML = `<tr><td colspan="7" style="color:#9fb1c3">N√£o h√° funcion√°rios ativos.</td></tr>`;
    } else {
      vtBody.innerHTML = emps
        .map((f) => {
          const c = conf[f.id] || {};
          const enabled = typeof c.enabled === 'boolean' ? c.enabled : !!f.optVT;
          const qty = Number.isFinite(c.qty) ? c.qty : 44;
          const unit = Number.isFinite(c.unit) ? c.unit : s.unit;
          const day = Number.isFinite(c.day) ? c.day : s.creditDay;
          const next = nextDateForDay(day, new Date());
          const valor = enabled ? qty * unit : 0;

          if (enabled) {
            totalEnabled++;
            totalQtd += qty;
            totalValor += valor;
          }
          const rowClass = enabled ? 'vt-on' : 'vt-off';
          return `<tr class="${rowClass}">
            <td><input type="checkbox" disabled ${enabled ? 'checked' : ''}></td>
            <td class="vt-cell-left">${f.nome}</td>
            <td><input type="number" value="${qty}" disabled></td>
            <td><input type="number" value="${Number(unit || 0).toFixed(2)}" disabled></td>
            <td><input type="number" value="${day}" disabled></td>
            <td>${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}</td>
            <td><strong>${brl(valor)}</strong></td>
          </tr>`;
        })
        .join('');
    }
    if (vtKColab) vtKColab.textContent = String(totalEnabled);
    if (vtKQtd) vtKQtd.textContent = String(totalQtd);
    if (vtKValor) vtKValor.textContent = brl(totalValor);
    if (vtSumQtd) vtSumQtd.textContent = String(totalQtd);
    if (vtSumValor) vtSumValor.textContent = brl(totalValor);
  }
  vtUnit?.addEventListener('input', (e) => {
    let v = parseFloat(String(e.target.value).replace(',', '.'));
    if (!isFinite(v) || v < 0) v = 0;
    const s = getVTSettings();
    s.unit = v;
    setVTSettings(s);
    renderVT();
  });
  vtCreditDay?.addEventListener('input', (e) => {
    let d = parseInt(e.target.value, 10);
    if (!isFinite(d) || d < 1) d = 1;
    if (d > 31) d = 31;
    const s = getVTSettings();
    s.creditDay = d;
    setVTSettings(s);
    renderVT();
  });

  btnExportVTCSV?.addEventListener('click', () => {
    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVTMap();
    const s = getVTSettings();
    const rows = [['Ativo', 'Funcion√°rio', 'Qtd VT/m√™s', 'Tarifa (R$)', 'Dia cr√©dito', 'Pr√≥ximo cr√©dito', 'Valor (R$)']];
    emps.forEach((f) => {
      const c = conf[f.id] || {};
      const enabled = typeof c.enabled === 'boolean' ? c.enabled : !!f.optVT;
      const qty = Number.isFinite(c.qty) ? c.qty : 44;
      const unit = Number.isFinite(c.unit) ? c.unit : s.unit;
      const day = Number.isFinite(c.day) ? c.day : s.creditDay;
      const next = nextDateForDay(day, new Date());
      const valor = enabled ? qty * unit : 0;
      rows.push([
        enabled ? 'SIM' : 'N√ÉO',
        f.nome,
        qty,
        unit.toFixed(2).replace('.', ','),
        day,
        `${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}`,
        valor.toFixed(2).replace('.', ',')
      ]);
    });
    const csv = rows.map((r) => r.map((x) => `"${String(x).replace(/"/g, '""')}"`).join(';')).join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'vale_transporte.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    notify('CSV do VT exportado.', 'success');
  });
  btnExportVTPDF?.addEventListener('click', () => {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF n√£o carregado.', 'error');
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const mx = 28;
    let y = 36;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('Relat√≥rio ‚Äî Vale Transporte', mx, y);
    y += 16;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(new Date().toLocaleString('pt-BR'), mx, y);
    y += 10;

    const headers = ['Ativo', 'Funcion√°rio', 'Qtd', 'Tarifa', 'Dia', 'Pr√≥x. Cr√©dito', 'Valor'];
    const widths = [46, 190, 40, 60, 36, 110, 60];

    function drawHeader() {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      let x = mx;
      headers.forEach((h, i) => {
        doc.text(h, x + 4, y + 12);
        x += widths[i];
      });
      doc.setDrawColor(180);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;
      doc.setFont('helvetica', 'normal');
    }
    drawHeader();

    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVTMap();
    const s = getVTSettings();

    let totQtd = 0,
      totVal = 0;
    for (const f of emps) {
      const c = conf[f.id] || {};
      const enabled = typeof c.enabled === 'boolean' ? c.enabled : !!f.optVT;
      const qty = Number.isFinite(c.qty) ? c.qty : 44;
      const unit = Number.isFinite(c.unit) ? c.unit : s.unit;
      const day = Number.isFinite(c.day) ? c.day : s.creditDay;
      const next = nextDateForDay(day, new Date());
      const valor = enabled ? qty * unit : 0;

      if (y > 770) {
        doc.addPage();
        y = 36;
        drawHeader();
      }

      let x = mx;
      const cells = [
        enabled ? 'SIM' : 'N√ÉO',
        f.nome,
        String(qty),
        'R$ ' + unit.toFixed(2).replace('.', ','),
        String(day),
        `${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}`,
        'R$ ' + valor.toFixed(2).replace('.', ',')
      ];
      widths.forEach((w, i) => {
        doc.text(String(cells[i]), x + 4, y + 12);
        x += w;
      });
      doc.setDrawColor(230);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;

      if (enabled) {
        totQtd += qty;
        totVal += valor;
      }
    }

    y += 8;
    doc.setFont('helvetica', 'bold');
    doc.text('Totais:', mx, y);
    doc.setFont('helvetica', 'normal');
    doc.text(`Qtd VT/m√™s: ${totQtd}`, mx + 60, y);
    doc.text(`Valor total: R$ ${totVal.toFixed(2).replace('.', ',')}`, mx + 180, y);

    doc.save('vale_transporte.pdf');
    notify('PDF do VT exportado.', 'success');
  });

  /* seed VT map, se vazio */
  (function seedVT() {
    const map = getVTMap();
    if (Object.keys(map).length > 0) return;
    const emps = getFuncionariosLS().filter((f) => f.ativo);
    const s = getVTSettings();
    const m = {};
    emps.forEach((f) => (m[f.id] = { enabled: !!f.optVT, qty: 44, unit: s.unit, day: s.creditDay }));
    setVTMap(m);
  })();

  /* ===================== BENEF√çCIOS: VR ===================== */
  function getVRSettings() {
    const def = { daily: 25.0, days: 22, pct: 6.0, creditDay: 5, cap: true };
    try {
      const s = JSON.parse(localStorage.getItem(KEY_VR_SETTINGS) || 'null');
      return Object.assign({}, def, s || {});
    } catch {
      return def;
    }
  }
  function setVRSettings(o) {
    localStorage.setItem(KEY_VR_SETTINGS, JSON.stringify(o || {}));
  }
  function getVRMap() {
    try {
      return JSON.parse(localStorage.getItem(KEY_VR_MAP) || '{}');
    } catch {
      return {};
    }
  }
  function setVRMap(map) {
    localStorage.setItem(KEY_VR_MAP, JSON.stringify(map || {}));
  }

  function renderVR() {
    if (!vrBody) return;
    const s = getVRSettings();

    if (vrDaily) vrDaily.value = Number(s.daily || 0).toFixed(2);
    if (vrDays) vrDays.value = Number(s.days || 0);
    if (vrPct) vrPct.value = Number(s.pct || 0).toFixed(2);
    if (vrCreditDay) vrCreditDay.value = Number(s.creditDay || 1);
    if (vrCapDiscount) vrCapDiscount.checked = !!s.cap;

    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVRMap();

    let adesoes = 0,
      totBenef = 0,
      totDesc = 0,
      totLiq = 0;

    if (emps.length === 0) {
      vrBody.innerHTML = `<tr><td colspan="10" style="color:#9fb1c3">N√£o h√° funcion√°rios ativos.</td></tr>`;
    } else {
      vrBody.innerHTML = emps
        .map((f) => {
          const c = conf[f.id] || {};
          const enabled = 'enabled' in c ? !!c.enabled : !!f.optVR;
          const salario = isFinite(c.sal) ? Number(c.sal) : Number(f.salario || 0);
          const daily = isFinite(c.daily) ? Number(c.daily) : s.daily;
          const days = Number.isFinite(c.days) ? Number(c.days) : s.days;
          const pct = Number.isFinite(c.pct) ? Number(c.pct) : s.pct;
          const creditD = Number.isFinite(c.day) ? Number(c.day) : s.creditDay;
          const next = nextDateForDay(creditD, new Date());

          const beneficio = enabled ? daily * days : 0;
          let desconto = enabled ? salario * (pct / 100) : 0;
          if (s.cap) desconto = Math.min(desconto, beneficio);
          const liquido = enabled ? beneficio - desconto : 0;

          if (enabled) {
            adesoes++;
            totBenef += beneficio;
            totDesc += desconto;
            totLiq += liquido;
          }

          const rowClass = enabled ? 'vr-on' : 'vr-off';
          return `<tr class="${rowClass}">
            <td><input type="checkbox" data-emp="${f.id}" data-field="enabled" ${enabled ? 'checked' : ''}></td>
            <td class="vr-cell-left">${f.nome}</td>
            <td><input type="number" min="0" step="0.01" data-emp="${f.id}" data-field="sal" value="${salario || 0}"></td>
            <td><input type="number" min="0" step="0.01" data-emp="${f.id}" data-field="daily" value="${Number(daily || 0).toFixed(2)}"></td>
            <td><input type="number" min="0" max="31" step="1" data-emp="${f.id}" data-field="days" value="${days}"></td>
            <td><input type="number" min="1" max="31" step="1" data-emp="${f.id}" data-field="day" value="${creditD}"></td>
            <td>${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}</td>
            <td class="vr-money">${brl(beneficio)}</td>
            <td class="vr-money">${brl(desconto)}</td>
            <td class="vr-money">${brl(liquido)}</td>
          </tr>`;
        })
        .join('');
    }

    if (vrKAdesoes) vrKAdesoes.textContent = String(adesoes);
    if (vrKBeneficio) vrKBeneficio.textContent = brl(totBenef);
    if (vrKDesconto) vrKDesconto.textContent = brl(totDesc);
    if (vrKLiquido) vrKLiquido.textContent = brl(totLiq);
    if (vrSumBeneficio) vrSumBeneficio.textContent = brl(totBenef);
    if (vrSumDesconto) vrSumDesconto.textContent = brl(totDesc);
    if (vrSumLiquido) vrSumLiquido.textContent = brl(totLiq);
  }
  vrDaily?.addEventListener('input', (e) => {
    let v = parseFloat(String(e.target.value).replace(',', '.'));
    if (!isFinite(v) || v < 0) v = 0;
    const s = getVRSettings();
    s.daily = v;
    setVRSettings(s);
    renderVR();
  });
  vrDays?.addEventListener('input', (e) => {
    let d = parseInt(e.target.value, 10);
    if (!isFinite(d) || d < 0) d = 0;
    if (d > 31) d = 31;
    const s = getVRSettings();
    s.days = d;
    setVRSettings(s);
    renderVR();
  });
  vrPct?.addEventListener('input', (e) => {
    let p = parseFloat(String(e.target.value).replace(',', '.'));
    if (!isFinite(p) || p < 0) p = 0;
    if (p > 100) p = 100;
    const s = getVRSettings();
    s.pct = p;
    setVRSettings(s);
    renderVR();
  });
  vrCreditDay?.addEventListener('input', (e) => {
    let d = parseInt(e.target.value, 10);
    if (!isFinite(d) || d < 1) d = 1;
    if (d > 31) d = 31;
    const s = getVRSettings();
    s.creditDay = d;
    setVRSettings(s);
    renderVR();
  });
  vrCapDiscount?.addEventListener('change', (e) => {
    const s = getVRSettings();
    s.cap = !!e.target.checked;
    setVRSettings(s);
    renderVR();
  });
  vrBody?.addEventListener('input', (e) => {
    const el = e.target;
    const id = el.getAttribute('data-emp');
    const field = el.getAttribute('data-field');
    if (!id || !field) return;

    const map = getVRMap();
    map[id] = map[id] || { enabled: false, sal: 0, daily: null, days: null, pct: null, day: null };

    if (field === 'enabled') map[id].enabled = !!el.checked;
    else if (field === 'sal') {
      let v = parseFloat(String(el.value).replace(',', '.'));
      if (!isFinite(v) || v < 0) v = 0;
      map[id].sal = v;
    } else if (field === 'daily') {
      let v = parseFloat(String(el.value).replace(',', '.'));
      if (!isFinite(v) || v < 0) v = 0;
      map[id].daily = v;
    } else if (field === 'days') {
      let v = parseInt(el.value, 10);
      if (!isFinite(v) || v < 0) v = 0;
      if (v > 31) v = 31;
      map[id].days = v;
    } else if (field === 'pct') {
      let v = parseFloat(String(el.value).replace(',', '.'));
      if (!isFinite(v) || v < 0) v = 0;
      if (v > 100) v = 100;
      map[id].pct = v;
    } else if (field === 'day') {
      let v = parseInt(el.value, 10);
      if (!isFinite(v) || v < 1) v = 1;
      if (v > 31) v = 31;
      map[id].day = v;
    }
    setVRMap(map);
    renderVR();
  });

  (function seedVR() {
    const map = getVRMap();
    if (Object.keys(map).length > 0) return;
    const emps = getFuncionariosLS().filter((f) => f.ativo);
    const s = getVRSettings();
    const m = {};
    emps.forEach((f) => {
      m[f.id] = {
        enabled: !!f.optVR,
        sal: Number(f.salario || 0),
        daily: s.daily,
        days: s.days,
        pct: s.pct,
        day: s.creditDay
      };
    });
    setVRMap(m);
  })();

  function collectVRRows() {
    const emps = getFuncionariosLS()
      .filter((f) => f.ativo)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    const conf = getVRMap();
    const s = getVRSettings();

    const rows = [];
    let adesoes = 0,
      totBenef = 0,
      totDesc = 0,
      totLiq = 0;

    for (const f of emps) {
      const c = conf[f.id] || {};
      const enabled = 'enabled' in c ? !!c.enabled : !!f.optVR;
      const salario = isFinite(c.sal) ? Number(c.sal) : Number(f.salario || 0);
      const daily = isFinite(c.daily) ? Number(c.daily) : s.daily;
      const days = Number.isFinite(c.days) ? Number(c.days) : s.days;
      const pct = Number.isFinite(c.pct) ? Number(c.pct) : s.pct;
      const creditD = Number.isFinite(c.day) ? Number(c.day) : s.creditDay;
      const next = nextDateForDay(creditD, new Date());

      const beneficio = enabled ? daily * days : 0;
      let desconto = enabled ? salario * (pct / 100) : 0;
      if (s.cap) desconto = Math.min(desconto, beneficio);
      const liquido = enabled ? beneficio - desconto : 0;

      if (enabled) {
        adesoes++;
        totBenef += beneficio;
        totDesc += desconto;
        totLiq += liquido;
      }

      rows.push({
        enabled,
        nome: f.nome,
        salario,
        daily,
        days,
        creditD,
        nextFmt: `${two(next.getDate())}/${two(next.getMonth() + 1)}/${next.getFullYear()}`,
        beneficio,
        desconto,
        liquido
      });
    }
    return { rows, adesoes, totBenef, totDesc, totLiq };
  }
  btnExportVRCSV?.addEventListener('click', () => {
    const { rows } = collectVRRows();
    const header = [
      'Optou',
      'Funcion√°rio',
      'Sal√°rio (R$)',
      'Valor di√°rio (R$)',
      'Dias √∫teis',
      'Dia cr√©dito',
      'Pr√≥ximo cr√©dito',
      'Benef√≠cio',
      'Desconto',
      'L√≠quido'
    ];
    const out = [header.join(';')];
    rows.forEach((r) => {
      out.push([
        r.enabled ? 'SIM' : 'N√ÉO',
        `"${r.nome.replace(/"/g, '""')}"`,
        r.salario.toFixed(2).replace('.', ','),
        r.daily.toFixed(2).replace('.', ','),
        r.days,
        r.creditD,
        r.nextFmt,
        r.beneficio.toFixed(2).replace('.', ','),
        r.desconto.toFixed(2).replace('.', ','),
        r.liquido.toFixed(2).replace('.', ',')
      ].join(';'));
    });
    const csv = out.join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'vale_refeicao.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    notify('CSV do VR exportado.', 'success');
  });
  btnExportVRPDF?.addEventListener('click', () => {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF n√£o carregado.', 'error');
    const { rows, totBenef, totDesc, totLiq } = collectVRRows();
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const mx = 28;
    let y = 36;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('Relat√≥rio ‚Äî Vale Refei√ß√£o', mx, y);
    y += 16;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(new Date().toLocaleString('pt-BR'), mx, y);
    y += 10;

    const headers = ['Optou', 'Funcion√°rio', 'Sal√°rio', 'V.Di√°rio', 'Dias', 'Dia', 'Pr√≥x. Cr√©dito', 'Benef√≠cio', 'Desconto', 'L√≠quido'];
    const widths = [44, 170, 64, 64, 36, 32, 110, 72, 72, 72];

    function drawHeader() {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      let x = mx;
      headers.forEach((h, i) => {
        doc.text(h, x + 4, y + 12);
        x += widths[i];
      });
      doc.setDrawColor(180);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;
      doc.setFont('helvetica', 'normal');
    }
    drawHeader();

    rows.forEach((r) => {
      if (y > 770) {
        doc.addPage();
        y = 36;
        drawHeader();
      }
      let x = mx;
      const cells = [
        r.enabled ? 'SIM' : 'N√ÉO',
        r.nome,
        'R$ ' + r.salario.toFixed(2).replace('.', ','),
        'R$ ' + r.daily.toFixed(2).replace('.', ','),
        String(r.days),
        String(r.creditD),
        r.nextFmt,
        'R$ ' + r.beneficio.toFixed(2).replace('.', ','),
        'R$ ' + r.desconto.toFixed(2).replace('.', ','),
        'R$ ' + r.liquido.toFixed(2).replace('.', ',')
      ];
      widths.forEach((w, i) => {
        doc.text(String(cells[i]), x + 4, y + 12);
        x += w;
      });
      doc.setDrawColor(230);
      doc.rect(mx, y, widths.reduce((a, b) => a + b, 0), 18, 'S');
      y += 18;
    });

    y += 8;
    doc.setFont('helvetica', 'bold');
    doc.text('Totais:', mx, y);
    doc.setFont('helvetica', 'normal');
    doc.text(
      `Benef√≠cio: R$ ${totBenef.toFixed(2).replace('.', ',')}   ‚Ä¢   Desconto: R$ ${totDesc
        .toFixed(2)
        .replace('.', ',')}   ‚Ä¢   L√≠quido: R$ ${totLiq.toFixed(2).replace('.', ',')}`,
      mx + 60,
      y
    );

    doc.save('vale_refeicao.pdf');
    notify('PDF do VR exportado.', 'success');
  });

  /* ===================== AJUSTES UI ===================== */
  function fitPontoTableToViewport() {
    try {
      const table = document.getElementById('tPonto');
      const wrap = table?.closest('.table-wrap');
      if (!table || !wrap) return;
      table.classList.remove('fit-mobile');
      table.style.transform = '';
      if (window.innerWidth > 430) return;
      const fullWidth = table.offsetWidth;
      const avail = wrap.clientWidth - 6;
      if (fullWidth > 0 && avail > 0) {
        const scale = Math.min(1, avail / fullWidth);
        if (scale < 1) {
          table.classList.add('fit-mobile');
          table.style.transform = `scale(${scale})`;
        }
      }
    } catch {}
  }
  window.addEventListener('resize', fitPontoTableToViewport);

  /* ===================== PUBLIC SIGN ===================== */
  function docTitleFromType(val) {
    const map = {
      interesse: 'DECLARA√á√ÉO DE INTERESSE',
      anuencia: 'CARTA DE ANU√äNCIA',
      dividas: 'DECLARA√á√ÉO DE AUS√äNCIA DE D√çVIDAS'
    };
    if (val && val.startsWith('tpl:')) {
      const tpl = (getTemplates() || []).find((t) => t.id === val.slice(4));
      return (tpl?.name || 'DOCUMENTO PERSONALIZADO').toUpperCase();
    }
    return (map[val] || 'DOCUMENTO').toUpperCase();
  }
  function buildSignLink() {
    const payload = {
      titulo: docTitleFromType(docTipo?.value),
      nome: docNome?.value || getMe().nome || '',
      documento: docDoc?.value || '',
      texto: String(docTexto?.value || '').slice(0, 250000)
    };
    const token = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const base = location.origin + location.pathname;
    return `${base}#assinar=${token}`;
  }
  btnGerarLinkAss?.addEventListener('click', () => {
    const link = buildSignLink();
    if (assLink) assLink.value = link;
    notify('Link de assinatura gerado!', 'success');
  });
  btnCopiarLinkAss?.addEventListener('click', async () => {
    if (!assLink?.value) return notify('Primeiro gere o link.', 'warn');
    try {
      await navigator.clipboard.writeText(assLink.value);
      notify('Link copiado.', 'success');
    } catch {
      notify('N√£o foi poss√≠vel copiar automaticamente.', 'warn');
    }
  });

  let sigPadPublic = null;
  function initSigPublic() {
    const canvas = $('sigPadPublic');
    if (!canvas) return;
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    const ctx = canvas.getContext('2d');
    ctx.scale(ratio, ratio);
    sigPadPublic = new SignaturePad(canvas, { minWidth: 1.2, maxWidth: 2.5, penColor: '#eaf6ff', backgroundColor: 'rgba(0,0,0,0)' });
  }
  function showPublicSign(data) {
    document.querySelector('.container')?.setAttribute('style', 'display:none!important');
    $('btnHamb')?.setAttribute('style', 'display:none!important');
    if (pubDocTitle) pubDocTitle.textContent = data.titulo || 'DOCUMENTO';
    if (pubDocWho) pubDocWho.textContent = data.nome ? `${data.nome} ‚Ä¢ ${data.documento || ''}` : '‚Äî';
    if (pubDocText) pubDocText.textContent = data.texto || '';
    publicSign && (publicSign.style.display = 'block');
    setTimeout(initSigPublic, 30);
  }
  function hidePublicSign() {
    publicSign && (publicSign.style.display = 'none');
    document.querySelector('.container')?.setAttribute('style', '');
    $('btnHamb')?.setAttribute('style', '');
  }
  function parseSignHash() {
    if (!location.hash.startsWith('#assinar=')) return null;
    try {
      const token = location.hash.slice('#assinar='.length);
      const json = decodeURIComponent(escape(atob(token)));
      return JSON.parse(json);
    } catch {
      return null;
    }
  }
  window.addEventListener('hashchange', () => {
    const data = parseSignHash();
    if (data) showPublicSign(data);
    else hidePublicSign();
  });
  btnLimparAssPublic?.addEventListener('click', () => sigPadPublic?.clear());
  btnFecharPublic?.addEventListener('click', () => {
    hidePublicSign();
    history.replaceState(null, '', location.pathname + location.search);
  });
  btnBaixarPDFPublic?.addEventListener('click', () => {
    const data = parseSignHash();
    if (!data) return notify('Algo deu errado com o link.', 'error');
    if (!sigPadPublic || sigPadPublic.isEmpty()) return notify('Assine no quadro antes de baixar.', 'warn');
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return notify('jsPDF n√£o carregado.', 'error');

    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const margin = 56;
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const contentW = pageW - margin * 2;
    const lineH = 16;
    let y = margin;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text(data.titulo || 'DOCUMENTO', margin, y);
    y += 22;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    if (data.nome) {
      doc.text(
        `Colaborador: ${data.nome}${data.documento ? ` ‚Äî Doc.: ${data.documento}` : ''}`,
        margin,
        y
      );
      y += 18;
    }
    const paragraphs = String(data.texto || '').split('\n');
    for (const p of paragraphs) {
      const wrapped = doc.splitTextToSize(p || ' ', contentW);
      const arr = Array.isArray(wrapped) ? wrapped : [wrapped];
      for (const part of arr) {
        if (y + lineH > pageH - margin) {
          doc.addPage();
          y = margin;
        }
        doc.text(String(part), margin, y);
        y += lineH;
      }
    }

    if (y + 100 > pageH - margin) {
      doc.addPage();
      y = margin;
    }
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Assinatura do colaborador:', margin, y);
    y += 8;
    const img = sigPadPublic.toDataURL('image/png');
    doc.addImage(img, 'PNG', margin, y, 240, 80);
    y += 90;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text('Assinado via link p√∫blico ‚Ä¢ ' + new Date().toLocaleString('pt-BR'), margin, pageH - 24);

    const safeName = (data.titulo || 'documento').replace(/\s+/g, '_').toLowerCase();
    doc.save(`${safeName}_assinado.pdf`);
    notify('PDF assinado gerado.', 'success');
  });

  /* ===================== DOMContentLoaded ===================== */
  document.addEventListener('DOMContentLoaded', () => {
    const me = getMe();
    if (docNome && !docNome.value) docNome.value = me.nome || '';
    refreshTexto();
    fitDocTextarea();
    fitPontoTableToViewport();

    /* Splash fade */
    const sp = $('splash');
    setTimeout(() => sp && sp.classList.add('hide'), 1200);
    setTimeout(() => sp && sp.remove(), 1800);

    /* Ancorar grade por padr√£o no "Gerenciar" */
    try {
      const body = document.querySelector('#tabFuncionarios .card-body');
      if (body && empGrid && !body.contains(empGrid)) body.appendChild(empGrid);
    } catch {}

    applyLayoutToUI();

    /* Alertas: varredura inicial */
    checkImportantDocExpirations();
    updateNotifDot();

    /* Public sign ao abrir com hash */
    const data = parseSignHash();
    if (data) showPublicSign(data);
  });
(() => {
  'use strict';

  /* ===== Chaves de storage ===== */
  const KEY_THEME = 'rh_theme_v2';
  const KEY_AUTH  = 'rh_auth_v1';

  /* ===== 3 Paletas ===== */
  const THEMES = {
    aurora: {
      name: 'Aurora (claro)',
      vars: { bg:'#f5f6fa', surface:'#ffffff', text:'#0f172a', muted:'#475569', primary:'#2563eb', accent:'#22c55e', border:'#e2e8f0', ok:'#16a34a', warn:'#f59e0b', err:'#ef4444' }
    },
    midnight: {
      name: 'Midnight (escuro)',
      vars: { bg:'#0b1220', surface:'#121a2b', text:'#e6edf3', muted:'#9fb1c3', primary:'#7aa2ff', accent:'#4ade80', border:'#24324a', ok:'#22c55e', warn:'#eab308', err:'#f87171' }
    },
    neon: {
      name: 'Neon (alto contraste)',
      vars: { bg:'#000000', surface:'#0d0d10', text:'#ffffff', muted:'#bdbdbd', primary:'#ff2fb9', accent:'#00e0ff', border:'#222222', ok:'#22d3ee', warn:'#fbbf24', err:'#fb7185' }
    }
  };

  /* ===== Utils ===== */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
   const notify = (msg, type='info') => {  
  let box = $('#toastContainer');
  if (!box) { (window.__nativeAlert || window.alert)(msg); return; }
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.innerHTML = `<div class="msg">${String(msg)}</div><span class="close">&times;</span>`;
    box.appendChild(el);
    setTimeout(()=>el.classList.add('show'), 10);
    const t = setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(), 180); }, 3200);
    el.querySelector('.close').onclick = ()=>{ clearTimeout(t); el.classList.remove('show'); setTimeout(()=>el.remove(), 120); };
  };

  /* ===== Tema (CSS Vars) ===== */
  function ensureThemeStyle() {
    let s = $('#themeVars');
    if (!s) { s = document.createElement('style'); s.id='themeVars'; document.head.appendChild(s); }
    return s;
  }
  function setThemeVars(vars) {
    const s = ensureThemeStyle();
    const rootVars = Object.entries(vars).map(([k,v])=>`--${k}:${v}`).join(';');
    s.textContent = `
      :root{${rootVars}}
      body{background:var(--bg);color:var(--text)}
      .card{background:var(--surface);border:1px solid var(--border)}
      .card-header{border-bottom:1px solid var(--border);color:var(--text)}
      .btn{background:var(--primary);border:1px solid var(--primary);color:#fff}
      .btn:hover{filter:brightness(.95)}
      .btn-light,.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
      input,select,textarea{background:var(--surface);color:var(--text);border:1px solid var(--border)}
      a{color:var(--primary)}
      .sidebar{background:var(--surface);border-right:1px solid var(--border)}
      .table-wrap table{background:var(--surface);color:var(--text)}
      .status-dot.ok{background:var(--ok)} .status-dot.warn{background:var(--warn)} .status-dot.err{background:var(--err)}
      .toast{background:var(--surface);border:1px solid var(--border);color:var(--text)}
      .toast.info{border-left:4px solid var(--primary)} .toast.success{border-left:4px solid var(--ok)}
      .toast.warn{border-left:4px solid var(--warn)} .toast.error{border-left:4px solid var(--err)}
    `;
  }
  function applyTheme(key) {
    const t = THEMES[key] || THEMES.aurora;
    document.documentElement.setAttribute('data-theme', key);
    setThemeVars(t.vars);
    localStorage.setItem(KEY_THEME, key);
    $$('.theme-option').forEach(el => el.classList.toggle('active', el.dataset.theme === key));
  }
  function initThemeAtStartup() {
    const saved = localStorage.getItem(KEY_THEME) || 'aurora';
    applyTheme(saved);
  }

  /* ===== Seguran√ßa (senha local) ===== */
  const enc = new TextEncoder();
  const subtle = (crypto && crypto.subtle) ? crypto.subtle : null;

  const hex = (buf) => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  const randHex = (n=16) => { const a = new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a).map(x=>x.toString(16).padStart(2,'0')).join(''); };

  async function sha256Hex(str){
    if (!subtle) return btoa(unescape(encodeURIComponent(str))); // fallback simples
    const buf = await subtle.digest('SHA-256', enc.encode(str));
    return hex(buf);
  }
  async function hashPassword(pass, salt){ return sha256Hex(`${salt}|${pass}`); }
  function getAuth(){ try { return JSON.parse(localStorage.getItem(KEY_AUTH)||'null'); } catch { return null; } }
  function setAuth(o){ localStorage.setItem(KEY_AUTH, JSON.stringify(o||{})); }

  async function verifyPassword(plain){
    const a = getAuth();
    if (!a || !a.hash) return (plain||'') === ''; // se nunca definiu senha
    const h = await hashPassword(plain||'', a.salt||'');
    return h === a.hash;
  }
  async function saveNewPassword(newPass){
    const salt = randHex(16);
    const hash = await hashPassword(newPass, salt);
    setAuth({ alg:'SHA-256', salt, hash, updatedAt:new Date().toISOString() });
  }

  /* ===== UI: Modal de Configura√ß√µes + FAB ===== */
  function ensureBaseStyles(){
    if ($('#cfgBaseStyles')) return;
    const s = document.createElement('style'); s.id='cfgBaseStyles';
    s.textContent = `
      #cfgFab{position:fixed;right:24px;bottom:24px;width:56px;height:56px;border-radius:9999px;border:none;cursor:pointer;z-index:9999;
              background:var(--primary);color:#fff;font-size:22px;display:grid;place-items:center;box-shadow:0 10px 25px rgba(0,0,0,.25)}
      #cfgFab:active{transform:scale(.98)}
      #cfgOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9998}
      #cfgModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(820px,96vw);max-height:86vh;overflow:auto;
                background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:none;z-index:9999}
      #cfgModal .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
      #cfgModal .modal-body{padding:16px}
      #cfgClose{background:transparent;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);cursor:pointer}
      .theme-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:10px}
      .theme-option{border:1px solid var(--border);border-radius:14px;padding:12px;cursor:pointer;background:var(--surface);transition:transform .12s ease}
      .theme-option:hover{transform:translateY(-2px)} .theme-option.active{outline:2px solid var(--primary)}
      .theme-name{font-weight:600;margin-bottom:8px}
      .swatches{display:flex;gap:6px} .sw{width:26px;height:26px;border-radius:7px;border:1px solid var(--border)}
      .grid2{display:grid;gap:18px;grid-template-columns:1fr} @media(min-width:992px){.grid2{grid-template-columns:1fr 1fr}}
      .cfg-row{display:flex;flex-direction:column;margin:8px 0} .cfg-row label{font-size:.9rem;color:var(--muted);margin-bottom:6px}
      .cfg-row input{height:40px;border-radius:8px;padding:8px 10px}
      #toastContainer{position:fixed;right:20px;bottom:92px;display:flex;flex-direction:column;gap:10px;z-index:10000}
      .toast{opacity:0;transform:translateY(8px);transition:all .18s ease;border-radius:10px;padding:10px 12px}
      .toast.show{opacity:1;transform:translateY(0)} .toast .close{margin-left:10px;cursor:pointer}
    `;
    document.head.appendChild(s);
  }

  function themeOptionHTML(key, t){
    const v = t.vars, sw = (c)=>`<span class="sw" style="background:${c}"></span>`;
    return `
      <div class="theme-option" data-theme="${key}" role="button" tabindex="0" aria-label="Trocar para ${t.name}">
        <div class="theme-name">${t.name}</div>
        <div class="swatches">${sw(v.primary)} ${sw(v.accent)} ${sw(v.surface)} ${sw(v.text)} ${sw(v.border)}</div>
      </div>
    `;
  }

  function ensureConfigModal(){
    if ($('#cfgModal')) return;

    // overlay + modal
    const overlay = document.createElement('div'); overlay.id = 'cfgOverlay';
    const modal   = document.createElement('div'); modal.id   = 'cfgModal';
    modal.innerHTML = `
      <div class="modal-header">
        <h3 style="margin:0">Configura√ß√µes</h3>
        <button id="cfgClose">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="grid2">
          <section>
            <h4 style="margin:.2rem 0 .3rem">Apar√™ncia</h4>
            <p>Escolha uma das <strong>3 paletas</strong>. Aplica na hora e salva no dispositivo.</p>
            <div class="theme-grid">
              ${Object.entries(THEMES).map(([k,t])=>themeOptionHTML(k,t)).join('')}
            </div>
          </section>
          <section>
            <h4 style="margin:.2rem 0 .3rem">Seguran√ßa</h4>
            <div class="cfg-row"><label for="cfgPassCurrent">Senha atual (vazio se nunca definiu)</label><input type="password" id="cfgPassCurrent" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div class="cfg-row"><label for="cfgPassNew">Nova senha</label><input type="password" id="cfgPassNew" autocomplete="new-password" placeholder="m√≠nimo 6 caracteres"></div>
            <div class="cfg-row"><label for="cfgPassNew2">Confirmar nova senha</label><input type="password" id="cfgPassNew2" autocomplete="new-password" placeholder="repita a nova senha"></div>
            <button class="btn" id="btnSavePassword">Salvar nova senha</button>
          </section>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    document.body.appendChild(modal);

    // FAB
    const fab = document.createElement('button');
    fab.id = 'cfgFab';
    fab.title = 'Configura√ß√µes (Ctrl+,)';
    fab.setAttribute('aria-label', 'Abrir Configura√ß√µes');
    fab.innerHTML = '‚öôÔ∏è';
    document.body.appendChild(fab);

    // toast container
    if (!$('#toastContainer')) {
      const tc = document.createElement('div'); tc.id='toastContainer'; document.body.appendChild(tc);
    }

    // eventos
    const open = () => { overlay.style.display='block'; modal.style.display='block'; fab.style.display='none'; };
    const close = () => { overlay.style.display='none'; modal.style.display='none'; fab.style.display='grid'; };

    overlay.addEventListener('click', close);
    $('#cfgClose').addEventListener('click', close);
    $('#cfgFab').addEventListener('click', open);
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key === ',') { e.preventDefault(); open(); }
      if (e.key === 'Escape') close();
    });

    // tema eventos
    $$('.theme-option', modal).forEach(el=>{
      el.addEventListener('click', ()=>applyTheme(el.dataset.theme));
      el.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); applyTheme(el.dataset.theme); }});
    });

    // marcar tema atual
    const current = localStorage.getItem(KEY_THEME) || 'aurora';
    $$('.theme-option').forEach(el => el.classList.toggle('active', el.dataset.theme === current));

    // senha eventos
    $('#btnSavePassword').addEventListener('click', async ()=>{
      const cur = $('#cfgPassCurrent')?.value || '';
      const n1  = $('#cfgPassNew')?.value || '';
      const n2  = $('#cfgPassNew2')?.value || '';

      if (!n1 || n1.length < 6) return notify('A nova senha deve ter ao menos 6 caracteres.','warn');
      if (n1 !== n2) return notify('A confirma√ß√£o n√£o confere.','warn');

      const ok = await verifyPassword(cur);
      if (!ok) return notify('Senha atual incorreta.','error');

      await saveNewPassword(n1);
      $('#cfgPassCurrent').value = ''; $('#cfgPassNew').value=''; $('#cfgPassNew2').value='';
      notify('Senha alterada com sucesso.','success');
    });

    // integra√ß√£o opcional com menu existente
    const menu = $('#menu');
    if (menu && !menu.querySelector('[data-open-config]')) {
      const li = document.createElement('li');
      li.setAttribute('data-open-config','true');
      li.style.cursor = 'pointer';
      li.innerHTML = '‚öôÔ∏è Configura√ß√µes';
      li.addEventListener('click', open);
      menu.appendChild(li);
    }
  }

  /* ===== Boot robusto ===== */
  function boot(){
    ensureThemeStyle();     // prepara tag <style> dos temas
    initThemeAtStartup();   // aplica tema salvo imediatamente
    ensureBaseStyles();     // CSS do modal/FAB/toast
    ensureConfigModal();    // injeta modal + FAB + eventos
  }

  // roda agora ou quando o DOM estiver pronto (cobre os dois cen√°rios)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    boot();
  }
})();


})();

/* ========= CONSTANTES/UTILS ========= */
    const VAR_REGEX = /\{\s*([a-zA-Z0-9_.|]+)\s*\}/g; // <-- corrigido
    const LS_KEY = "ATRIUM_TEMPLATES_V1";
    const LS_LAYOUT = "ATRIUM_LAYOUT_V1";
    const uid = () => String(Date.now()) + "_" + Math.random().toString(36).slice(2,8);
    const escapeHTML = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    function resolvePath(obj, path){ try{ return path.split('.').reduce((a,k)=> (a && a[k]!=null ? a[k] : undefined), obj); }catch{ return undefined; } }
    function applyPipes(value, pipe){
      if(value==null) return '';
      const s = String(value);
      switch(pipe){
        case 'upper': return s.toUpperCase();
        case 'lower': return s.toLowerCase();
        case 'title': return s.replace(/\w\S*/g, w=> w[0].toUpperCase()+w.slice(1).toLowerCase());
        case 'money': return Number(s).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        case 'date':  return new Date(s).toLocaleDateString('pt-BR');
        default: return s;
      }
    }
    function replaceVariables(html, data){
      const today = new Date().toLocaleDateString('pt-BR');
      return html.replace(VAR_REGEX, (_, inner)=>{
        const [path, pipe] = String(inner).split('|');
        const val = path==='hoje' ? today : resolvePath(data, path);
        return applyPipes(val, pipe);
      });
    }
    function extractVariables(html){
      const set = new Set(); let m;
      while((m = VAR_REGEX.exec(html))){ set.add(String(m[1]).split('|')[0]); }
      return Array.from(set).sort();
    }

    /* ========= MOCKS ========= */
    const FUNCIONARIOS = [
      { id:"1", nome:"Gustavo Henrique Grigorio Silva", cpf:"123.456.789-00", cargo:"Analista de RH", salario:5500.75, admissao:"2024-03-18", email:"gustavo.silva@imperio.com.br", telefone:"+55 (11) 99999-0000",
        endereco:{logradouro:"Av. Paulista, 1000",cidade:"S√£o Paulo",estado:"SP",cep:"01310-000"},
        ferias:{periodo_aquisitivo:"2024-03-18 a 2025-03-17",inicio:"2025-12-01",fim:"2025-12-30"} },
      { id:"2", nome:"Ana Ribeiro", cpf:"987.654.321-00", cargo:"Desenvolvedora Front-end", salario:7800, admissao:"2023-08-02", email:"ana.ribeiro@imperio.com.br", telefone:"+55 (11) 98888-7777",
        endereco:{logradouro:"Rua das Flores, 200",cidade:"Campinas",estado:"SP",cep:"13000-000"} }
    ];
    const BUILTIN_TEMPLATES = [
      { id:"builtin_contrato", nome:"Contrato de Trabalho ‚Äì Padr√£o", html: `
          <h2 style="text-align:center">CONTRATO DE TRABALHO</h2>
          <p>Empregador: <strong>Atrium Tecnologia LTDA</strong></p>
          <p>Empregado: <strong>{nome}</strong>, CPF {cpf}, residente em {endereco.logradouro}, {endereco.cidade}/{endereco.estado}.</p>
          <p>O empregado exercer√° a fun√ß√£o de <strong>{cargo}</strong>, com sal√°rio mensal de {salario|money}, a partir de {admissao|date}.</p>
          <p>E-mail: {email} ‚Äî Telefone: {telefone}</p>
          <p>Este contrato entra em vigor na data de {hoje}.</p>
      `, builtin:true },
      { id:"builtin_ferias", nome:"Aviso de F√©rias", html: `
          <h2 style="text-align:center">AVISO DE F√âRIAS</h2>
          <p>Colaborador(a): <strong>{nome}</strong> ‚Äî CPF {cpf}</p>
          <p>Per√≠odo aquisitivo: {ferias.periodo_aquisitivo}</p>
          <p>Per√≠odo de gozo: {ferias.inicio|date} a {ferias.fim|date}</p>
          <p>Local: {endereco.cidade} ‚Äî Data: {hoje}</p>
      `, builtin:true }
    ];

    /* ========= STORAGE ========= */
    const loadUserTemplates = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch{ return []; } };
    const saveUserTemplates = list => localStorage.setItem(LS_KEY, JSON.stringify(list));
    const getAllTemplates = () => [...BUILTIN_TEMPLATES, ...loadUserTemplates()];

    /* ========= ELEMENTOS ========= */
    const btnTemplates = document.getElementById('btn-templates');
    const btnOpen  = document.getElementById('btn-open');
    const wizard   = document.getElementById('wizard');
    const wizardModal = document.getElementById('wizardModal');
    const step1    = document.getElementById('step1');
    const step2    = document.getElementById('step2');
    const btnClose = document.getElementById('btn-close');
    const btnBack  = document.getElementById('btn-back');
    const btnNext  = document.getElementById('btn-next');
    const btnConcluir = document.getElementById('btn-concluir');

    const templateSel = document.getElementById('template');
    const funcSel  = document.getElementById('func');
    const funcWrap = document.getElementById('func-wrap');

    const editor  = document.getElementById('editor');
       const preview = document.getElementById('preview');
    const varsBox = document.getElementById('vars');
    const chkPrev = document.getElementById('chk-preview');
    const btnClear= document.getElementById('btn-clear');
    const printArea = document.getElementById('print-area');

    // Templates modal
    const tplModal     = document.getElementById('tplModal');
    const btnCloseTpl  = document.getElementById('btn-close-tpl');
    const tplListView  = document.getElementById('tplListView');
    const tplEditView  = document.getElementById('tplEditView');
    const tplList      = document.getElementById('tplList');
    const btnNewTpl    = document.getElementById('btn-new-tpl');
    const btnBackList  = document.getElementById('btn-back-list');
    const btnSaveTpl   = document.getElementById('btn-save-tpl');
    const tplName      = document.getElementById('tplName');
    const tplEditor    = document.getElementById('tplEditor');
    const docxTpl      = document.getElementById('docxTpl');
    const docxTplBtn   = document.getElementById('docxTplBtn');
    const docxTplInfo  = document.getElementById('docxTplInfo');
    const tplVars      = document.getElementById('tplVars');
    const btnClearTpl  = document.getElementById('btn-clear-tpl');

    /* ======= NOVOS ELEMENTOS (Layout) ======= */
    const lyFontFamily  = document.getElementById('ly-font-family');
    const lyFontSize    = document.getElementById('ly-font-size');
    const lyLineHeight  = document.getElementById('ly-line-height');
    const lyPSpacing    = document.getElementById('ly-p-spacing');
    const lyH1 = document.getElementById('ly-h1');
    const lyH2 = document.getElementById('ly-h2');
    const lyH3 = document.getElementById('ly-h3');
    const lyPageFormat  = document.getElementById('ly-page-format');
    const lyOrientation = document.getElementById('ly-orientation');
    const lyMT = document.getElementById('ly-mt');
    const lyMR = document.getElementById('ly-mr');
    const lyMB = document.getElementById('ly-mb');
    const lyML = document.getElementById('ly-ml');
    const lyLogoEnabled = document.getElementById('ly-logo-enabled');
    const lyLogoSize    = document.getElementById('ly-logo-size');
    const lyLogoAlign   = document.getElementById('ly-logo-align');
    const lyLogoSpace   = document.getElementById('ly-logo-space');
    const lyLogoFile    = document.getElementById('ly-logo-file');
    const lyLogoFileBtn = document.getElementById('ly-logo-file-btn');
    const lyLogoFileInfo= document.getElementById('ly-logo-file-info');
    const lySave        = document.getElementById('ly-save');
    const lyReset       = document.getElementById('ly-reset');
    const lyLogoResizeFirst = document.getElementById('ly-logo-resize-first');

    // Estado
    let currentTemplate = getAllTemplates()[0];
    let currentFuncionario = FUNCIONARIOS[0];
    let editingTemplateId = null;

    /* ========= LAYOUT ========= */
    const DEFAULT_LAYOUT = {
      fontFamily: 'Arial, Helvetica, sans-serif',
      fontSize: 11,
      lineHeight: 1.4,
      paragraphSpacing: 8,
      h1: 1.6, h2: 1.3, h3: 1.15,
      pageFormat: 'a4',       // a4 | letter
      orientation: 'p',       // p | l
      marginTop: 20,          // mm
      marginRight: 15,
      marginBottom: 20,
      marginLeft: 15,
      logoEnabled: false,
      logoData: '',           // dataURL
      logoSize: 120,          // px
      logoAlign: 'center',    // left|center|right
      logoSpace: 12,          // px
      logoResizeFirst: true   // aplicar tamanho do logo √† primeira imagem do conte√∫do
    };
    let LAYOUT = loadLayout() || { ...DEFAULT_LAYOUT };

    function loadLayout(){
      try{
        const raw = localStorage.getItem(LS_LAYOUT);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_LAYOUT, ...parsed };
      }catch{ return null; }
    }
    function saveLayout(){
      localStorage.setItem(LS_LAYOUT, JSON.stringify(LAYOUT));
      alert('Configura√ß√µes de layout salvas como padr√£o!');
    }
    function mmToPt(mm){ return mm * (72/25.4); }
    function ptToPx(pt){ return pt * (96/72); }

    const PAGE_SIZES_PT = {
      a4:     { w: 595.28, h: 841.89 },
      letter: { w: 612.00, h: 792.00 }
    };
    function getPageSizePt(layout){
      const base = PAGE_SIZES_PT[layout.pageFormat] || PAGE_SIZES_PT.a4;
      return (layout.orientation==='l')
        ? { w: base.h, h: base.w }
        : { w: base.w, h: base.h };
    }

    function populateLayoutUI(){
      lyFontFamily.value  = LAYOUT.fontFamily;
      lyFontSize.value    = LAYOUT.fontSize;
      lyLineHeight.value  = LAYOUT.lineHeight;
      lyPSpacing.value    = LAYOUT.paragraphSpacing;
      lyH1.value = LAYOUT.h1; lyH2.value = LAYOUT.h2; lyH3.value = LAYOUT.h3;
      lyPageFormat.value  = LAYOUT.pageFormat;
      lyOrientation.value = LAYOUT.orientation;
      lyMT.value = LAYOUT.marginTop;
      lyMR.value = LAYOUT.marginRight;
      lyMB.value = LAYOUT.marginBottom;
      lyML.value = LAYOUT.marginLeft;
      lyLogoEnabled.checked = LAYOUT.logoEnabled;
      lyLogoSize.value    = LAYOUT.logoSize;
      lyLogoAlign.value   = LAYOUT.logoAlign;
      lyLogoSpace.value   = LAYOUT.logoSpace;
      lyLogoFileInfo.textContent = LAYOUT.logoData ? 'Imagem carregada' : 'Nenhum arquivo selecionado';
      lyLogoResizeFirst.checked = LAYOUT.logoResizeFirst;
    }
    function readLayoutFromUI(){
      LAYOUT.fontFamily = lyFontFamily.value || DEFAULT_LAYOUT.fontFamily;
      LAYOUT.fontSize   = Math.max(8, Math.min(20, Number(lyFontSize.value)||DEFAULT_LAYOUT.fontSize));
      LAYOUT.lineHeight = Math.max(1, Math.min(2, Number(lyLineHeight.value)||DEFAULT_LAYOUT.lineHeight));
      LAYOUT.paragraphSpacing = Math.max(0, Math.min(40, Number(lyPSpacing.value)||DEFAULT_LAYOUT.paragraphSpacing));
      LAYOUT.h1 = Number(lyH1.value)||DEFAULT_LAYOUT.h1;
      LAYOUT.h2 = Number(lyH2.value)||DEFAULT_LAYOUT.h2;
      LAYOUT.h3 = Number(lyH3.value)||DEFAULT_LAYOUT.h3;
      LAYOUT.pageFormat = lyPageFormat.value;
      LAYOUT.orientation= lyOrientation.value;
      LAYOUT.marginTop = Number(lyMT.value)||DEFAULT_LAYOUT.marginTop;
      LAYOUT.marginRight=Number(lyMR.value)||DEFAULT_LAYOUT.marginRight;
      LAYOUT.marginBottom=Number(lyMB.value)||DEFAULT_LAYOUT.marginBottom;
      LAYOUT.marginLeft= Number(lyML.value)||DEFAULT_LAYOUT.marginLeft;
      LAYOUT.logoEnabled = !!lyLogoEnabled.checked;
      LAYOUT.logoSize = Math.max(24, Math.min(600, Number(lyLogoSize.value)||DEFAULT_LAYOUT.logoSize));
      LAYOUT.logoAlign = lyLogoAlign.value;
      LAYOUT.logoSpace = Math.max(0, Math.min(80, Number(lyLogoSpace.value)||DEFAULT_LAYOUT.logoSpace));
      LAYOUT.logoResizeFirst = !!lyLogoResizeFirst.checked;
    }

    function adjustContentImages(innerHTML){
      if(!LAYOUT.logoResizeFirst) return innerHTML;
      const temp = document.createElement('div');
      temp.innerHTML = innerHTML;
      const img = temp.querySelector('img');
      if(img){
        // remove larguras antigas do DOCX
        img.removeAttribute('width');
        img.removeAttribute('height');
        // aplica novo tamanho e alinhamento a partir do layout
        img.style.width = 'var(--doc-logo-size)';
        img.style.height = 'auto';
        img.style.display = 'block';
        img.style.marginBottom = 'var(--doc-logo-space)';
        // alinhamento
        if(LAYOUT.logoAlign === 'center'){
          img.style.marginLeft = 'auto'; img.style.marginRight = 'auto';
        }else if(LAYOUT.logoAlign === 'right'){
          img.style.marginLeft = 'auto'; img.style.marginRight = '0';
        }else{
          img.style.marginLeft = '0'; img.style.marginRight = 'auto';
        }
      }
      return temp.innerHTML;
    }

    function buildDocHTML(innerHTML){
      // opcionalmente ajusta a primeira imagem como "logo importado"
      const processedHTML = adjustContentImages(innerHTML);

      const styleVars = `
        --doc-font-size:${LAYOUT.fontSize}px;
        --doc-line-height:${LAYOUT.lineHeight};
        --doc-paragraph-spacing:${LAYOUT.paragraphSpacing}px;
        --doc-font-family:${LAYOUT.fontFamily};
        --doc-h1-scale:${LAYOUT.h1};
        --doc-h2-scale:${LAYOUT.h2};
        --doc-h3-scale:${LAYOUT.h3};
        --doc-logo-size:${LAYOUT.logoSize}px;
        --doc-logo-space:${LAYOUT.logoSpace}px;
      `;
      const logoHTML = (LAYOUT.logoEnabled && LAYOUT.logoData)
        ? `<div class="doc-logo" style="text-align:${LAYOUT.logoAlign}"><img src="${LAYOUT.logoData}" alt="Logo"></div>`
        : '';
      return `<div class="doc-root" style="${styleVars}">${logoHTML}${processedHTML}</div>`;
    }

    function dataURLFromFile(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /* ========= INIT SELECTS ========= */
    function refreshTemplateSelect(){
      const allBuiltins = [...BUILTIN_TEMPLATES];
      const allUser     = loadUserTemplates();

      templateSel.innerHTML = "";

      // padr√µes
      allBuiltins.forEach(t => {
        const o = document.createElement('option');
        o.value = t.id; o.textContent = t.nome;
        templateSel.appendChild(o);
      });

      // personalizados
      if (allUser.length){
        const og = document.createElement('optgroup');
        og.label = '‚Äî Personalizados ‚Äî';
        allUser.forEach(t => {
          const o = document.createElement('option');
          o.value = t.id; o.textContent = t.nome;
          og.appendChild(o);
        });
        templateSel.appendChild(og);
      }

      // sele√ß√£o atual
      const all = [...allBuiltins, ...allUser];
      const exists = all.find(t=>t.id===currentTemplate?.id);
      templateSel.value = exists ? currentTemplate.id : (all[0] && all[0].id);
      if(!exists) currentTemplate = all[0];
    }
    function populateFuncionarios(){
      funcSel.innerHTML = "";
      FUNCIONARIOS.forEach(f => {
        const o = document.createElement('option'); o.value=f.id; o.textContent=f.nome; funcSel.appendChild(o);
      });
      funcSel.value = currentFuncionario.id;
    }

    /* ========= VARS / PREVIEW ========= */
    const getHTML = () => editor.innerHTML;
    function updateVarsList(){
      const vars = extractVariables(getHTML());
      varsBox.innerHTML = vars.length
        ? vars.map(v => `<span class="pill" data-var="${v}">{${v}}</span>`).join('')
        : `<small class="muted">Nenhuma vari√°vel encontrada. Use chaves, ex.: <code>{nome}</code>.</small>`;
      varsBox.querySelectorAll('[data-var]').forEach(el=>{
        el.addEventListener('click', ()=>{
          insertAtCaret(editor, `{${el.dataset.var}}`);
          editor.focus(); updateVarsList(); updatePreview();
        });
      });
    }

    function updatePreview(){
      const data = (getVinculo()==='sim') ? currentFuncionario : {};
      const finalHTML = replaceVariables(getHTML(), data);
      const docHTML = buildDocHTML(finalHTML);

      const page = getPageSizePt(LAYOUT);
      const pageWidthPx = ptToPx(page.w);
      const padTopPx = ptToPx(mmToPt(LAYOUT.marginTop));
      const padRightPx= ptToPx(mmToPt(LAYOUT.marginRight));
      const padBottomPx=ptToPx(mmToPt(LAYOUT.marginBottom));
      const padLeftPx = ptToPx(mmToPt(LAYOUT.marginLeft));

      preview.innerHTML = `
        <div class="preview-page"
             style="width:${pageWidthPx}px; padding:${padTopPx}px ${padRightPx}px ${padBottomPx}px ${padLeftPx}px;">
          ${chkPrev.checked ? docHTML : buildDocHTML(getHTML())}
        </div>`;
    }

    function insertAtCaret(container, text){
      const sel = window.getSelection();
      if(!sel || sel.rangeCount===0){ container.appendChild(document.createTextNode(text)); return; }
      const range = sel.getRangeAt(0);
      if(!container.contains(range.commonAncestorContainer)){ container.appendChild(document.createTextNode(text)); return; }
      range.deleteContents(); range.insertNode(document.createTextNode(text)); range.collapse(false);
      sel.removeAllRanges(); sel.addRange(range);
    }

    /* ========= WIZARD OPEN / NAV ========= */
    btnOpen.addEventListener('click', () => { wizard.style.display='flex'; goStep(1); });
    btnClose.addEventListener('click', () => wizard.style.display='none');
    wizard.addEventListener('click', (e)=>{ if(e.target===wizard) wizard.style.display='none'; });
    btnBack.addEventListener('click', ()=> goStep(1));
    btnNext.addEventListener('click', ()=>{ if(isStep(1)) goStep(2); });
    btnConcluir.addEventListener('click', exportPDF);

    templateSel.addEventListener('change', (e)=>{
      const id = e.target.value;
      const all = getAllTemplates();
      currentTemplate = all.find(t=>t.id===id) || all[0];
      editor.innerHTML = currentTemplate.html;
      updateVarsList(); updatePreview();
    });
    funcSel.addEventListener('change', (e)=>{
      currentFuncionario = FUNCIONARIOS.find(f=>f.id===e.target.value) || FUNCIONARIOS[0];
      updatePreview();
    });
    function getVinculo(){ return (document.querySelector('input[name="vinc"]:checked')||{}).value || 'sim'; }

    document.querySelectorAll('.tb-btn[data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=> document.execCommand(btn.dataset.cmd, false, null));
    });
    btnClear.addEventListener('click', ()=>{
      const text = editor.innerText || '';
      const cleaned = text.replace(/\s{2,}/g,' ').replace(/\n{3,}/g,'\n\n');
      editor.innerHTML = '<p>' + cleaned.split('\n').map(p=>p.trim()).filter(Boolean).map(escapeHTML).join('</p><p>') + '</p>';
      updatePreview();
    });
    chkPrev.addEventListener('change', updatePreview);

    /* ========= PDF COM QUEBRA DE P√ÅGINA ========= */
    async function exportPDF(){
      try{
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          unit:'pt',
          format: LAYOUT.pageFormat,
          orientation: LAYOUT.orientation==='l' ? 'landscape' : 'portrait',
          compress:true
        });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        // Margens em pontos a partir de mm
        const marginTop = mmToPt(LAYOUT.marginTop);
        const marginRight = mmToPt(LAYOUT.marginRight);
        const marginBottom = mmToPt(LAYOUT.marginBottom);
        const marginLeft = mmToPt(LAYOUT.marginLeft);

        const usableW = pageW - marginLeft - marginRight;
        const usableH = pageH - marginTop - marginBottom;

        const data = (getVinculo()==='sim') ? currentFuncionario : {};
        const finalHTML = replaceVariables(getHTML(), data);
        const docHTML = buildDocHTML(finalHTML);

        const wrapper = document.getElementById('print-area');
        wrapper.innerHTML = `<div id="print-root" style="width:${usableW}px; font-family:Arial, Helvetica, sans-serif;">${docHTML}</div>`;

        const scale = 2; // qualidade
        const canvas = await html2canvas(document.getElementById('print-root'), {
          backgroundColor:'#ffffff', scale, useCORS:true, logging:false
        });

        // px por ponto na largura usada
        const pxPerPt = canvas.width / usableW;
        const pageHeightPx = usableH * pxPerPt;

        let sY = 0, pageIndex = 0;
        while (sY < canvas.height) {
          const sliceHeight = Math.min(pageHeightPx, canvas.height - sY);

          const pageCanvas = document.createElement('canvas');
          pageCanvas.width  = canvas.width;
          pageCanvas.height = sliceHeight;
          const ctx = pageCanvas.getContext('2d');
          ctx.drawImage(canvas, 0, sY, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);

          const imgData = pageCanvas.toDataURL('image/png');
          const sliceHpt = sliceHeight / pxPerPt;

          if (pageIndex > 0) pdf.addPage();
          pdf.addImage(imgData, 'PNG', marginLeft, marginTop, usableW, sliceHpt);

          sY += sliceHeight;
          pageIndex++;
        }

        pdf.save('documento_atrium.pdf');
        alert('PDF gerado e baixado!');
      }catch(err){
        console.error(err); alert('Falha ao gerar PDF. Veja o console.');
      }
    }

    /* ========= MODAL TEMPLATES (CRUD localStorage) ========= */
    const openTplList = () => { tplModal.style.display='flex'; tplListView.style.display=''; tplEditView.style.display='none'; renderTplList(); };
    const closeTpl = () => tplModal.style.display='none';
    btnTemplates.addEventListener('click', openTplList);
    btnCloseTpl.addEventListener('click', closeTpl);
    document.getElementById('tplModal').addEventListener('click', (e)=>{ if(e.target.id==='tplModal') closeTpl(); });

    btnNewTpl.addEventListener('click', ()=> openTplEditor());
    btnBackList.addEventListener('click', openTplList);

    function renderTplList(){
      const all = getAllTemplates();
      tplList.innerHTML = all.map(t => {
        const isBuiltin = !!t.builtin;
        const actions = isBuiltin
          ? `<button class="btn tiny-btn" data-act="use" data-id="${t.id}">Usar</button>
             <button class="btn secondary tiny-btn" data-act="dup" data-id="${t.id}">Duplicar</button>`
          : `<button class="btn tiny-btn" data-act="use" data-id="${t.id}">Usar</button>
             <button class="btn secondary tiny-btn" data-act="edit" data-id="${t.id}">Editar</button>
             <button class="btn secondary tiny-btn" data-act="dup" data-id="${t.id}">Duplicar</button>
             <button class="btn secondary tiny-btn" data-act="del" data-id="${t.id}">Excluir</button>`;
        return `<div class="item">
                  <div>
                    <div class="name">${t.nome}${isBuiltin ? ' <span class="tiny">(padr√£o)</span>' : ''}</div>
                    <div class="tiny">${extractVariables(t.html).map(v=>`{${v}}`).join(' ‚Ä¢ ') || '‚Äî sem vari√°veis ‚Äî'}</div>
                  </div>
                  <div style="display:flex;gap:6px">${actions}</div>
                </div>`;
      }).join('');

      tplList.querySelectorAll('[data-act]').forEach(btn=>{
        const id = btn.dataset.id; const act = btn.dataset.act;
        btn.addEventListener('click', ()=>{
          const all = getAllTemplates();
          const tpl = all.find(x=>x.id===id);
          if(!tpl) return;
          if(act==='use'){
            currentTemplate = tpl; refreshTemplateSelect(); templateSel.value = tpl.id;
            editor.innerHTML = tpl.html; updateVarsList(); updatePreview();
            tplModal.style.display='none'; wizard.style.display='flex'; goStep(1);
          } else if(act==='edit'){
            openTplEditor(tpl);
          } else if(act==='dup'){
            const user = loadUserTemplates();
            const copy = { id: uid(), nome: tpl.nome + " (c√≥pia)", html: tpl.html };
            saveUserTemplates([...user, copy]); renderTplList(); refreshTemplateSelect(); alert('Template duplicado.');
          } else if(act==='del'){
            if(!confirm('Excluir este template?')) return;
            const user = loadUserTemplates().filter(x=>x.id!==id);
            saveUserTemplates(user); renderTplList(); refreshTemplateSelect();
          }
        });
      });
    }

    function openTplEditor(template = null){
      editingTemplateId = template?.id ?? null;
      tplListView.style.display='none';
      tplEditView.style.display='';
      tplName.value = template?.nome ?? "";
      tplEditor.innerHTML = template?.html ?? "<p>Digite/cole seu conte√∫do aqui‚Ä¶</p>";
      updateTplVars();
      docxTpl.value = ""; docxTplInfo.textContent = "Nenhum arquivo selecionado";
    }

    // importar docx (estilizado)
    docxTplBtn.addEventListener('click', ()=> docxTpl.click());
    docxTpl.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      docxTplInfo.textContent = file ? file.name : "Nenhum arquivo selecionado";
      if(!file) return;
      if(!/\.docx$/i.test(file.name)){ alert('Selecione um arquivo .docx'); return; }
      try{
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.convertToHtml({ arrayBuffer });
        tplEditor.innerHTML = result.value || '<p>(Documento sem conte√∫do)</p>';
        updateTplVars();
      }catch(err){ console.error(err); alert('Falha ao importar o .docx'); }
    });

    function updateTplVars(){
      const vars = extractVariables(tplEditor.innerHTML);
      tplVars.innerHTML = vars.length
        ? vars.map(v => `<span class="pill" data-var="${v}">{${v}}</span>`).join('')
        : `<small class="muted">Nenhuma vari√°vel detectada. Voc√™ pode digitar vari√°veis usando {chaves}.</small>`;
      tplVars.querySelectorAll('[data-var]').forEach(el=>{
        el.addEventListener('click', ()=>{
          insertAtCaret(tplEditor, `{${el.dataset.var}}`);
          tplEditor.focus(); updateTplVars();
        });
      });
    }
    document.getElementById('btn-clear-tpl').addEventListener('click', ()=>{
      const text = tplEditor.innerText || '';
      const cleaned = text.replace(/\s{2,}/g,' ').replace(/\n{3,}/g,'\n\n');
      tplEditor.innerHTML = '<p>' + cleaned.split('\n').map(p=>p.trim()).filter(Boolean).map(escapeHTML).join('</p><p>') + '</p>';
      updateTplVars();
    });

    // salvar template
    btnSaveTpl.addEventListener('click', ()=>{
      const nome = (tplName.value || "").trim();
      if(!nome){ alert('D√™ um nome ao template.'); return; }
      const html = tplEditor.innerHTML;
      const user = loadUserTemplates();

      if(editingTemplateId){
        const idx = user.findIndex(t=>t.id===editingTemplateId);
        if(idx>=0) user[idx] = { ...user[idx], nome, html };
        else user.push({ id: editingTemplateId, nome, html });
        saveUserTemplates(user); alert('Template atualizado!');
      }else{
        user.push({ id: uid(), nome, html }); saveUserTemplates(user); alert('Template criado!');
      }
      refreshTemplateSelect(); openTplList();
    });

    /* ========= RESIZE DO WIZARD ========= */
    (function enableWizardResize(){
      const modal = wizardModal;
      const resE  = document.getElementById('wizardResizeE');
      const resSE = document.getElementById('wizardResizeSE');

      const limits = {
        minW: 680, minH: 480,
        maxW: Math.min(window.innerWidth*0.98, 1600),
        maxH: Math.min(window.innerHeight*0.95, 1200)
      };
      const clamp = (n,min,max) => Math.max(min, Math.min(max, n));

      let startX=0, startY=0, startW=0, startH=0, mode=null;

      function onMove(e){
        if(!mode) return;
        if(mode==='e' || mode==='se'){
          const nw = clamp(startW + (e.clientX - startX), limits.minW, limits.maxW);
          modal.style.width = nw + "px";
        }
        if(mode==='se'){
          const nh = clamp(startH + (e.clientY - startY), limits.minH, limits.maxH);
          modal.style.height = nh + "px";
          modal.style.maxHeight = "95vh";
        }
      }
      function stop(){ mode=null; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', stop); }
      function start(e, m){
        mode = m; startX = e.clientX; startY = e.clientY;
        const r = modal.getBoundingClientRect();
        startW = r.width; startH = r.height;
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', stop);
      }
      resE.addEventListener('mousedown', e=> start(e,'e'));
      resSE.addEventListener('mousedown', e=> start(e,'se'));
      window.addEventListener('resize', ()=>{
        limits.maxW = Math.min(window.innerWidth*0.98, 1600);
        limits.maxH = Math.min(window.innerHeight*0.95, 1200);
      });
    })();

    /* ========= LISTENERS LAYOUT ========= */
    [
      lyFontFamily, lyFontSize, lyLineHeight, lyPSpacing, lyH1, lyH2, lyH3,
      lyPageFormat, lyOrientation, lyMT, lyMR, lyMB, lyML,
      lyLogoEnabled, lyLogoSize, lyLogoAlign, lyLogoSpace, lyLogoResizeFirst
    ].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', ()=>{ readLayoutFromUI(); updatePreview(); });
      el.addEventListener('change', ()=>{ readLayoutFromUI(); updatePreview(); });
    });

    lyLogoFileBtn.addEventListener('click', ()=> lyLogoFile.click());
    lyLogoFile.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      lyLogoFileInfo.textContent = file ? file.name : 'Nenhum arquivo selecionado';
      if(!file) return;
      try{
        LAYOUT.logoData = await dataURLFromFile(file);
        updatePreview();
      }catch(err){ console.error(err); alert('Falha ao carregar a imagem do logo'); }
    });

    lySave.addEventListener('click', ()=> { readLayoutFromUI(); saveLayout(); });
    lyReset.addEventListener('click', ()=>{
      LAYOUT = { ...DEFAULT_LAYOUT };
      populateLayoutUI();
      updatePreview();
    });

    /* ========= INICIALIZA√á√ÉO ========= */
    refreshTemplateSelect();
    populateFuncionarios();
    editor.innerHTML = currentTemplate.html;

    populateLayoutUI();          // carrega UI com layout salvo/padr√£o
    updateVarsList(); updatePreview();

    // navega√ß√£o do wizard
    function isStep(n){ return (n===1 && step1.style.display!=='none') || (n===2 && step2.style.display!=='none'); }
    function goStep(n){
      if(n===1){
        step1.style.display=''; step2.style.display='none';
        btnNext.style.display=''; btnConcluir.style.display='none';
        wizardModal.style.height = ''; // volta auto quando retorna ao passo 1
      } else {
        step1.style.display='none'; step2.style.display='';
        btnNext.style.display='none'; btnConcluir.style.display='';
      }
    }

    (function ensureFitPontoTableToViewport(){
      if (typeof window !== 'undefined' && typeof window.fitPontoTableToViewport !== 'function') {
        window.fitPontoTableToViewport = function(){
          /* no-op: existe s√≥ para impedir erro ao voltar ao Cart√£o de Ponto */
        };
      }
    })();

/* ===== Wiring do m√≥dulo Documentos & Assinaturas ===== */
(function wireDocsButtons(){
  const root = document.getElementById('docs-sign-root');
  if(!root) return;

  const $  = (sel) => root.querySelector(sel);
  const $$ = (sel) => Array.from(root.querySelectorAll(sel));

  // Bot√µes principais
  const btnOpen = $('#btn-open');
  const btnTpl  = $('#btn-templates');

  // Modais
  const wizard   = $('#wizard');
  const tplModal = $('#tplModal');

  // Wizard: passos e controles
  const step1 = $('#step1');
  const step2 = $('#step2');
  const btnBack     = $('#btn-back');
  const btnClose    = $('#btn-close');
  const btnNext     = $('#btn-next');
  const btnConcluir = $('#btn-concluir');

  // Templates: views e controles
  const btnCloseTpl  = $('#btn-close-tpl');
  const btnNewTpl    = $('#btn-new-tpl');
  const btnBackList  = $('#btn-back-list');
  const btnSaveTpl   = $('#btn-save-tpl');
  const tplListView  = $('#tplListView');
  const tplEditView  = $('#tplEditView');
  const tplList      = $('#tplList');
  const tplName      = $('#tplName');
  const tplEditor    = $('#tplEditor');
  const docxTpl      = $('#docxTpl');
  const docxTplBtn   = $('#docxTplBtn');
  const docxTplInfo  = $('#docxTplInfo');
  const btnClearTpl  = $('#btn-clear-tpl');
  const tplVarsBox   = $('#tplVars');


  // Helpers locais
  const open  = (el)=>{ el?.classList.add('show'); el?.setAttribute('aria-hidden','false'); };
  const close = (el)=>{ el?.classList.remove('show'); el?.setAttribute('aria-hidden','true'); };

  // ===== Bot√µes principais =====
  btnOpen?.addEventListener('click', ()=> open(wizard));
  btnTpl ?.addEventListener('click', ()=> { renderTplList(); open(tplModal); });

  // Fecha modais por clique fora
  [wizard, tplModal].forEach(bd=>{
    bd?.addEventListener('click', (e)=>{ if(e.target===bd) close(bd); });
  });

  // ===== Fluxo do Wizard =====
  function goStep1(){
    if(step1) step1.style.display='grid';
    if(step2) step2.style.display='none';
    if(btnNext) btnNext.style.display='';
    if(btnConcluir) btnConcluir.style.display='none';
  }

  function goStep2(){
    if(step1) step1.style.display='none';
    if(step2) step2.style.display='block';
    if(btnNext) btnNext.style.display='none';
    if(btnConcluir) btnConcluir.style.display='';
  }
  goStep1();

  btnNext    ?.addEventListener('click', goStep2);
  btnBack    ?.addEventListener('click', goStep1);
  btnClose   ?.addEventListener('click', ()=> close(wizard));
  btnConcluir?.addEventListener('click', ()=>{
    close(wizard);
    try { (typeof notify==='function' ? notify('Documento gerado.', 'success') : window.alert('Documento gerado.')); } catch {}
  });

  // ===== Gerenciador de Templates =====
  let editingId = null; // null => criando; string => editando

  function getAllUserTemplates(){
    // Compat√≠vel com suas APIs: getTemplates/setTemplates (novo) ou loadUserTemplates/saveUserTemplates (antigo)
    if (typeof getTemplates === 'function') return getTemplates();
    if (typeof getAllTemplates === 'function') return getAllTemplates(); // inclui builtins
    return [];
  }

    function setAllUserTemplates(list){
    if (typeof setTemplates === 'function') setTemplates(list);
    else if (typeof saveUserTemplates === 'function') saveUserTemplates(list);
  }

  function escape(s){ try{ return (typeof escapeHTML==='function') ? escapeHTML(String(s)) : String(s); }catch{ return String(s); } }

  function renderTplList(){
    const list = getAllUserTemplates();
    if(!tplList) return;
    if(!Array.isArray(list) || list.length===0){
      tplList.innerHTML = '<div class="muted">Nenhum template salvo.</div>';
      return;
    }
    tplList.innerHTML = list.map(t => `
      <div class="panel" data-id="${t.id}" style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid rgba(0,0,0,.12);border-radius:10px;">
        <div><strong>${escape(t.name || t.nome || '(sem nome)')}</strong></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-light" data-action="edit">Editar</button>
          <button class="btn btn-light" data-action="dup">Duplicar</button>
          <button class="btn btn-ghost" data-action="del">Excluir</button>
        </div>
      </div>
    `).join('');
  }

  // Detec√ß√£o simples de vari√°veis {chave} no conte√∫do
  function detectVars(html){
    const text = (html || '').replace(/<[^>]+>/g,' ');
    const vars = Array.from(new Set((text.match(/\{[^}]+\}/g) || [])));
    return vars;
  }
  function renderTplVarsPreview(){
    if(!tplVarsBox) return;
    const vars = detectVars(tplEditor?.innerHTML || '');
    tplVarsBox.innerHTML = vars.length
      ? vars.map(v=>`<code style="margin-right:6px">${escape(v)}</code>`).join('')
      : '<small class="muted">Nenhuma vari√°vel detectada.</small>';
  }

 function showList(){
    editingId = null;
    if (tplEditView) tplEditView.style.display='none';
    if (tplListView) tplListView.style.display='block';
  }
  function showEdit(id=null){
    editingId = id;
    if (tplName)   tplName.value = '';
    if (tplEditor) tplEditor.innerHTML = '';
    if(id){
      const list = getAllUserTemplates();
      const it = list.find(x=>x.id===id);
      if(it){
        if (tplName)   tplName.value = it.name || it.nome || '';
        if (tplEditor) tplEditor.innerHTML = it.content || it.html || '';
      }
    }
    renderTplVarsPreview();
    if (tplListView) tplListView.style.display='none';
    if (tplEditView) tplEditView.style.display='block';
  }

  btnCloseTpl?.addEventListener('click', ()=> close(tplModal));
  btnNewTpl  ?.addEventListener('click', ()=> showEdit(null));
  btnBackList?.addEventListener('click', showList);

  // Upload .docx (apenas exibe nome; o parsing j√° existe no seu outro fluxo)
  docxTplBtn?.addEventListener('click', ()=> docxTpl?.click());
  docxTpl   ?.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(docxTplInfo) docxTplInfo.textContent = f ? f.name : 'Nenhum arquivo selecionado';
  });

  // Limpar formata√ß√£o b√°sica
  btnClearTpl?.addEventListener('click', ()=>{
    try { document.execCommand('removeFormat', false, null); } catch {}
    renderTplVarsPreview();
  });

  // Atualiza preview de vari√°veis enquanto digita
  tplEditor?.addEventListener('input', renderTplVarsPreview);

  // Salvar template
  btnSaveTpl?.addEventListener('click', ()=>{
    const name = (tplName?.value || '').trim();
    const content = String(tplEditor?.innerHTML || '').trim();
    if(!name || !content){
      try{ (typeof notify==='function' ? notify('Preencha nome e conte√∫do.', 'warn') : window.alert('Preencha nome e conte√∫do.')); }catch{}
      return;
    }
    const list = getAllUserTemplates().map(t => ({...t}));
    if(editingId){
      const idx = list.findIndex(t=>t.id===editingId);
      if(idx>=0){ list[idx].name = name; list[idx].content = content; list[idx].html = content; }
      else list.push({ id: editingId, name, content });
    }else{
      let id = (typeof slugify === 'function') ? slugify(name) : ('tpl_'+Date.now());
      let base = id, n=1;
      while(list.some(t=>t.id===id)){ id = base+'-'+(++n); }
      list.push({ id, name, content });
    }
    setAllUserTemplates(list);
    try{ (typeof notify==='function' ? notify('Template salvo!', 'success') : 0); }catch{}
    showList(); renderTplList();
  });

  // A√ß√µes na lista (editar/duplicar/excluir)
  tplList?.addEventListener('click', (e)=>{
    const row = e.target.closest('[data-id]');
    if(!row) return;
    const id = row.getAttribute('data-id');
    const act = e.target.closest('[data-action]')?.getAttribute('data-action');

    const list = getAllUserTemplates().map(t => ({...t}));
    const it = list.find(t=>t.id===id);
    if(!it) return;

    if(act==='edit'){ showEdit(id); return; }

// [FIX] Handler de cliques na lista de templates (completo)
tmplList.addEventListener('click', (ev) => {
  const li = ev.target.closest('li[data-id]');
  if (!li) return;

  const id = li.dataset.id;
  const act = ev.target.closest('[data-act]')?.dataset.act;
  if (!act) return;

  if (act === 'dup') {
        const src = templates.find(t => t.id === id);
        if (!src) return notify('Template n√£o encontrado.');
        const copy = { ...src, id: uid('tpl_'), title: `${src.title} (c√≥pia)` };
        templates.push(copy);
        persistTemplates?.(templates);
        renderTemplateList?.(templates);
        notify('Template duplicado.');
      } else if (act === 'del') {
        if (!confirm('Excluir este template?')) return;
        const idx = templates.findIndex(t => t.id === id);
        if (idx >= 0) {
          templates.splice(idx, 1);
          persistTemplates?.(templates);
          renderTemplateList?.(templates);
          notify('Template exclu√≠do.');
        }
      } else if (act === 'edit') {
        const item = templates.find(t => t.id === id);
        if (!item) return notify('Template n√£o encontrado.');
        openTemplateEditor?.(item);
      }
    }); // <- fecha corretamente o listener

    if(act==='del'){
      if(!confirm(`Excluir o template ‚Äú${it.name || it.nome || '(sem nome)'}‚Äù?`)) return;
      const novo = list.filter(t=>t.id!==id);
      setAllUserTemplates(novo);
      renderTplList();
      try{ (typeof notify==='function' ? notify('Template exclu√≠do.', 'success') : 0); }catch{}
      return;
    }
  });
})();
</script>


<!-- Pr√©-carregar logo para o PDF -->
<img id="pdfLogoPreload" src="Assets/img/logo_new.png" alt="" style="display:none"/>

</body>
</html>
