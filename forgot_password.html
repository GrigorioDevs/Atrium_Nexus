<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Esqueci Minha Senha - RCR Engenharia</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',sans-serif}
:root{
  --c1:#00E0FF; --c2:#FF2FB9;
  --bg:#0B1622; --panel:#0F1E2C;
  --text:#E7EEF6; --muted:#9fb1c3;
  --border:rgba(255,255,255,.12);
  --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
}
html,body{height:100%;background:var(--bg);display:flex;justify-content:center;align-items:center;color:var(--text)}

.login-container{
  background:var(--panel);
  padding:40px 30px;border-radius:20px;width:100%;max-width:400px;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  border:1px solid var(--border);
  text-align:center
}
.logo-image{
  width:150px;height:150px;border-radius:24px;object-fit:cover;margin:0 auto 10px;display:block;
  background: radial-gradient(80% 80% at 20% 20%, var(--c1), transparent),
              radial-gradient(80% 80% at 80% 80%, var(--c2), transparent);
  border:1px solid rgba(255,255,255,.22)
}
.logo-text{font-size:26px;font-weight:800;color:var(--text);letter-spacing:.2px;margin-bottom:5px;display:block}
.version{font-size:12px;color:var(--muted);margin-bottom:18px}
h2{font-size:22px;color:var(--text);margin-bottom:12px}

label{display:block;text-align:left;font-size:14px;margin:12px 0 6px;color:var(--text)}
input[type="email"]{
  width:100%;padding:12px;border-radius:10px;
  background:#0a1520;color:var(--text);
  border:1px solid rgba(0,224,255,.20);font-size:16px;outline:none;transition:.2s
}
input::placeholder{color:#7d93a7}
input[type="email"]:focus{border-color:rgba(0,224,255,.45)}

.helper{display:flex;align-items:center;gap:8px;font-size:13px;margin-top:6px;min-height:18px;color:var(--muted)}
.helper.ok{color:var(--ok)}
.helper.err{color:var(--err)}
.helper i{width:16px;text-align:center}

button{
  width:100%;padding:14px;border:none;border-radius:10px;
  background:linear-gradient(135deg,var(--c1),var(--c2));
  color:#00121E;font-size:16px;cursor:pointer;transition:.25s;margin:16px 0 10px;font-weight:800;
  border:1px solid rgba(255,255,255,.25)
}
button:hover{filter:brightness(1.08)}
button[disabled]{opacity:.7;cursor:not-allowed}

.btn-secondary{
  background:linear-gradient(135deg,var(--c1),var(--c2));
  display:flex;align-items:center;justify-content:center;gap:10px;
  color:#00121E;padding:12px 20px;border-radius:12px;font-size:16px;font-weight:800;
  box-shadow:0 10px 26px rgba(0,0,0,.24);
  border:1px solid rgba(255,255,255,.25)
}
.btn-secondary:hover{filter:brightness(1.08);transform:translateY(-2px)}

.msg{
  border:1px solid transparent;border-radius:12px;padding:12px 14px;text-align:left;font-size:14px;display:none;margin-bottom:8px
}
.msg.show{display:block}
.msg.success{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.10);color:#b7ffe6}
.msg.error{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.10);color:#ffd4d4}
.msg.info{border-color:rgba(0,224,255,.25);background:rgba(0,224,255,.08);color:#c6f7ff}

.state-success{display:none}
.state-success.active{display:block}
.state-form{display:none}
.state-form.active{display:block}

.small-note{font-size:12px;color:var(--muted);margin-top:6px}
.resend-wrap{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px}
.count{font-variant-numeric:tabular-nums;color:var(--muted)}
.spinner{display:inline-flex;align-items:center;gap:8px}
.spinner i{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0)} to{transform:rotate(360deg)}}

a{color:var(--c1);text-decoration:none}
a:hover{text-decoration:underline}

@media(max-width:480px){
  .login-container{padding:30px 20px;width:90%}
  h2{font-size:20px}
  input,button,.btn-secondary{font-size:14px}
}
</style>
</head>
<body>
  <div class="login-container" id="card">
    <!-- Troque a imagem abaixo se quiser usar o mesmo logo do app principal -->
    <img src="assets/img/logo.png" alt="Logo RCR" class="logo-image">
    <span class="logo-text">RCR Engenharia</span>
    <p class="version">RH • Redefinição de Senha</p>

    <h2>Esqueci Minha Senha</h2>

    <!-- Mensagens -->
    <div id="msg" class="msg" role="status" aria-live="polite"></div>

    <!-- ===== Estado: Formulário ===== -->
    <form id="resetForm" class="state-form active" novalidate>
      <label for="email">E-mail cadastrado</label>
      <input type="email" id="email" name="email" placeholder="seu@email.com"
             autocomplete="email" inputmode="email"
             pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" required>
      <div id="helper" class="helper" aria-live="polite"></div>

      <button id="submitBtn" type="submit">
        <span class="btn-text">Enviar link de redefinição</span>
        <span class="spinner" id="btnSpinner" style="display:none">
          <i class="fa-solid fa-spinner"></i> Enviando…
        </span>
      </button>

      <div class="btn-secondary" role="button" tabindex="0" onclick="voltarLogin()" onkeypress="if(event.key==='Enter'){voltarLogin()}">
        <i class="fas fa-arrow-left"></i>
        <span>Voltar ao Login</span>
      </div>

      <p class="small-note">Dúvidas? <a href="mailto:suporte@rcrengenharia.com.br">fale com o suporte</a>.</p>
    </form>

    <!-- ===== Estado: Sucesso ===== -->
    <div id="successState" class="state-success" aria-live="polite">
      <div class="msg success show" style="margin-top:6px">
        <strong>Prontinho!</strong> Se o e-mail estiver cadastrado, enviamos um link para redefinição de senha.
      </div>
      <p class="small-note">Confira também a caixa de spam/lixo eletrônico.</p>

      <div class="resend-wrap">
        <button id="resendBtn" type="button">Reenviar link</button>
        <span id="cooldown" class="count"></span>
      </div>

      <div class="btn-secondary" style="margin-top:10px" role="button" tabindex="0" onclick="voltarLogin()" onkeypress="if(event.key==='Enter'){voltarLogin()}">
        <i class="fas fa-arrow-left"></i>
        <span>Voltar ao Login</span>
      </div>
    </div>
  </div>

<script>
/* ========= Navegação ========= */
function voltarLogin(){
  // ajuste o caminho conforme seu login
  window.location.href = 'index.html';
}

/* ========= Utilidades ========= */
const $ = (s)=>document.querySelector(s);
const emailEl = $('#email');
const helper = $('#helper');
const msgEl = $('#msg');
const form = $('#resetForm');
const submitBtn = $('#submitBtn');
const btnSpinner = $('#btnSpinner');
const successState = $('#successState');
const formState = $('.state-form');

const RATE_LIMIT_MIN = 2;          // minutos
const COOLDOWN_SEC = 30;           // segundos para habilitar "Reenviar"
const LS_KEY_LAST_REQ = 'rcr_pwdreset_last_req';

function setMsg(kind, text){
  msgEl.className = 'msg show '+ (kind||'info');
  msgEl.textContent = text;
}
function clearMsg(){ msgEl.className = 'msg'; msgEl.textContent = ''; }

function setHelper(kind, text, icon){
  helper.className = 'helper ' + (kind||'');
  helper.innerHTML = text ? `<i class="fa-solid ${icon||'fa-circle-info'}"></i>${text}` : '';
}
function validateEmailValue(v){
  if(!v || !v.trim()) return {ok:false, reason:'empty'};
  const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return {ok: re.test(v.trim()), reason: re.test(v.trim()) ? null : 'invalid'};
}
function now(){ return Date.now(); }

/* ========= Estados de botão ========= */
function setLoading(loading){
  if(loading){
    submitBtn.setAttribute('disabled','disabled');
    btnSpinner.style.display = 'inline-flex';
    submitBtn.querySelector('.btn-text').style.display = 'none';
  }else{
    submitBtn.removeAttribute('disabled');
    btnSpinner.style.display = 'none';
    submitBtn.querySelector('.btn-text').style.display = '';
  }
}

/* ========= Cooldown para Reenviar ========= */
let cooldownTimer = null;
function startCooldown(){
  const span = $('#cooldown');
  const btn = $('#resendBtn');
  let left = COOLDOWN_SEC;
  btn.setAttribute('disabled','disabled');
  span.textContent = `Tente novamente em ${left}s`;
  clearInterval(cooldownTimer);
  cooldownTimer = setInterval(()=>{
    left--;
    if(left<=0){
      clearInterval(cooldownTimer);
      span.textContent = '';
      btn.removeAttribute('disabled');
    }else{
      span.textContent = `Tente novamente em ${left}s`;
    }
  },1000);
}

/* ========= Rate limit local por minutos ========= */
function rateLimited(){
  const last = Number(localStorage.getItem(LS_KEY_LAST_REQ)||0);
  if(!last) return false;
  const diffMin = (now()-last)/60000;
  return diffMin < RATE_LIMIT_MIN;
}

/* ========= Simulação de chamada de API ========= */
async function requestResetLink(email){
  // Troque pelo endpoint real:
  // const resp = await fetch('/api/auth/password-reset/request', {
  //   method: 'POST',
  //   headers: {'Content-Type':'application/json'},
  //   body: JSON.stringify({ email })
  // });
  // if(!resp.ok) throw new Error('Falha ao enviar o link.');
  // return await resp.json();

  await new Promise(r=>setTimeout(r, 1200));
  if(Math.random() < 0.08) throw new Error('Falha temporária, tente novamente.');
  return { ok:true };
}

/* ========= Validação em tempo real ========= */
emailEl.addEventListener('input', ()=>{
  clearMsg();
  const v = emailEl.value;
  const {ok, reason} = validateEmailValue(v);
  if(!v){
    setHelper('', '');
    submitBtn.setAttribute('disabled','disabled');
    return;
  }
  if(ok){
    setHelper('ok', 'E-mail válido.', 'fa-circle-check');
    submitBtn.removeAttribute('disabled');
  }else{
    setHelper('err', reason==='invalid' ? 'Formato de e-mail inválido.' : 'Informe seu e-mail.', 'fa-triangle-exclamation');
    submitBtn.setAttribute('disabled','disabled');
  }
});

/* ========= Envio do formulário ========= */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  clearMsg();

  const email = emailEl.value.trim();
  const {ok} = validateEmailValue(email);
  if(!ok){
    setHelper('err', 'Informe um e-mail válido.', 'fa-triangle-exclamation');
    emailEl.focus();
    return;
  }

  if(rateLimited()){
    setMsg('info', `Aguarde alguns minutos antes de tentar novamente.`);
    return;
  }

  try{
    setLoading(true);
    await requestResetLink(email);
    localStorage.setItem(LS_KEY_LAST_REQ, String(now()));
    formState.classList.remove('active');
    successState.classList.add('active');
    startCooldown();
  }catch(err){
    setMsg('error', err?.message || 'Não foi possível enviar o link. Tente novamente.');
  }finally{
    setLoading(false);
  }
});

/* ========= Reenviar ========= */
document.getElementById('resendBtn').addEventListener('click', async ()=>{
  clearMsg();
  if(rateLimited()){
    setMsg('info','Aguarde um pouco antes de reenviar.');
    return;
  }
  try{
    const btn = document.getElementById('resendBtn');
    btn.setAttribute('disabled','disabled');
    btn.innerHTML = `<span class="spinner"><i class="fa-solid fa-spinner"></i> Enviando…</span>`;
    const email = emailEl.value.trim();
    await requestResetLink(email);
    localStorage.setItem(LS_KEY_LAST_REQ, String(now()));
    setMsg('success','Reenviamos o link de redefinição (se o e-mail existir).');
    startCooldown();
  }catch(err){
    setMsg('error', err?.message || 'Falha ao reenviar. Tente mais tarde.');
  }finally{
    document.getElementById('resendBtn').innerHTML = 'Reenviar link';
  }
});

/* ========= Estado inicial ========= */
(function init(){
  submitBtn.setAttribute('disabled','disabled');
})();
</script>
</body>
</html>
